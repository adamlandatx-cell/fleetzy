<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleetzy Admin Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="fleetzy-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="fleetzy-favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="fleetzy-favicon.png">
    <link rel="shortcut icon" href="fleetzy-favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fleetzy-green': '#059669',
                        'fleetzy-blue': '#475569',
                        'fleetzy-gray': '#6B7280'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #059669;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #047857;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #059669;
        }
        
        /* Smooth transitions */
        /* Card and section styling - CSS fallback for Tailwind */
        .dashboard-card {
            background: white;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark .dashboard-card {
            background: #1f2937;
            border-color: #374151 !important;
        }
        
        /* Metric cards */
        .metric-card {
            background: white;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .metric-card {
            background: #1f2937;
            border-color: #374151 !important;
        }
        .metric-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        /* Section cards */
        .section-card {
            background: white;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .dark .section-card {
            background: #1f2937;
            border-color: #374151 !important;
        }
        
        .section-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb !important;
        }
        .dark .section-header {
            border-bottom-color: #374151 !important;
        }

        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: slideInRight 0.4s ease-out;
        }
        .toast.hiding {
            animation: slideInRight 0.4s ease-out reverse;
        }
        
        /* Hover Preview Card */
        .hover-preview {
            position: absolute;
            z-index: 1000;
            min-width: 280px;
            max-width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 16px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .dark .hover-preview {
            background: #1f2937;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .hover-preview.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Fleetzy Logo Styles */
        .fleetzy-logo {
            height: 40px;
            width: auto;
        }
        
        /* Document Upload Boxes */
        .doc-upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .doc-upload-box:hover {
            border-color: #059669;
            background: #ecfdf5;
        }
        .doc-upload-box.has-file {
            border-color: #059669;
            background: #ecfdf5;
            border-style: solid;
        }
        .dark .doc-upload-box {
            background: #374151;
            border-color: #4b5563;
        }
        .dark .doc-upload-box:hover {
            border-color: #059669;
            background: #064e3b;
        }
        .dark .doc-upload-box.has-file {
            border-color: #059669;
            background: #064e3b;
        }
        .doc-preview {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .doc-preview-large {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Top Navigation Bar -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <!-- Fleetzy Logo - PLACEHOLDER: Replace 'fleetzy-logo.png' with your actual logo file -->
                        <img src="fleetzy-logo.png" alt="Fleetzy" class="fleetzy-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <!-- Fallback if logo not found -->
                        <div class="flex items-center space-x-2" style="display: none;">
                            <div class="w-10 h-10 bg-fleetzy-green rounded-lg flex items-center justify-center shadow-lg">
                                <i class="fas fa-road text-white text-lg"></i>
                            </div>
                            <div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white">Fleetzy</span>
                                <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">Admin</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                        <i id="dark-mode-icon-moon" class="fas fa-moon text-xl"></i>
                        <i id="dark-mode-icon-sun" class="fas fa-sun text-xl hidden"></i>
                    </button>
                    
                    <!-- Notifications -->
                    <button class="relative p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notification-badge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    
                    <!-- Profile -->
                    <div class="flex items-center space-x-3 pl-4 border-l border-gray-200 dark:border-gray-700">
                        <img src="https://ui-avatars.com/api/?name=Adam&background=059669&color=fff" 
                             class="profile-pic" alt="Profile">
                        <div class="hidden md:block">
                            <div class="text-sm font-medium">Adam</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Owner</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout with Sidebar -->
    <div class="flex">

    <!-- Sidebar -->
    <aside class="sidebar hidden md:block">
        <nav class="py-4">
            <div class="px-4 mb-4">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Main Menu</p>
            </div>
            <div class="sidebar-item active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="sidebar-item" onclick="showSection('vehicles')">
                <i class="fas fa-car"></i>
                <span>Vehicles</span>
            </div>
            <div class="sidebar-item" onclick="showSection('customers')">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </div>
            <div class="sidebar-item" onclick="showSection('rentals')">
                <i class="fas fa-key"></i>
                <span>Rentals</span>
            </div>
            <div class="sidebar-item" onclick="showSection('payments')">
                <i class="fas fa-credit-card"></i>
                <span>Payments</span>
            </div>
            
            <div class="px-4 my-4">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Tools</p>
            </div>
            <div class="sidebar-item" onclick="showSection('marketplace')">
                <i class="fab fa-facebook text-blue-500"></i>
                <span>FB Marketplace</span>
            </div>
            <div class="sidebar-item" onclick="showSection('reports')">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </div>
            <div class="sidebar-item" onclick="showSection('settings')">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
        </nav>
    </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div id="section-dashboard" class="content-section active">

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Dashboard</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Welcome back! Here's what's happening with your fleet.</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500 dark:text-gray-400">Last updated</p>
                <p class="text-sm font-semibold" id="last-updated">Just now <i class="fas fa-sync-alt text-xs ml-1"></i></p>
            </div>
        </div>

        <!-- Key Metrics Cards - 4 IN A ROW -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-in">
            
            <!-- Total Vehicles -->
            <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border-2 border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Vehicles</p>
                        <p class="text-3xl font-bold mt-2" id="total-vehicles">0</p>
                        <p class="text-sm text-green-600 dark:text-green-400 mt-2">
                            <i class="fas fa-arrow-up mr-1"></i><span id="vehicles-growth">+0 this month</span>
                        </p>
                    </div>
                    <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-full">
                        <i class="fas fa-car text-fleetzy-green text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Active Rentals -->
            <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border-2 border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Active Rentals</p>
                        <p class="text-3xl font-bold mt-2" id="active-rentals">0</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            <span id="utilization-rate">0%</span> utilization
                        </p>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-full">
                        <i class="fas fa-key text-blue-600 dark:text-blue-400 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Monthly Revenue -->
            <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border-2 border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Monthly Revenue</p>
                        <p class="text-3xl font-bold mt-2" id="monthly-revenue">$0</p>
                        <p class="text-sm text-green-600 dark:text-green-400 mt-2">
                            <i class="fas fa-arrow-up mr-1"></i><span id="revenue-growth">+0% vs last month</span>
                        </p>
                    </div>
                    <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-full">
                        <i class="fas fa-dollar-sign text-green-600 dark:text-green-400 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Outstanding Payments -->
            <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border-2 border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Outstanding</p>
                        <p class="text-3xl font-bold mt-2" id="outstanding-amount">$0</p>
                        <p class="text-sm text-orange-600 dark:text-orange-400 mt-2">
                            <i class="fas fa-clock mr-1"></i><span id="overdue-count">0</span> overdue
                        </p>
                    </div>
                    <div class="bg-orange-100 dark:bg-orange-900/30 p-4 rounded-full">
                        <i class="fas fa-exclamation-triangle text-orange-600 dark:text-orange-400 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column - Main Content (2/3 width) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- PENDING APPLICATIONS -->
                <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700">
                    <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold">
                                <i class="fas fa-user-clock text-fleetzy-green mr-2"></i>
                                Pending Applications
                            </h2>
                            <span id="pending-apps-badge" class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1 rounded-full text-sm font-semibold">0 New</span>
                        </div>
                    </div>
                    <div id="pending-applications-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>No pending applications</p>
                        </div>
                    </div>
                </div>

                <!-- FLEET OVERVIEW -->
                <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700">
                    <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold flex items-center">
                                <i class="fas fa-car-side text-fleetzy-green text-2xl mr-3"></i>
                                Fleet Overview
                            </h2>
                            <button onclick="openModal('add-vehicle')" class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add Vehicle
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6" id="fleet-overview-grid">
                        <!-- Fleet cards will be populated here -->
                        <div class="col-span-2 py-8 text-center text-gray-500">
                            <i class="fas fa-car text-4xl mb-2"></i>
                            <p>No vehicles in fleet yet</p>
                        </div>
                    </div>
                </div>

                <!-- ACTIVE RENTALS TABLE -->
                <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700">
                    <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold">
                                <i class="fas fa-list text-fleetzy-green mr-2"></i>
                                Active Rentals
                            </h2>
                            <div class="flex items-center space-x-2">
                                <input type="text" placeholder="Search customer..." 
                                       class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700">
                                <button class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vehicle</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Next Payment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="active-rentals-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-2"></i>
                                        <p>No active rentals</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- REPORTS & ANALYTICS -->
                <div style="border: 2px solid #d1d5db !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700">
                    <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold">
                                <i class="fas fa-chart-bar text-fleetzy-green mr-2"></i>
                                Reports & Analytics
                            </h2>
                            <button onclick="showSection('reports')" class="text-sm text-fleetzy-green font-medium hover:text-green-700">
                                <i class="fas fa-external-link-alt mr-1"></i>Full Reports
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
                        
                        <!-- Financial Report Card -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                            <div class="flex items-center justify-between mb-3">
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg">
                                    <i class="fas fa-dollar-sign text-green-600 dark:text-green-400 text-xl"></i>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <h3 class="font-semibold text-sm mb-1">Financial Report</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Revenue, expenses, profit/loss</p>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">This Month:</span>
                                    <span class="font-semibold text-green-600 dark:text-green-400" id="report-revenue">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Expenses:</span>
                                    <span class="font-semibold text-red-600 dark:text-red-400" id="report-expenses">$0</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2">
                                    <span class="text-gray-500 dark:text-gray-400">Net Profit:</span>
                                    <span class="font-bold text-fleetzy-green" id="report-profit">$0</span>
                                </div>
                            </div>
                            <button onclick="showSection('reports')" class="w-full mt-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-xs font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-chart-line mr-1"></i>View Details
                            </button>
                        </div>

                        <!-- Fleet Performance Report Card -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                            <div class="flex items-center justify-between mb-3">
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg">
                                    <i class="fas fa-tachometer-alt text-blue-600 dark:text-blue-400 text-xl"></i>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <h3 class="font-semibold text-sm mb-1">Fleet Performance</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Utilization, profitability</p>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Utilization:</span>
                                    <span class="font-semibold" id="report-utilization">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Avg/Vehicle:</span>
                                    <span class="font-semibold" id="report-avg-per-vehicle">$0/mo</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2">
                                    <span class="text-gray-500 dark:text-gray-400">Top Earner:</span>
                                    <span class="font-bold text-blue-600 dark:text-blue-400" id="report-top-earner">-</span>
                                </div>
                            </div>
                            <button onclick="showSection('reports')" class="w-full mt-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-xs font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-chart-line mr-1"></i>View Details
                            </button>
                        </div>

                        <!-- Customer Insights Report Card -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer">
                            <div class="flex items-center justify-between mb-3">
                                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-lg">
                                    <i class="fas fa-users text-purple-600 dark:text-purple-400 text-xl"></i>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <h3 class="font-semibold text-sm mb-1">Customer Insights</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Retention, satisfaction scores</p>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Total Customers:</span>
                                    <span class="font-semibold" id="report-total-customers">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500 dark:text-gray-400">Active Now:</span>
                                    <span class="font-semibold" id="report-active-customers">0</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2">
                                    <span class="text-gray-500 dark:text-gray-400">Avg Score:</span>
                                    <span class="font-bold text-purple-600 dark:text-purple-400" id="report-avg-score">-</span>
                                </div>
                            </div>
                            <button onclick="showSection('customers')" class="w-full mt-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-xs font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-chart-line mr-1"></i>View Details
                            </button>
                        </div>

                    </div>

                    <!-- Time Range Selector -->
                    <div class="p-6 border-t border-gray-100 dark:border-gray-700">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="updateDashboardReports('this_month'); setActiveTimeButton(this)" class="time-range-btn bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                <i class="fas fa-calendar-alt mr-2"></i>This Month
                            </button>
                            <button onclick="updateDashboardReports('this_week'); setActiveTimeButton(this)" class="time-range-btn bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-calendar-week mr-2"></i>This Week
                            </button>
                            <button onclick="updateDashboardReports('today'); setActiveTimeButton(this)" class="time-range-btn bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-calendar-day mr-2"></i>Today
                            </button>
                            <button onclick="showSection('reports')" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-sliders-h mr-2"></i>Custom
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column - Sidebar (1/3 width) -->
            <div class="space-y-6">
                
                <!-- Quick Actions -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="font-semibold mb-4">
                        <i class="fas fa-bolt text-fleetzy-green mr-2"></i>Quick Actions
                    </h3>
                    <div class="space-y-3">
                        <button onclick="openModal('add-vehicle')" class="w-full bg-fleetzy-green text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors text-left">
                            <i class="fas fa-plus mr-2"></i>Add New Vehicle
                        </button>
                        <button onclick="openModal('add-customer')" class="w-full bg-fleetzy-blue text-white px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors text-left">
                            <i class="fas fa-user-plus mr-2"></i>Add Customer
                        </button>
                        <button onclick="openStartRentalModal()" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors text-left">
                            <i class="fas fa-key mr-2"></i>Start Rental
                        </button>
                        <button onclick="openModal('record-payment')" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-left">
                            <i class="fas fa-dollar-sign mr-2"></i>Record Payment
                        </button>
                        <button onclick="showSection('reports')" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-left">
                            <i class="fas fa-file-invoice mr-2"></i>View Reports
                        </button>
                        <button onclick="showToast('Inspections feature coming soon!', 'info')" class="w-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 px-4 py-3 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors text-left">
                            <i class="fas fa-clipboard-check mr-2"></i>Inspections
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="font-semibold mb-4">
                        <i class="fas fa-history text-fleetzy-green mr-2"></i>Recent Activity
                    </h3>
                    <div id="recent-activity" class="space-y-4">
                        <p class="text-sm text-gray-500 text-center py-4">No recent activity</p>
                    </div>
                </div>

                <!-- Upcoming Maintenance -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="font-semibold mb-4">
                        <i class="fas fa-calendar-check text-fleetzy-green mr-2"></i>Upcoming Maintenance
                    </h3>
                    <div id="upcoming-maintenance" class="space-y-3">
                        <p class="text-sm text-gray-500 text-center py-4">No maintenance scheduled</p>
                    </div>
                </div>

                <!-- Mechanic Portal -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl shadow-sm p-6 text-white">
                    <h3 class="font-semibold mb-2">
                        <i class="fas fa-tools mr-2"></i>Mechanic Portal
                    </h3>
                    <p class="text-sm text-purple-100 mb-4">Share this link with Triple 7 Roadside</p>
                    <div class="flex items-center space-x-2 bg-white/20 rounded-lg p-3 mb-3">
                        <input type="text" value="getfleetzy.com/mechanic" readonly 
                               class="flex-1 bg-transparent text-white text-sm outline-none">
                        <button onclick="copyMechanicLink()" class="bg-white text-purple-700 px-3 py-1 rounded text-sm font-medium hover:bg-purple-100 transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Hover Preview Container -->
    <div id="hover-preview" class="hover-preview"></div>

    
            </div>
            

<!-- Facebook Marketplace Section -->
<div id="section-marketplace" class="content-section">
    <div class="mb-8">
        <h1 class="text-3xl font-bold flex items-center">
            <i class="fab fa-facebook text-blue-500 mr-3"></i>
            Facebook Marketplace Assistant
        </h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Generate optimized listings for your vehicles</p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column - Vehicle Selection & Templates -->
        <div class="space-y-6">
            <!-- Vehicle Selection -->
            <div class="dashboard-card p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-car text-fleetzy-green mr-2"></i>
                    Select Vehicle
                </h3>
                <select id="mp-vehicle-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateMarketplacePreview()">
                    <option value="">-- Select a vehicle --</option>
                </select>
            </div>
            
            <!-- Template Selection -->
            <div class="dashboard-card p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-magic text-purple-500 mr-2"></i>
                    Choose Template Style
                </h3>
                <div class="grid grid-cols-1 gap-4">
                    <div class="template-card selected" data-template="professional" onclick="selectTemplate(this)">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">ðŸ’¼</span>
                            <span class="font-bold text-white">Professional</span>
                        </div>
                        <p class="text-sm text-gray-400">Clean, business-focused listing</p>
                    </div>
                    <div class="template-card" data-template="friendly" onclick="selectTemplate(this)">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">ðŸ˜Š</span>
                            <span class="font-bold text-white">Friendly</span>
                        </div>
                        <p class="text-sm text-gray-400">Casual, approachable tone</p>
                    </div>
                    <div class="template-card" data-template="detailed" onclick="selectTemplate(this)">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">ðŸ“‹</span>
                            <span class="font-bold text-white">Detailed</span>
                        </div>
                        <p class="text-sm text-gray-400">Comprehensive with all specs</p>
                    </div>
                </div>
            </div>
            
            <!-- Custom Options -->
            <div class="dashboard-card p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-sliders-h text-orange-500 mr-2"></i>
                    Customize
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Weekly Rate ($)</label>
                        <input type="number" id="mp-weekly-rate" value="400" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="updateMarketplacePreview()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Deposit ($)</label>
                        <input type="number" id="mp-deposit" value="500" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="updateMarketplacePreview()">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="mp-include-phone" checked class="mr-2" onchange="updateMarketplacePreview()">
                        <label for="mp-include-phone">Include phone number</label>
                    </div>
                </div>
            </div>
            
            <button onclick="generateMarketplaceListing()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg">
                <i class="fab fa-facebook mr-2"></i>
                Generate Listing
            </button>
        </div>
        
        <!-- Right Column - Preview -->
        <div class="space-y-6">
            <div class="dashboard-card p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-eye text-fleetzy-green mr-2"></i>
                    Preview
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-500 mb-2">Title</label>
                    <div id="mp-output-title" class="output-box text-lg font-semibold">Select a vehicle to preview</div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-500 mb-2">Description</label>
                    <div id="mp-output-description" class="output-box">Your listing will appear here...</div>
                </div>
                
                <div class="flex gap-3 mt-4">
                    <button onclick="copyMarketplace('title')" class="copy-btn flex-1">
                        <i class="fas fa-copy mr-2"></i>Copy Title
                    </button>
                    <button onclick="copyMarketplace('description')" class="copy-btn flex-1">
                        <i class="fas fa-copy mr-2"></i>Copy Description
                    </button>
                </div>
                <button onclick="copyMarketplace('all')" class="copy-btn w-full mt-3">
                    <i class="fas fa-clipboard-list mr-2"></i>Copy Everything
                </button>
            </div>
            
            <div class="dashboard-card p-6 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
                <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2">
                    <i class="fab fa-facebook-square mr-2"></i>
                    How to Post
                </h4>
                <ol class="text-sm text-blue-600 dark:text-blue-400 space-y-2">
                    <li>1. Open Facebook Marketplace</li>
                    <li>2. Click "Create new listing" â†’ "Vehicle for sale"</li>
                    <li>3. Copy & paste the title and description</li>
                    <li>4. Upload your vehicle photos</li>
                    <li>5. Set price as $400 (weekly rate)</li>
                    <li>6. Publish!</li>
                </ol>
            </div>
        </div>
    </div>
</div>

            
            <!-- Placeholder sections for other menu items -->
            <!-- VEHICLES TAB - Full Implementation -->
            <div id="section-vehicles" class="content-section">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-car-side text-fleetzy-green mr-3"></i>Fleet Vehicles
                            </h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Manage your rental fleet inventory</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <button onclick="exportVehicles()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button onclick="openModal('add-vehicle')" class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add Vehicle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vehicle Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Total Vehicles -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Vehicles</p>
                                    <p class="text-3xl font-bold mt-2" id="vehicles-total">0</p>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-full">
                                    <i class="fas fa-car text-blue-600 dark:text-blue-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Available</p>
                                    <p class="text-3xl font-bold mt-2 text-green-600" id="vehicles-available">0</p>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-full">
                                    <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rented -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Currently Rented</p>
                                    <p class="text-3xl font-bold mt-2 text-blue-600" id="vehicles-rented">0</p>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-full">
                                    <i class="fas fa-key text-blue-600 dark:text-blue-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Maintenance -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">In Maintenance</p>
                                    <p class="text-3xl font-bold mt-2 text-orange-600" id="vehicles-maintenance">0</p>
                                </div>
                                <div class="bg-orange-100 dark:bg-orange-900/30 p-4 rounded-full">
                                    <i class="fas fa-wrench text-orange-600 dark:text-orange-400 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vehicles Table Card -->
                    <div style="border: 2px solid #d1d5db !important;" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                        <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <h2 class="text-xl font-bold">
                                    <i class="fas fa-list text-fleetzy-green mr-2"></i>
                                    All Vehicles
                                </h2>
                                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                    <!-- Search -->
                                    <div class="relative">
                                        <input type="text" id="vehicles-search" placeholder="Search vehicles..." 
                                               onkeyup="filterVehiclesTable()"
                                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 w-full sm:w-64">
                                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                    <!-- Status Filter -->
                                    <select id="vehicles-status-filter" onchange="filterVehiclesTable()"
                                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700">
                                        <option value="">All Statuses</option>
                                        <option value="Active">Available/Active</option>
                                        <option value="Rented">Currently Rented</option>
                                        <option value="Maintenance">In Maintenance</option>
                                        <option value="Retired">Retired</option>
                                    </select>
                                    <!-- Refresh -->
                                    <button onclick="loadVehiclesTab()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vehicle</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">License Plate</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Mileage</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Weekly Rate</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Last Service</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicles-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                            <p>Loading vehicles...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Table Footer -->
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <p class="text-sm text-gray-500 dark:text-gray-400" id="vehicles-showing">
                                Showing <span id="vehicles-count">0</span> vehicles
                            </p>
                            <div class="flex items-center space-x-2">
                                <button onclick="refreshVehiclesTab()" class="text-sm text-fleetzy-green hover:text-green-700">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <!-- CUSTOMERS TAB - Full Implementation -->
            <div id="section-customers" class="content-section">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-users text-fleetzy-green mr-3"></i>Customer Management
                            </h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Manage applications, profiles, and rental history</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <button onclick="exportCustomers()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button onclick="openModal('add-customer')" class="bg-gradient-to-r from-fleetzy-green to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 shadow-md transition-all">
                                <i class="fas fa-user-plus mr-2"></i>Add Customer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                        <!-- Total Customers -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Customers</p>
                                    <p class="text-3xl font-bold mt-2" id="customers-total">0</p>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                    <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pending Approval -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Pending Approval</p>
                                    <p class="text-3xl font-bold mt-2 text-yellow-600" id="customers-pending">0</p>
                                </div>
                                <div class="bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-full">
                                    <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Approved -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Approved</p>
                                    <p class="text-3xl font-bold mt-2 text-green-600" id="customers-approved">0</p>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                                    <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Renters -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Active Renters</p>
                                    <p class="text-3xl font-bold mt-2 text-blue-600" id="customers-active">0</p>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                    <i class="fas fa-car text-blue-600 dark:text-blue-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rejected -->
                        <div style="border: 2px solid #d1d5db !important;" class="metric-card bg-white dark:bg-gray-800 rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Rejected</p>
                                    <p class="text-3xl font-bold mt-2 text-red-600" id="customers-rejected">0</p>
                                </div>
                                <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                                    <i class="fas fa-times-circle text-red-600 dark:text-red-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customers Table Card -->
                    <div style="border: 2px solid #d1d5db !important;" class="section-card bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                        <div class="section-header p-6 border-b-2 border-gray-200 dark:border-gray-700">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <h2 class="text-xl font-bold">
                                    <i class="fas fa-list text-fleetzy-green mr-2"></i>
                                    All Customers
                                </h2>
                                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                    <!-- Search -->
                                    <div class="relative">
                                        <input type="text" id="customers-search" placeholder="Search by name, phone, email..." 
                                               onkeyup="filterCustomersTable()"
                                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 w-full sm:w-72">
                                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                    <!-- Status Filter -->
                                    <select id="customers-status-filter" onchange="filterCustomersTable()"
                                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700">
                                        <option value="">All Statuses</option>
                                        <option value="pending">Pending Approval</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <!-- Type Filter -->
                                    <select id="customers-type-filter" onchange="filterCustomersTable()"
                                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700">
                                        <option value="">All Types</option>
                                        <option value="individual">Individual</option>
                                        <option value="corporate">Corporate</option>
                                    </select>
                                    <!-- Refresh -->
                                    <button onclick="loadCustomersTab()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full table-fixed">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="w-1/3 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                        <th class="w-24 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="w-24 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                        <th class="w-24 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Applied</th>
                                        <th class="w-32 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                            <p>Loading customers...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Table Footer -->
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <p class="text-sm text-gray-500 dark:text-gray-400" id="customers-showing">
                                Showing <span id="customers-count">0</span> customers
                            </p>
                            <div class="flex items-center space-x-2">
                                <button onclick="loadCustomersTab()" class="text-sm text-fleetzy-green hover:text-green-700">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- CUSTOMER DETAIL MODAL -->
            <div id="modal-customer-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="fas fa-user-circle text-fleetzy-green mr-2"></i>Customer Profile
                        </h2>
                        <button onclick="closeCustomerDetailModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="customer-detail-content" class="p-6">
                        <div class="flex items-center justify-center py-12">
                            <i class="fas fa-spinner fa-spin text-3xl text-fleetzy-green"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDIT CUSTOMER MODAL -->
            <div id="modal-edit-customer" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="fas fa-user-edit text-fleetzy-green mr-2"></i>Edit Customer
                        </h2>
                        <button onclick="closeEditCustomerModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="edit-customer-form" onsubmit="saveCustomerEdits(event)" class="p-6">
                        <input type="hidden" id="edit-customer-id">
                        
                        <!-- Personal Information -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                                <i class="fas fa-user text-fleetzy-green mr-2"></i>Personal Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Full Name *</label>
                                    <input type="text" id="edit-full-name" required
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Phone *</label>
                                    <input type="tel" id="edit-phone" required
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="edit-email"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Date of Birth</label>
                                    <input type="date" id="edit-dob"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium mb-2">Address</label>
                                    <input type="text" id="edit-address"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Driver's License -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                                <i class="fas fa-id-card text-fleetzy-green mr-2"></i>Driver's License
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">DL Number</label>
                                    <input type="text" id="edit-dl-number"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">State</label>
                                    <input type="text" id="edit-dl-state"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Expiry Date</label>
                                    <input type="date" id="edit-dl-expiry"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Emergency Contact -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                                <i class="fas fa-phone-alt text-fleetzy-green mr-2"></i>Emergency Contact
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Contact Name</label>
                                    <input type="text" id="edit-emergency-name"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Contact Phone</label>
                                    <input type="tel" id="edit-emergency-phone"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Relationship</label>
                                    <input type="text" id="edit-emergency-relationship"
                                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status & Notes -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                                <i class="fas fa-cog text-fleetzy-green mr-2"></i>Status & Notes
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Application Status</label>
                                    <select id="edit-status"
                                            class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                        <option value="pending">Pending</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Payment Method</label>
                                    <select id="edit-payment-method"
                                            class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                        <option value="">Select method</option>
                                        <option value="Zelle">Zelle</option>
                                        <option value="CashApp">CashApp</option>
                                        <option value="Venmo">Venmo</option>
                                        <option value="PayPal">PayPal</option>
                                        <option value="Stripe">Stripe (Card)</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium mb-2">Notes</label>
                                    <textarea id="edit-notes" rows="3"
                                              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="flex justify-end space-x-4 pt-4 border-t dark:border-gray-700">
                            <button type="button" onclick="closeEditCustomerModal()" 
                                    class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- START RENTAL FOR CUSTOMER MODAL -->
            <div id="modal-start-rental-customer" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="fas fa-car text-fleetzy-green mr-2"></i>Start New Rental
                        </h2>
                        <button onclick="closeStartRentalCustomerModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="start-rental-customer-form" onsubmit="submitStartRentalForCustomer(event)" class="p-6">
                        <input type="hidden" id="rental-customer-id">
                        
                        <!-- Customer Info (Read-only) -->
                        <div id="rental-customer-info-container" class="mb-6 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                            <h3 class="font-semibold mb-2">Customer</h3>
                            <p id="rental-customer-name" class="text-lg"></p>
                            <p id="rental-customer-phone" class="text-sm text-gray-500"></p>
                        </div>
                        
                        <!-- Vehicle Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Select Vehicle *</label>
                            <select id="rental-vehicle-select" required
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <option value="">-- Select available vehicle --</option>
                            </select>
                        </div>
                        
                        <!-- Rental Terms -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Date *</label>
                                <input type="date" id="rental-start-date" required
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Rental Duration *</label>
                                <div class="flex items-center gap-3">
                                    <select id="rental-duration-type" onchange="onDurationTypeChange()" 
                                            class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                        <option value="weeks">Fixed Weeks</option>
                                        <option value="ongoing">Ongoing (Week-to-Week)</option>
                                    </select>
                                    <input type="number" id="rental-weeks" value="2" min="1" 
                                           class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"
                                           placeholder="# Weeks">
                                </div>
                                <p id="duration-help-text" class="text-xs text-gray-500 mt-1">
                                    Minimum 1 week. End date will be calculated automatically.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Weekly Rate ($) *</label>
                                <input type="number" id="rental-weekly-rate" value="400" required
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Deposit ($) *</label>
                                <input type="number" id="rental-deposit" value="500" required
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Start Mileage</label>
                                <input type="number" id="rental-start-mileage"
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                            </div>
                        </div>
                        
                        <!-- Contract Upload -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">
                                <i class="fas fa-file-signature text-fleetzy-green mr-1"></i>Signed Contract (Optional)
                            </label>
                            <div class="doc-upload-box" onclick="document.getElementById('rental-contract-file').click()" id="rental-contract-upload-box">
                                <input type="file" id="rental-contract-file" accept=".pdf,image/*" class="hidden" onchange="handleRentalContractPreview(event)">
                                <div id="rental-contract-placeholder" class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload signed contract</p>
                                    <p class="text-xs text-gray-400 mt-1">PDF or image â€¢ Customer will see this in portal</p>
                                </div>
                                <div id="rental-contract-preview" class="hidden text-center">
                                    <i class="fas fa-file-pdf text-4xl text-red-500 mb-2"></i>
                                    <p id="rental-contract-filename" class="text-sm text-gray-600 dark:text-gray-400 truncate"></p>
                                    <button type="button" onclick="event.stopPropagation(); clearRentalContract();" class="mt-2 text-xs text-red-500 hover:underline">
                                        <i class="fas fa-times mr-1"></i>Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Summary -->
                        <div class="mb-6 bg-green-50 dark:bg-green-900/20 rounded-lg p-4 border border-green-200 dark:border-green-800">
                            <h3 class="font-semibold text-green-700 dark:text-green-300 mb-2">Rental Summary</h3>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Weekly Rate:</span>
                                <span id="summary-weekly" class="font-medium">$400</span>
                                <span class="text-gray-600 dark:text-gray-400">Deposit:</span>
                                <span id="summary-deposit" class="font-medium">$500.00</span>
                                <span class="text-gray-600 dark:text-gray-400">Rental Type:</span>
                                <span id="summary-rental-type" class="font-medium">Fixed Term</span>
                                <span class="text-gray-600 dark:text-gray-400">End Date:</span>
                                <span id="summary-end-date" class="font-medium">-</span>
                                <span class="text-gray-600 dark:text-gray-400">First Payment Due:</span>
                                <span id="summary-first-due" class="font-medium">-</span>
                                <span class="text-gray-600 dark:text-gray-400 font-semibold">Total Due Today:</span>
                                <span id="summary-total-due" class="font-bold text-green-600">$900</span>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="flex justify-end space-x-4 pt-4 border-t dark:border-gray-700">
                            <button type="button" onclick="closeStartRentalCustomerModal()" 
                                    class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-gradient-to-r from-fleetzy-green to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all shadow-md">
                                <i class="fas fa-car mr-2"></i>Start Rental
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="section-rentals" class="content-section">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold flex items-center">
                                <i class="fas fa-key text-fleetzy-green mr-3"></i>
                                Rentals
                            </h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Manage all rental agreements</p>
                        </div>
                        <div class="mt-4 sm:mt-0 flex gap-3">
                            <button onclick="loadRentalsTab()" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                            <button onclick="openStartRentalModal()" class="px-4 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Start New Rental
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
                                    <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="rentals-active">0</p>
                                    <p class="text-xs text-gray-500">Active</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                                    <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="rentals-pending">0</p>
                                    <p class="text-xs text-gray-500">Pending</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-orange-600 dark:text-orange-400"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="rentals-ending-soon">0</p>
                                    <p class="text-xs text-gray-500">Ending Soon</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                    <i class="fas fa-flag-checkered text-gray-600 dark:text-gray-400"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="rentals-completed">0</p>
                                    <p class="text-xs text-gray-500">Completed</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                                    <i class="fas fa-dollar-sign text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold" id="rentals-monthly-revenue">$0</p>
                                    <p class="text-xs text-gray-500">This Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700 p-4 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                            <div class="sm:col-span-2">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="rentals-search" placeholder="Search by customer, vehicle, or rental ID..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           onkeyup="filterRentalsTable()">
                                </div>
                            </div>
                            <div>
                                <select id="rentals-status-filter" onchange="filterRentalsTable()"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div>
                                <select id="rentals-vehicle-filter" onchange="filterRentalsTable()"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="">All Vehicles</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rentals Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border-2 border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <h3 class="font-semibold">
                                <i class="fas fa-list text-fleetzy-green mr-2"></i>
                                All Rentals
                                <span class="ml-2 px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm" id="rentals-count">0</span>
                            </h3>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <span>Sorted by:</span>
                                <select id="rentals-sort" onchange="sortRentalsTable()"
                                        class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="next-payment">Next Payment</option>
                                    <option value="customer">Customer A-Z</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Vehicle</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Dates</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Rate</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Next Payment</th>
                                        <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rentals-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                            <p>Loading rentals...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================ -->
            <!-- PAYMENTS TAB - Full Implementation -->
            <!-- ============================================ -->
            <div id="section-payments" class="content-section">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-dollar-sign text-fleetzy-green mr-2"></i>Payments
                            </h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Track and manage all payment transactions</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <button onclick="openModal('record-payment')" class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                                <i class="fas fa-plus mr-2"></i>Record Payment
                            </button>
                            <button onclick="exportPayments()" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- This Month Revenue -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">This Month</p>
                                    <p class="text-2xl font-bold text-fleetzy-green mt-1" id="payments-month-total">$0</p>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                                    <i class="fas fa-calendar-alt text-fleetzy-green text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Pending Approval -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Pending Approval</p>
                                    <p class="text-2xl font-bold text-orange-500 mt-1" id="payments-pending-count">0</p>
                                </div>
                                <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-full">
                                    <i class="fas fa-clock text-orange-500 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Overdue -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Overdue</p>
                                    <p class="text-2xl font-bold text-red-500 mt-1" id="payments-overdue-amount">$0</p>
                                </div>
                                <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Collection Rate -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Collection Rate</p>
                                    <p class="text-2xl font-bold text-blue-500 mt-1" id="payments-collection-rate">100%</p>
                                </div>
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                    <i class="fas fa-percentage text-blue-500 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm mb-6">
                        <div class="p-4 flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex-1">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="payments-search" placeholder="Search by customer name..." 
                                           onkeyup="filterPayments()"
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green">
                                </div>
                            </div>
                            <select id="payments-status-filter" onchange="filterPayments()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">All Status</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending Approval</option>
                                <option value="failed">Failed/Rejected</option>
                            </select>
                            <select id="payments-method-filter" onchange="filterPayments()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">All Methods</option>
                                <option value="zelle">Zelle</option>
                                <option value="cashapp">CashApp</option>
                                <option value="venmo">Venmo</option>
                                <option value="stripe">Stripe</option>
                                <option value="cash">Cash</option>
                                <option value="paypal">PayPal</option>
                            </select>
                            <select id="payments-type-filter" onchange="filterPayments()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">All Types</option>
                                <option value="weekly">Weekly Rent</option>
                                <option value="deposit">Deposit</option>
                                <option value="late_fee">Late Fee</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Payments Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Method</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                            <p>Loading payments...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- REPORTS TAB - Full Implementation -->
            <!-- ============================================ -->
            <div id="section-reports" class="content-section">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-chart-line text-fleetzy-green mr-2"></i>Reports & Analytics
                            </h1>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Financial insights and business metrics</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <select id="reports-period" onchange="loadReportsData()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="this_week">This Week</option>
                                <option value="this_month" selected>This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="this_year">This Year</option>
                                <option value="all_time">All Time</option>
                            </select>
                            <button onclick="exportReports()" class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                                <i class="fas fa-download mr-2"></i>Export Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Key Metrics - Row 1 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                                    <i class="fas fa-dollar-sign text-fleetzy-green text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Revenue</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-total-revenue">$0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                                    <i class="fas fa-receipt text-red-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Expenses</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-total-expenses">$0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-emerald-100 dark:bg-emerald-900/30 p-3 rounded-full">
                                    <i class="fas fa-chart-line text-emerald-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Net Profit</p>
                                    <p class="text-2xl font-bold" id="reports-net-profit">$0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                                    <i class="fas fa-file-contract text-blue-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Rentals</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-total-rentals">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Metrics - Row 2 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-full">
                                    <i class="fas fa-car text-purple-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Fleet Utilization</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-utilization">0%</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-indigo-100 dark:bg-indigo-900/30 p-3 rounded-full">
                                    <i class="fas fa-calculator text-indigo-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Avg/Vehicle</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-avg-per-vehicle">$0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-full">
                                    <i class="fas fa-trophy text-yellow-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Top Earner</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-top-earner">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-full">
                                    <i class="fas fa-wallet text-orange-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Deposits Held</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-deposits-held">$0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Stats Row -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-cyan-100 dark:bg-cyan-900/30 p-3 rounded-full">
                                    <i class="fas fa-users text-cyan-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Customers</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-total-customers">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-teal-100 dark:bg-teal-900/30 p-3 rounded-full">
                                    <i class="fas fa-user-check text-teal-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Active Renters</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-active-customers">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="flex items-center space-x-3">
                                <div class="bg-pink-100 dark:bg-pink-900/30 p-3 rounded-full">
                                    <i class="fas fa-star text-pink-500 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Avg Reliability Score</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="reports-avg-score">5.0/10</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenue Breakdown & Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Revenue Breakdown -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-coins text-fleetzy-green mr-2"></i>Revenue Breakdown
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-gray-600 dark:text-gray-400">Weekly Rentals</span>
                                        <span class="font-semibold text-gray-900 dark:text-white" id="reports-rental-revenue">$0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                        <div id="reports-rental-bar" class="bg-fleetzy-green h-3 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-gray-600 dark:text-gray-400">Deposits Collected</span>
                                        <span class="font-semibold text-gray-900 dark:text-white" id="reports-deposit-revenue">$0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                        <div id="reports-deposit-bar" class="bg-blue-500 h-3 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-gray-600 dark:text-gray-400">Late Fees</span>
                                        <span class="font-semibold text-gray-900 dark:text-white" id="reports-late-fees">$0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                        <div id="reports-late-bar" class="bg-red-500 h-3 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex justify-between">
                                        <span class="text-lg font-semibold text-gray-900 dark:text-white">Total Collected</span>
                                        <span class="text-xl font-bold text-fleetzy-green" id="reports-total-collected">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upcoming Payments -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-calendar-alt text-fleetzy-green mr-2"></i>Upcoming Payments (Next 7 Days)
                            </h3>
                            <div id="upcoming-payments-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment History & Customer Stats -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Recent Payments -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-history text-fleetzy-green mr-2"></i>Recent Payments
                            </h3>
                            <div id="recent-payments-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">Loading...</p>
                            </div>
                        </div>
                        
                        <!-- Customer Reliability -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-users text-fleetzy-green mr-2"></i>Customer Reliability
                            </h3>
                            <div id="customer-reliability-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- SETTINGS TAB -->
            <!-- ============================================ -->
            <div id="section-settings" class="content-section">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">
                        <i class="fas fa-cog text-fleetzy-green mr-2"></i>Settings
                    </h1>
                    
                    <div class="space-y-6">
                        <!-- Business Settings -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Business Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
                                    <input type="text" value="Fleetzy" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
                                    <input type="text" value="(281) 271-3900" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Default Rates -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Default Rates</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Weekly Rate</label>
                                    <input type="text" value="$400" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Security Deposit</label>
                                    <input type="text" value="$500" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Late Fee (Per Day)</label>
                                    <input type="text" value="$50" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Status -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">System Status</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 dark:text-gray-300">Supabase Connection</span>
                                    <span class="flex items-center text-green-500"><i class="fas fa-check-circle mr-2"></i>Connected</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
                                    <button onclick="toggleDarkMode()" class="px-4 py-1 bg-gray-200 dark:bg-gray-600 rounded-full text-sm">Toggle</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <script>
        // ===========================
        // CONFIGURATION
        // ===========================
        const SUPABASE_URL = 'https://xmixxqtcgaydasejshwn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaXh4cXRjZ2F5ZGFzZWpzaHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODE5NTQsImV4cCI6MjA3ODM1Nzk1NH0.gMKEejleqvf-0iZmskUq43NUYbTW5AYPtsUgXevP2_U';
        
        var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===========================
        // DARK MODE
        // ===========================
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            // Toggle icons
            const moonIcon = document.getElementById('dark-mode-icon-moon');
            const sunIcon = document.getElementById('dark-mode-icon-sun');
            if (moonIcon && sunIcon) {
                moonIcon.classList.toggle('hidden', isDark);
                sunIcon.classList.toggle('hidden', !isDark);
            }
        }

        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
            // Set correct icons on load
            document.addEventListener('DOMContentLoaded', () => {
                const moonIcon = document.getElementById('dark-mode-icon-moon');
                const sunIcon = document.getElementById('dark-mode-icon-sun');
                if (moonIcon && sunIcon) {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                }
            });
        }

        // ===========================
        // TOAST NOTIFICATIONS
        // ===========================
        function showToast(message, type = 'success') {
            const toastColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-orange-500',
                info: 'bg-blue-500'
            };
            
            const toastIcons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${toastColors[type]} text-white flex items-center space-x-3`;
            toast.innerHTML = `
                <i class="fas ${toastIcons[type]} text-xl"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        }

        // ===========================
        // HOVER PREVIEW CARDS
        // ===========================
        let hoverTimeout;
        const hoverPreview = document.getElementById('hover-preview');

        function showHoverPreview(element, data, type) {
            clearTimeout(hoverTimeout);
            
            hoverTimeout = setTimeout(() => {
                let content = '';
                
                if (type === 'customer') {
                    content = `
                        <div class="flex items-start space-x-3 mb-3">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(data.first_name + ' ' + data.last_name)}&background=059669&color=fff" 
                                 class="w-12 h-12 rounded-full">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900 dark:text-white">${data.first_name} ${data.last_name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${data.customer_id || 'No ID'}</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-phone text-fleetzy-green w-4"></i>
                                <span>${data.phone || 'No phone'}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-envelope text-fleetzy-green w-4"></i>
                                <span>${data.email || 'No email'}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-id-card text-fleetzy-green w-4"></i>
                                <span>${data.drivers_license || 'No license'}</span>
                            </div>
                        </div>
                    `;
                } else if (type === 'vehicle') {
                    content = `
                        <div class="mb-3">
                            <p class="font-semibold text-gray-900 dark:text-white text-lg">${data.year} ${data.make} ${data.model}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${data.vehicle_id}</p>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Status:</span>
                                <span class="status-badge ${data.status === 'Active' ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'}">${data.status}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Mileage:</span>
                                <span>${(data.current_mileage || 0).toLocaleString()} mi</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500 dark:text-gray-400">License:</span>
                                <span>${data.license_plate || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
                
                hoverPreview.innerHTML = content;
                
                const rect = element.getBoundingClientRect();
                hoverPreview.style.left = `${rect.right + 10}px`;
                hoverPreview.style.top = `${rect.top}px`;
                
                hoverPreview.classList.add('show');
            }, 500);
        }

        function hideHoverPreview() {
            clearTimeout(hoverTimeout);
            hoverPreview.classList.remove('show');
        }

        // ===========================
        // DATA LOADING
        // ===========================
        // Global data cache - shared between dashboard and tabs
        let dashboardCache = {
            vehicles: [],
            customers: [],
            rentals: [],
            payments: [],
            expenses: [],
            lastUpdated: null
        };

        async function loadDashboardData() {
            try {
                // Load all data including expenses
                const { data: vehicles } = await db.from('vehicles').select('*');
                const { data: customers } = await db.from('customers').select('*');
                const { data: rentals } = await db.from('rentals').select('*, customers(*), vehicles(*)');
                const { data: payments } = await db.from('payments').select('*, customers(*)');
                const { data: expenses } = await db.from('expenses').select('*');
                const { data: applications } = await db.from('customers').select('*').in('status', ['pending_verification', 'pending', 'Pending', 'new']);
                
                // Cache globally for other tabs to use
                dashboardCache.vehicles = vehicles || [];
                dashboardCache.customers = customers || [];
                dashboardCache.rentals = rentals || [];
                dashboardCache.payments = payments || [];
                dashboardCache.expenses = expenses || [];
                dashboardCache.lastUpdated = new Date();
                
                // Update metrics
                updateMetrics(vehicles || [], customers || [], rentals || [], payments || []);
                updatePendingApplications(applications || []);
                updateFleetOverview(vehicles || [], rentals || []);
                updateActiveRentalsTable(rentals || []);
                updateReports(vehicles || [], rentals || [], payments || [], expenses || []);
                
                document.getElementById('last-updated').innerHTML = 'Just now <i class="fas fa-sync-alt text-xs ml-1"></i>';
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data. Please refresh.', 'error');
            }
        }

        function updateMetrics(vehicles, customers, rentals, payments) {
            document.getElementById('total-vehicles').textContent = vehicles.length;
            
            const activeRentals = rentals.filter(r => r.rental_status === 'active').length;
            document.getElementById('active-rentals').textContent = activeRentals;
            
            const utilizationRate = vehicles.length > 0 ? Math.round((activeRentals / vehicles.length) * 100) : 0;
            document.getElementById('utilization-rate').textContent = `${utilizationRate}%`;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyPayments = payments.filter(p => {
                const paidDate = new Date(p.paid_date);
                return paidDate.getMonth() === currentMonth && paidDate.getFullYear() === currentYear;
            });
            const monthlyRevenue = monthlyPayments.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
            document.getElementById('monthly-revenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
            
            const outstanding = activeRentals * 400;
            document.getElementById('outstanding-amount').textContent = `$${outstanding.toLocaleString()}`;
        }

        function updatePendingApplications(applications) {
            // Match all pending statuses (pending_verification from app, Pending from manual entry)
            const pending = applications.filter(a => 
                a.status === 'pending_verification' || 
                a.status === 'pending' || 
                a.status === 'Pending'
            );
            document.getElementById('pending-apps-badge').textContent = `${pending.length} New`;
            
            const list = document.getElementById('pending-applications-list');
            if (pending.length === 0) {
                list.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>No pending applications</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = pending.map(app => `
                <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(app.full_name || 'New Applicant')}&background=059669&color=fff" 
                                 class="w-16 h-16 rounded-full border-2 border-fleetzy-green">
                            <div>
                                <h3 class="font-semibold text-lg">${app.full_name || 'New Applicant'}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${app.email || 'No email'} â€¢ ${app.phone || 'No phone'}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    <i class="fas fa-clock mr-1"></i>Applied ${new Date(app.created_at).toLocaleDateString()}
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="approveCustomer('${app.id}')" class="bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                            <button onclick="reviewCustomer('${app.id}')" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Review
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateActiveRentalsTable(rentals) {
            const active = rentals.filter(r => r.rental_status === 'active');
            const tbody = document.getElementById('active-rentals-body');
            
            if (active.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>No active rentals</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = active.map(rental => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(rental.customers?.first_name + ' ' + rental.customers?.last_name)}&background=059669&color=fff" 
                                 class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <div class="text-sm font-medium hover-trigger cursor-pointer" onmouseenter='showHoverPreview(this, ${JSON.stringify(rental.customers).replace(/'/g, "&#39;")}, "customer")' onmouseleave="hideHoverPreview()">
                                    ${rental.customers?.first_name} ${rental.customers?.last_name}
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${rental.customers?.email || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${rental.vehicles?.vehicle_id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">$${rental.weekly_rate}/wk</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${rental.next_payment_due ? new Date(rental.next_payment_due).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">Current</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex items-center space-x-2">
                            <button onclick="openModal('record-payment')" class="text-fleetzy-green hover:text-green-700" title="Record Payment">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button onclick="quickEndRental('${rental.id}')" class="text-red-600 hover:text-red-700" title="End Rental">
                                <i class="fas fa-flag-checkered"></i>
                            </button>
                            <button onclick="showToast('View details feature coming soon!', 'info')" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateFleetOverview(vehicles, rentals) {
            const grid = document.getElementById('fleet-overview-grid');
            if (vehicles.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-2 py-8 text-center text-gray-500">
                        <i class="fas fa-car text-4xl mb-2"></i>
                        <p>No vehicles in fleet yet</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = vehicles.map(vehicle => {
                // Determine vehicle status based on rentals
                const rental = rentals.find(r => r.vehicle_id === vehicle.id && r.rental_status === 'active');
                const status = rental ? 'rented' : (vehicle.status === 'Maintenance' ? 'maintenance' : 'available');
                
                // Status badge styling
                const statusBadges = {
                    rented: { bg: 'bg-green-500', text: 'text-white', icon: 'fa-check-circle', label: 'RENTED' },
                    available: { bg: 'bg-blue-500', text: 'text-white', icon: 'fa-check', label: 'AVAILABLE' },
                    maintenance: { bg: 'bg-orange-500', text: 'text-white', icon: 'fa-wrench', label: 'MAINTENANCE' }
                };
                const badge = statusBadges[status];
                
                // Use actual image if available, otherwise use placeholder
                const imageUrl = vehicle.image_url || 'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=400&h=250&fit=crop';
                
                // Action buttons based on status - Now with working modal functions!
                let actionButtons = '';
                if (status === 'rented') {
                    actionButtons = `
                        <button onclick="openVehicleStats('${vehicle.id}')" class="w-full bg-gray-600 dark:bg-gray-700 text-white px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-600 transition-colors text-sm">
                            <i class="fas fa-chart-line mr-2"></i>View Stats
                        </button>
                        <button onclick="openVehicleExpenses('${vehicle.id}')" class="w-full bg-orange-600 dark:bg-orange-700 text-white px-3 py-2 rounded-lg hover:bg-orange-700 dark:hover:bg-orange-600 transition-colors text-sm">
                            <i class="fas fa-file-invoice-dollar mr-2"></i>Expenses
                        </button>
                    `;
                } else if (status === 'available') {
                    actionButtons = `
                        <button onclick="openEditVehicle('${vehicle.id}')" class="w-full bg-fleetzy-green text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-edit mr-2"></i>Edit Vehicle
                        </button>
                        <button onclick="openServiceHistory('${vehicle.id}')" class="w-full bg-gray-600 dark:bg-gray-700 text-white px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-600 transition-colors text-sm">
                            <i class="fas fa-wrench mr-2"></i>Service History
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button onclick="markMaintenanceComplete('${vehicle.id}')" class="w-full bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm">
                            <i class="fas fa-check mr-2"></i>Mark Complete
                        </button>
                        <button onclick="openServiceHistory('${vehicle.id}')" class="w-full bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-history mr-2"></i>Service Log
                        </button>
                    `;
                }
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden hover:shadow-lg transition-shadow bg-white dark:bg-gray-800">
                        <!-- Vehicle Image -->
                        <div class="relative h-48">
                            <img src="${imageUrl}" 
                                 class="w-full h-full object-cover" 
                                 alt="${vehicle.year} ${vehicle.make} ${vehicle.model}"
                                 onerror="this.src='https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=400&h=250&fit=crop'">
                            <span class="absolute top-3 right-3 ${badge.bg} ${badge.text} px-3 py-1 rounded-full text-xs font-semibold shadow-lg flex items-center">
                                <i class="fas ${badge.icon} mr-1"></i>${badge.label}
                            </span>
                        </div>
                        
                        <!-- Vehicle Info -->
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1">${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">${vehicle.vehicle_id} â€¢ ${vehicle.color || 'N/A'}</p>
                            
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-3 gap-4 mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Mileage</p>
                                    <p class="font-semibold">${(vehicle.current_mileage || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${status === 'rented' ? 'Customer' : 'Status'}</p>
                                    <p class="font-semibold ${status === 'available' ? 'text-blue-600 dark:text-blue-400' : ''}">${
                                        status === 'rented' ? (rental?.customers?.first_name || 'N/A') :
                                        status === 'available' ? 'Ready' :
                                        'Service'
                                    }</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Rate</p>
                                    <p class="font-semibold">$${vehicle.weekly_rate || 400}/wk</p>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="grid grid-cols-2 gap-2">
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateReports(vehicles, rentals, payments, expenses) {
            // Default to this month
            updateDashboardReports('this_month', vehicles, rentals, payments, expenses);
        }
        
        function updateDashboardReports(period, vehicles, rentals, payments, expenses) {
            // Use cached data if not provided
            vehicles = vehicles || dashboardCache.vehicles || [];
            rentals = rentals || dashboardCache.rentals || [];
            payments = payments || dashboardCache.payments || [];
            expenses = expenses || dashboardCache.expenses || [];
            
            const now = new Date();
            let startDate, endDate = now;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'this_week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'this_month':
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
            }
            
            // Filter confirmed payments for the selected period
            const periodPayments = (payments || []).filter(p => {
                if (!p.paid_date || p.payment_status !== 'confirmed') return false;
                const paidDate = new Date(p.paid_date);
                return paidDate >= startDate && paidDate <= endDate;
            });
            
            // Filter expenses for the selected period (using expense_date field)
            const periodExpenses = (expenses || []).filter(e => {
                if (!e.expense_date) return false;
                const expenseDate = new Date(e.expense_date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            const revenue = periodPayments.reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
            const totalExpenses = periodExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const profit = revenue - totalExpenses;
            
            // Update Financial Report Card
            const revenueEl = document.getElementById('report-revenue');
            const expensesEl = document.getElementById('report-expenses');
            const profitEl = document.getElementById('report-profit');
            
            if (revenueEl) revenueEl.textContent = `$${revenue.toLocaleString()}`;
            if (expensesEl) expensesEl.textContent = `$${totalExpenses.toLocaleString()}`;
            if (profitEl) {
                profitEl.textContent = `$${Math.abs(profit).toLocaleString()}`;
                profitEl.className = profit >= 0 
                    ? 'font-bold text-fleetzy-green' 
                    : 'font-bold text-red-500';
                if (profit < 0) profitEl.textContent = '-$' + Math.abs(profit).toLocaleString();
            }
            
            // Update Fleet Performance Card
            const activeRentals = (rentals || []).filter(r => r.rental_status === 'active').length;
            const totalVehicles = (vehicles || []).length || 1;
            const utilization = Math.round((activeRentals / totalVehicles) * 100);
            const avgPerVehicle = totalVehicles > 0 ? Math.round(revenue / totalVehicles) : 0;
            
            // Find top earning vehicle
            const vehicleRevenue = {};
            periodPayments.forEach(p => {
                const rental = (rentals || []).find(r => r.id === p.rental_id);
                if (rental && rental.vehicle_id) {
                    vehicleRevenue[rental.vehicle_id] = (vehicleRevenue[rental.vehicle_id] || 0) + parseFloat(p.paid_amount || 0);
                }
            });
            const topEarnerEntry = Object.entries(vehicleRevenue).sort((a, b) => b[1] - a[1])[0];
            const topEarnerVehicle = topEarnerEntry ? (vehicles || []).find(v => v.id === topEarnerEntry[0]) : null;
            const topEarnerName = topEarnerVehicle ? (topEarnerVehicle.vehicle_id || topEarnerVehicle.license_plate || 'Vehicle') : '-';
            
            const utilizationEl = document.getElementById('report-utilization');
            const avgEl = document.getElementById('report-avg-per-vehicle');
            const topEl = document.getElementById('report-top-earner');
            
            if (utilizationEl) utilizationEl.textContent = `${utilization}%`;
            if (avgEl) avgEl.textContent = `$${avgPerVehicle.toLocaleString()}/mo`;
            if (topEl) topEl.textContent = topEarnerName;
            
            // Update Customer Insights Card
            const uniqueCustomers = new Set((rentals || []).map(r => r.customer_id)).size;
            const activeCustomers = activeRentals;
            
            // Calculate average reliability score from customers who have rentals
            const customersWithRentals = (rentals || [])
                .filter(r => r.customers)
                .map(r => r.customers);
            const avgScore = customersWithRentals.length > 0 
                ? (customersWithRentals.reduce((sum, c) => sum + (parseFloat(c.payment_reliability_score) || 5), 0) / customersWithRentals.length).toFixed(1)
                : '5.0';
            
            const totalEl = document.getElementById('report-total-customers');
            const activeEl = document.getElementById('report-active-customers');
            const scoreEl = document.getElementById('report-avg-score');
            
            if (totalEl) totalEl.textContent = uniqueCustomers;
            if (activeEl) activeEl.textContent = activeCustomers;
            if (scoreEl) scoreEl.textContent = `${avgScore}/10`;
            
            console.log('Dashboard Reports updated for period:', period, { revenue, totalExpenses, profit, utilization, uniqueCustomers });
        }
        
        function setActiveTimeButton(clickedBtn) {
            // Remove active state from all time buttons
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('bg-fleetzy-green', 'text-white');
                btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            // Add active state to clicked button
            clickedBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            clickedBtn.classList.add('bg-fleetzy-green', 'text-white');
        }

        function copyMechanicLink() {
            navigator.clipboard.writeText('getfleetzy.com/mechanic');
            showToast('Link copied to clipboard! âœ“', 'success');
        }

        // ===========================
        // INITIALIZATION
        // ===========================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboardData();
            setInterval(loadDashboardData, 30000);
            
            setTimeout(() => {
                showToast('Welcome to Fleetzy Admin Dashboard! ðŸš—', 'success');
            }, 500);
        });
    


// Section Navigation
function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active from all sidebar items
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById('section-' + sectionId);
    if (section) {
        section.classList.add('active');
    } else {
        // Default to dashboard if section not found
        document.getElementById('section-dashboard').classList.add('active');
        showToast('Coming soon!', 'info');
        sectionId = 'dashboard';
    }
    
    // Activate sidebar item
    document.querySelectorAll('.sidebar-item').forEach(item => {
        if (item.textContent.toLowerCase().includes(sectionId) || 
            (sectionId === 'marketplace' && item.textContent.includes('Marketplace'))) {
            item.classList.add('active');
        }
    });
    
    // Load data based on section
    if (sectionId === 'marketplace') {
        loadMarketplaceVehicles();
    } else if (sectionId === 'vehicles') {
        loadVehiclesTab();
    } else if (sectionId === 'customers') {
        loadCustomersTab();
    } else if (sectionId === 'rentals') {
        loadRentalsTab();
    } else if (sectionId === 'payments') {
        loadPaymentsTab();
    } else if (sectionId === 'reports') {
        loadReportsData();
    } else if (sectionId === 'dashboard') {
        loadDashboardData();
    }
}

// Marketplace Functions
var marketplaceVehicles = [];

async function loadMarketplaceVehicles() {
    try {
        const { data, error } = await db.from('vehicles').select('*');
        if (error) throw error;
        marketplaceVehicles = data || [];
        
        const select = document.getElementById('mp-vehicle-select');
        if (select) {
            select.innerHTML = '<option value="">-- Select a vehicle --</option>' +
                marketplaceVehicles.map(v => 
                    `<option value="${v.id}">${v.year} ${v.make} ${v.model} (${v.license_plate || 'No plate'})</option>`
                ).join('');
        }
    } catch (err) {
        console.error('Error loading vehicles for marketplace:', err);
    }
}

function selectTemplate(el) {
    document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
    el.classList.add('selected');
    updateMarketplacePreview();
}

function getSelectedTemplate() {
    const selected = document.querySelector('.template-card.selected');
    return selected ? selected.dataset.template : 'professional';
}

function updateMarketplacePreview() {
    const vehicleId = document.getElementById('mp-vehicle-select')?.value;
    if (!vehicleId) return;
    
    const vehicle = marketplaceVehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    const rate = document.getElementById('mp-weekly-rate')?.value || 400;
    const deposit = document.getElementById('mp-deposit')?.value || 500;
    const includePhone = document.getElementById('mp-include-phone')?.checked;
    const template = getSelectedTemplate();
    
    const listing = generateListingContent(vehicle, template, rate, deposit, includePhone);
    
    document.getElementById('mp-output-title').textContent = listing.title;
    document.getElementById('mp-output-description').textContent = listing.description;
}

function generateListingContent(vehicle, template, rate, deposit, includePhone) {
    const title = `${vehicle.year} ${vehicle.make} ${vehicle.model} - Weekly Rental $${rate}`;
    
    let description = '';
    
    if (template === 'professional') {
        description = `ðŸš— ${vehicle.year} ${vehicle.make} ${vehicle.model} FOR RENT

ðŸ“ Houston, TX Area
ðŸ’° $${rate}/week | $${deposit} refundable deposit

VEHICLE DETAILS:
â€¢ Year: ${vehicle.year}
â€¢ Make: ${vehicle.make}
â€¢ Model: ${vehicle.model}
â€¢ Color: ${vehicle.color || 'See photos'}
â€¢ Mileage: ${vehicle.current_mileage?.toLocaleString() || 'Low miles'}

PERFECT FOR:
âœ… Uber & Lyft drivers
âœ… DoorDash & delivery drivers
âœ… Anyone needing reliable transportation

REQUIREMENTS:
â€¢ Valid driver's license
â€¢ Clean driving record
â€¢ Background check
â€¢ Minimum 2-week rental

${includePhone ? 'ðŸ“ž Contact: (281) 271-3900' : 'ðŸ’¬ Message for details'}

Ready to rent? Contact us today!`;
    } else if (template === 'friendly') {
        description = `Hey there! ðŸ‘‹

Looking for a reliable ride for gig work? I've got you covered!

ðŸš™ ${vehicle.year} ${vehicle.make} ${vehicle.model}
ðŸ’µ Just $${rate}/week + $${deposit} deposit

This ${vehicle.color || 'beautiful'} ${vehicle.make} is perfect for:
- Rideshare (Uber/Lyft)
- Deliveries (DoorDash, UberEats)
- Getting around Houston

No long-term commitment needed - rent week by week!

${includePhone ? 'Give me a call at (281) 271-3900 or shoot me a message!' : 'Drop me a message and let\'s get you on the road! ðŸ›£ï¸'}`;
    } else {
        description = `ðŸ“‹ DETAILED VEHICLE LISTING

${vehicle.year} ${vehicle.make} ${vehicle.model}

SPECIFICATIONS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Year: ${vehicle.year}
â€¢ Make: ${vehicle.make}
â€¢ Model: ${vehicle.model}
â€¢ Color: ${vehicle.color || 'N/A'}
â€¢ VIN: ${vehicle.vin || 'Available upon request'}
â€¢ Current Mileage: ${vehicle.current_mileage?.toLocaleString() || 'N/A'} miles
â€¢ License Plate: ${vehicle.license_plate || 'N/A'}

RENTAL TERMS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Weekly Rate: $${rate}
â€¢ Security Deposit: $${deposit} (refundable)
â€¢ Minimum Rental: 2 weeks
â€¢ Payment: Due weekly in advance
â€¢ Insurance: Required

IDEAL FOR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Uber/Lyft rideshare drivers
â€¢ DoorDash/UberEats/Instacart drivers
â€¢ Business use
â€¢ Temporary transportation needs

REQUIREMENTS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Valid driver's license (21+)
â€¢ Clean driving record
â€¢ Pass background check
â€¢ Proof of insurance

LOCATION: Houston, TX

${includePhone ? 'CONTACT: (281) 271-3900' : 'Send a message for more information'}`;
    }
    
    return { title, description };
}

function generateMarketplaceListing() {
    updateMarketplacePreview();
    showToast('Listing generated! Copy and paste to Facebook Marketplace', 'success');
}

function copyMarketplace(type) {
    const title = document.getElementById('mp-output-title')?.textContent || '';
    const description = document.getElementById('mp-output-description')?.textContent || '';
    
    let text = '';
    if (type === 'title') text = title;
    else if (type === 'description') text = description;
    else text = title + '\n\n' + description;
    
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}

// ===========================
// VEHICLES TAB FUNCTIONS
// ===========================
let allVehiclesTabData = [];
let activeRentalsMap = {};

async function loadVehiclesTab() {
    const tbody = document.getElementById('vehicles-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                <p>Loading vehicles...</p>
            </td>
        </tr>
    `;
    
    try {
        let vehicles, rentals;
        
        // Check if we have fresh cached data (less than 30 seconds old)
        const cacheAge = dashboardCache.lastUpdated ? (new Date() - dashboardCache.lastUpdated) / 1000 : Infinity;
        
        if (cacheAge < 30 && dashboardCache.vehicles.length > 0) {
            // Use cached data from dashboard
            console.log('Using cached dashboard data for Vehicles tab');
            vehicles = dashboardCache.vehicles;
            rentals = dashboardCache.rentals;
        } else {
            // Fetch fresh data
            console.log('Fetching fresh data for Vehicles tab');
            const { data: vehiclesData, error: vehiclesError } = await db
                .from('vehicles')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (vehiclesError) throw vehiclesError;
            vehicles = vehiclesData || [];
            
            // Load active rentals to determine which vehicles are rented
            const { data: rentalsData, error: rentalsError } = await db
                .from('rentals')
                .select('vehicle_id, customers(first_name, last_name)')
                .eq('rental_status', 'active');
            
            if (rentalsError) throw rentalsError;
            rentals = rentalsData || [];
        }
        
        // Create a map of vehicle_id to rental info
        activeRentalsMap = {};
        (rentals || []).forEach(rental => {
            if (rental.vehicle_id) {
                activeRentalsMap[rental.vehicle_id] = rental;
            }
        });
        
        allVehiclesTabData = vehicles || [];
        
        // Update stats
        updateVehiclesStats(allVehiclesTabData);
        
        // Render table
        renderVehiclesTable(allVehiclesTabData);
        
    } catch (error) {
        console.error('Error loading vehicles:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                    <p>Error loading vehicles. Please try again.</p>
                    <button onclick="loadVehiclesTab()" class="mt-3 text-sm text-fleetzy-green hover:underline">
                        <i class="fas fa-sync-alt mr-1"></i>Retry
                    </button>
                </td>
            </tr>
        `;
    }
}

function updateVehiclesStats(vehicles) {
    const total = vehicles.length;
    const rented = Object.keys(activeRentalsMap).length;
    const maintenance = vehicles.filter(v => v.status === 'Maintenance').length;
    const available = total - rented - maintenance;
    
    document.getElementById('vehicles-total').textContent = total;
    document.getElementById('vehicles-available').textContent = available > 0 ? available : 0;
    document.getElementById('vehicles-rented').textContent = rented;
    document.getElementById('vehicles-maintenance').textContent = maintenance;
}

function renderVehiclesTable(vehicles) {
    const tbody = document.getElementById('vehicles-table-body');
    if (!tbody) return;
    
    if (vehicles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-car text-4xl mb-2"></i>
                    <p>No vehicles found</p>
                    <button onclick="openModal('add-vehicle')" class="mt-3 bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add First Vehicle
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = vehicles.map(vehicle => {
        // Determine actual status based on rentals
        const rental = activeRentalsMap[vehicle.id];
        const isRented = !!rental;
        const displayStatus = isRented ? 'Rented' : (vehicle.status || 'Active');
        
        // Status badge styling
        const statusBadges = {
            'Active': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400',
            'Rented': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400',
            'Maintenance': 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400',
            'Retired': 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-400'
        };
        const badgeClass = statusBadges[displayStatus] || statusBadges['Active'];
        
        // Customer name if rented
        const customerName = rental ? `${rental.customers?.first_name || ''} ${rental.customers?.last_name || ''}`.trim() : '';
        
        // Format mileage
        const mileage = vehicle.current_mileage ? vehicle.current_mileage.toLocaleString() : '0';
        
        // Format last service date
        const lastService = vehicle.last_service_date 
            ? new Date(vehicle.last_service_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            : 'Never';
        
        // Image URL or placeholder
        const imageUrl = vehicle.image_url || 'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=100&h=70&fit=crop';
        
        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <!-- Vehicle Info -->
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <img src="${imageUrl}" 
                             class="w-16 h-12 object-cover rounded-lg mr-4 border border-gray-200 dark:border-gray-600"
                             onerror="this.src='https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=100&h=70&fit=crop'"
                             alt="${vehicle.year} ${vehicle.make} ${vehicle.model}">
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-white">
                                ${vehicle.year} ${vehicle.make} ${vehicle.model}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                ${vehicle.vehicle_id || ''} ${vehicle.color ? 'â€¢ ' + vehicle.color : ''}
                            </div>
                        </div>
                    </div>
                </td>
                
                <!-- License Plate -->
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="font-mono text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                        ${vehicle.license_plate || 'N/A'}
                    </span>
                </td>
                
                <!-- Status -->
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${badgeClass}">
                        ${displayStatus}
                    </span>
                    ${customerName ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${customerName}</div>` : ''}
                    ${isRented && rental.end_date ? 
                        `<div class="text-xs text-blue-500 dark:text-blue-400 mt-1">
                            <i class="fas fa-calendar-check mr-1"></i>Available ${new Date(rental.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>` : 
                        (isRented && !rental.end_date ? 
                            `<div class="text-xs text-purple-500 dark:text-purple-400 mt-1">
                                <i class="fas fa-infinity mr-1"></i>Ongoing Rental
                            </div>` : ''
                        )
                    }
                </td>
                
                <!-- Mileage -->
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${mileage} mi
                </td>
                
                <!-- Weekly Rate -->
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-fleetzy-green">
                    $${vehicle.weekly_rate || 400}/wk
                </td>
                
                <!-- Last Service -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${lastService}
                </td>
                
                <!-- Actions -->
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <div class="flex items-center space-x-2">
                        <button onclick="viewVehicleDetails('${vehicle.id}')" 
                                class="text-gray-600 dark:text-gray-400 hover:text-fleetzy-green transition-colors p-2"
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="openEditVehicle('${vehicle.id}')" 
                                class="text-gray-600 dark:text-gray-400 hover:text-blue-600 transition-colors p-2"
                                title="Edit Vehicle">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleVehicleStatus('${vehicle.id}', '${vehicle.status}')" 
                                class="text-gray-600 dark:text-gray-400 hover:text-orange-600 transition-colors p-2"
                                title="Change Status">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button onclick="openServiceHistory('${vehicle.id}')" 
                                class="text-gray-600 dark:text-gray-400 hover:text-purple-600 transition-colors p-2"
                                title="Service History">
                            <i class="fas fa-wrench"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // Update count
    document.getElementById('vehicles-count').textContent = vehicles.length;
}

function filterVehiclesTable() {
    const searchTerm = (document.getElementById('vehicles-search')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('vehicles-status-filter')?.value || '';
    
    let filtered = allVehiclesTabData;
    
    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(v => {
            const searchString = `${v.year} ${v.make} ${v.model} ${v.vehicle_id} ${v.license_plate} ${v.color} ${v.vin}`.toLowerCase();
            return searchString.includes(searchTerm);
        });
    }
    
    // Apply status filter
    if (statusFilter) {
        if (statusFilter === 'Rented') {
            // Show only rented vehicles
            filtered = filtered.filter(v => activeRentalsMap[v.id]);
        } else if (statusFilter === 'Active') {
            // Show available vehicles (not rented, not maintenance)
            filtered = filtered.filter(v => !activeRentalsMap[v.id] && v.status !== 'Maintenance' && v.status !== 'Retired');
        } else {
            // Filter by specific status
            filtered = filtered.filter(v => v.status === statusFilter);
        }
    }
    
    renderVehiclesTable(filtered);
}

async function toggleVehicleStatus(vehicleId, currentStatus) {
    // Define status cycle
    const statusCycle = ['Active', 'Maintenance', 'Retired'];
    const currentIndex = statusCycle.indexOf(currentStatus);
    const nextStatus = statusCycle[(currentIndex + 1) % statusCycle.length];
    
    // Check if vehicle is rented
    if (activeRentalsMap[vehicleId]) {
        showToast('Cannot change status of a rented vehicle', 'warning');
        return;
    }
    
    if (!confirm(`Change vehicle status to "${nextStatus}"?`)) return;
    
    try {
        const { error } = await db
            .from('vehicles')
            .update({ 
                status: nextStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', vehicleId);
        
        if (error) throw error;
        
        showToast(`Vehicle status changed to ${nextStatus}! âœ“`, 'success');
        await loadVehiclesTab();
        
        // Also refresh dashboard if it's been loaded
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error updating vehicle status:', error);
        showToast('Error updating vehicle status', 'error');
    }
}

function viewVehicleDetails(vehicleId) {
    const vehicle = allVehiclesTabData.find(v => v.id === vehicleId);
    if (!vehicle) {
        showToast('Vehicle not found', 'error');
        return;
    }
    
    // For now, show a toast with basic info - can be expanded to a modal later
    const rental = activeRentalsMap[vehicleId];
    const status = rental ? 'Currently Rented' : vehicle.status;
    const customerInfo = rental ? ` to ${rental.customers?.first_name} ${rental.customers?.last_name}` : '';
    
    showToast(`${vehicle.year} ${vehicle.make} ${vehicle.model} - ${status}${customerInfo}`, 'info');
}

function refreshVehiclesTab() {
    loadVehiclesTab();
    showToast('Vehicles refreshed!', 'success');
}

function exportVehicles() {
    if (allVehiclesTabData.length === 0) {
        showToast('No vehicles to export', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Vehicle ID', 'Year', 'Make', 'Model', 'Color', 'License Plate', 'VIN', 'Status', 'Mileage', 'Weekly Rate', 'Last Service'];
    const rows = allVehiclesTabData.map(v => [
        v.vehicle_id || '',
        v.year || '',
        v.make || '',
        v.model || '',
        v.color || '',
        v.license_plate || '',
        v.vin || '',
        activeRentalsMap[v.id] ? 'Rented' : (v.status || 'Active'),
        v.current_mileage || 0,
        v.weekly_rate || 400,
        v.last_service_date || 'Never'
    ]);
    
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fleetzy-vehicles-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showToast('Vehicles exported to CSV!', 'success');
}

// ===========================
// CUSTOMERS TAB FUNCTIONS
// ===========================
let allCustomersTabData = [];
let customerRentalsMap = {};

async function loadCustomersTab() {
    const tbody = document.getElementById('customers-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                <p>Loading customers...</p>
            </td>
        </tr>
    `;
    
    try {
        // Fetch customers
        const { data: customers, error: customersError } = await db
            .from('customers')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (customersError) throw customersError;
        allCustomersTabData = customers || [];
        
        // Fetch active rentals to determine who is actively renting
        const { data: rentals, error: rentalsError } = await db
            .from('rentals')
            .select('customer_id, rental_status')
            .eq('rental_status', 'active');
        
        if (!rentalsError && rentals) {
            customerRentalsMap = {};
            rentals.forEach(r => {
                customerRentalsMap[r.customer_id] = true;
            });
        }
        
        // Count rentals per customer
        const { data: allRentals } = await db
            .from('rentals')
            .select('customer_id');
        
        const rentalCounts = {};
        if (allRentals) {
            allRentals.forEach(r => {
                rentalCounts[r.customer_id] = (rentalCounts[r.customer_id] || 0) + 1;
            });
        }
        
        // Add rental count to each customer
        allCustomersTabData = allCustomersTabData.map(c => ({
            ...c,
            rental_count: rentalCounts[c.id] || 0,
            is_active_renter: customerRentalsMap[c.id] || false
        }));
        
        updateCustomersStats();
        renderCustomersTable(allCustomersTabData);
        
    } catch (error) {
        console.error('Error loading customers:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                    <p>Error loading customers. Please try again.</p>
                </td>
            </tr>
        `;
    }
}

function updateCustomersStats() {
    const total = allCustomersTabData.length;
    const pending = allCustomersTabData.filter(c => c.status === 'pending' || (!c.status && !c.application_status)).length;
    const approved = allCustomersTabData.filter(c => c.status === 'approved' || c.application_status === 'approved').length;
    const rejected = allCustomersTabData.filter(c => c.status === 'rejected' || c.application_status === 'rejected').length;
    const active = allCustomersTabData.filter(c => c.is_active_renter).length;
    
    document.getElementById('customers-total').textContent = total;
    document.getElementById('customers-pending').textContent = pending;
    document.getElementById('customers-approved').textContent = approved;
    document.getElementById('customers-rejected').textContent = rejected;
    document.getElementById('customers-active').textContent = active;
}

function renderCustomersTable(customers) {
    const tbody = document.getElementById('customers-table-body');
    if (!tbody) return;
    
    if (customers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                    <i class="fas fa-users text-4xl mb-3 text-gray-300"></i>
                    <p class="text-lg">No customers found</p>
                    <p class="text-sm mt-1">Try adjusting your search or filters</p>
                </td>
            </tr>
        `;
        document.getElementById('customers-count').textContent = '0';
        return;
    }
    
    tbody.innerHTML = customers.map(customer => {
        const name = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const status = customer.status || customer.application_status || 'pending';
        const isCorporate = customer.is_company_rental || customer.is_corporate_rental;
        const normalizedStatus = (status || '').toLowerCase().trim();
        
        // Status badge - compact
        let statusBadge = '';
        switch (normalizedStatus) {
            case 'approved':
            case 'active':
                statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Approved</span>';
                break;
            case 'rejected':
                statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">Rejected</span>';
                break;
            case 'pending_verification':
                statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400">Verifying</span>';
                break;
            default:
                statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">Pending</span>';
        }
        
        // Active renter badge
        const activeBadge = customer.is_active_renter 
            ? '<span class="ml-1 px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">ðŸš—</span>'
            : '';
        
        // Type display - icon only to save space
        const typeIcon = isCorporate
            ? '<i class="fas fa-building text-purple-500" title="Corporate"></i>'
            : '<i class="fas fa-user text-gray-400" title="Individual"></i>';
        
        // Profile image - smaller
        const profileImg = customer.selfie_url
            ? `<img src="${customer.selfie_url}" class="w-8 h-8 rounded-full object-cover border border-gray-200 dark:border-gray-600" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=059669&color=fff&size=32'">`
            : `<div class="w-8 h-8 rounded-full bg-fleetzy-green flex items-center justify-center text-white text-sm font-semibold">${name.charAt(0).toUpperCase()}</div>`;
        
        // Action buttons - icons only
        let actionButtons = '';
        if (normalizedStatus === 'pending' || normalizedStatus === 'pending_verification' || normalizedStatus === '' || normalizedStatus === 'new' || normalizedStatus === 'submitted') {
            actionButtons = `
                <button onclick="reviewCustomer('${customer.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="Review">
                    <i class="fas fa-eye text-sm"></i>
                </button>
                <button onclick="approveCustomer('${customer.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Approve">
                    <i class="fas fa-check text-sm"></i>
                </button>
                <button onclick="rejectCustomer('${customer.id}')" class="p-1.5 text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded" title="Reject">
                    <i class="fas fa-times text-sm"></i>
                </button>
                <button onclick="deleteCustomer('${customer.id}', '${name.replace(/'/g, "\\'")}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Delete">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            `;
        } else if (normalizedStatus === 'approved' || normalizedStatus === 'active') {
            actionButtons = `
                <button onclick="viewCustomerDetail('${customer.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View">
                    <i class="fas fa-eye text-sm"></i>
                </button>
                <button onclick="openDocumentsModal('${customer.id}')" class="p-1.5 text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded" title="Manage Documents">
                    <i class="fas fa-folder-open text-sm"></i>
                </button>
                ${!customer.is_active_renter ? `
                <button onclick="startRentalForCustomer('${customer.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Start Rental">
                    <i class="fas fa-car text-sm"></i>
                </button>
                ` : `
                <button onclick="endCustomerRental('${customer.id}')" class="p-1.5 text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded" title="End Rental">
                    <i class="fas fa-flag-checkered text-sm"></i>
                </button>
                `}
                <button onclick="deleteCustomer('${customer.id}', '${name.replace(/'/g, "\\'")}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Delete">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            `;
        } else {
            actionButtons = `
                <button onclick="viewCustomerDetail('${customer.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View">
                    <i class="fas fa-eye text-sm"></i>
                </button>
                <button onclick="reinstateCustomer('${customer.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Re-approve">
                    <i class="fas fa-undo text-sm"></i>
                </button>
                <button onclick="deleteCustomer('${customer.id}', '${name.replace(/'/g, "\\'")}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Delete">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            `;
        }
        
        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        ${profileImg}
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-900 dark:text-white text-sm truncate">${name}</p>
                            <p class="text-xs text-gray-500 truncate">
                                <a href="tel:${customer.phone}" class="hover:text-fleetzy-green">${customer.phone || '-'}</a>
                            </p>
                            <p class="text-xs text-gray-400 truncate">${customer.email || '-'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-1">
                        ${statusBadge}
                        ${activeBadge}
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    ${typeIcon}
                </td>
                <td class="px-4 py-3">
                    <p class="text-xs text-gray-500">${formatDate(customer.created_at)}</p>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-0.5">
                        ${actionButtons}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('customers-count').textContent = customers.length;
}

function filterCustomersTable() {
    const search = document.getElementById('customers-search')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('customers-status-filter')?.value || '';
    const typeFilter = document.getElementById('customers-type-filter')?.value || '';
    
    let filtered = allCustomersTabData;
    
    // Search filter
    if (search) {
        filtered = filtered.filter(c => {
            const name = (c.full_name || `${c.first_name || ''} ${c.last_name || ''}`).toLowerCase();
            const phone = (c.phone || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const customerId = (c.customer_id || '').toLowerCase();
            return name.includes(search) || phone.includes(search) || email.includes(search) || customerId.includes(search);
        });
    }
    
    // Status filter
    if (statusFilter) {
        filtered = filtered.filter(c => {
            const status = (c.status || c.application_status || 'pending').toLowerCase();
            return status === statusFilter;
        });
    }
    
    // Type filter
    if (typeFilter) {
        filtered = filtered.filter(c => {
            const isCorporate = c.is_company_rental || c.is_corporate_rental;
            if (typeFilter === 'corporate') return isCorporate;
            if (typeFilter === 'individual') return !isCorporate;
            return true;
        });
    }
    
    renderCustomersTable(filtered);
}

// View customer full profile
async function viewCustomerDetail(customerId) {
    document.getElementById('modal-customer-detail').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    const content = document.getElementById('customer-detail-content');
    content.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-fleetzy-green"></i></div>';
    
    try {
        // Fetch customer data
        const { data: customer, error: customerError } = await db
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
        
        if (customerError) throw customerError;
        
        // Fetch customer's rentals
        const { data: rentals } = await db
            .from('rentals')
            .select('*, vehicles(year, make, model, license_plate)')
            .eq('customer_id', customerId)
            .order('created_at', { ascending: false });
        
        // Fetch customer's payments
        const { data: payments } = await db
            .from('payments')
            .select('*')
            .eq('customer_id', customerId)
            .order('paid_date', { ascending: false })
            .limit(10);
        
        const name = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const status = customer.status || customer.application_status || 'pending';
        
        // Build status badge
        let statusBadgeClass = 'bg-yellow-100 text-yellow-800';
        if (status === 'approved') statusBadgeClass = 'bg-green-100 text-green-800';
        if (status === 'rejected') statusBadgeClass = 'bg-red-100 text-red-800';
        
        // Calculate payment stats
        const totalPaid = payments ? payments.reduce((sum, p) => sum + (p.paid_amount || 0), 0) : 0;
        const latePayments = payments ? payments.filter(p => p.is_late).length : 0;
        
        content.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Profile & Photos -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div class="text-center">
                        ${customer.selfie_url 
                            ? `<img src="${customer.selfie_url}" class="w-32 h-32 rounded-full object-cover mx-auto border-4 border-fleetzy-green shadow-lg cursor-pointer" onclick="window.open(this.src, '_blank')">`
                            : `<div class="w-32 h-32 rounded-full bg-fleetzy-green flex items-center justify-center text-white text-4xl font-bold mx-auto">${name.charAt(0).toUpperCase()}</div>`
                        }
                        <h3 class="text-xl font-bold mt-4">${name}</h3>
                        <p class="text-gray-500">${customer.customer_id || 'No ID'}</p>
                        <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${statusBadgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    </div>
                    
                    <!-- Documents -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3"><i class="fas fa-folder-open text-fleetzy-green mr-2"></i>Documents</h4>
                        <div class="space-y-3">
                            ${customer.dl_photo_front_url ? `
                            <div>
                                <p class="text-xs text-gray-500 mb-1">DL Front</p>
                                <img src="${customer.dl_photo_front_url}" class="w-full rounded-lg border cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open(this.src, '_blank')">
                            </div>
                            ` : '<p class="text-sm text-gray-400">No DL front uploaded</p>'}
                            ${customer.dl_photo_back_url ? `
                            <div>
                                <p class="text-xs text-gray-500 mb-1">DL Back</p>
                                <img src="${customer.dl_photo_back_url}" class="w-full rounded-lg border cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open(this.src, '_blank')">
                            </div>
                            ` : ''}
                            ${customer.weekly_earnings_proof_url || customer.income_proof_url ? `
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Income Proof</p>
                                <img src="${customer.weekly_earnings_proof_url || customer.income_proof_url}" class="w-full rounded-lg border cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open(this.src, '_blank')">
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="space-y-2">
                        <button onclick="editCustomer('${customer.id}'); closeCustomerDetailModal();" class="w-full py-2 px-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <i class="fas fa-edit mr-2"></i>Edit Profile
                        </button>
                        ${status === 'approved' && !customerRentalsMap[customer.id] ? `
                        <button onclick="startRentalForCustomer('${customer.id}'); closeCustomerDetailModal();" class="w-full py-2 px-4 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-car mr-2"></i>Start Rental
                        </button>
                        ` : ''}
                        <button onclick="sendMessageToCustomer('${customer.id}')" class="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-comment-sms mr-2"></i>Send SMS
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Details, Rentals, Payments -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Contact Information -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3"><i class="fas fa-address-card text-fleetzy-green mr-2"></i>Contact Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Phone:</span>
                                <p class="font-medium"><a href="tel:${customer.phone}" class="hover:text-fleetzy-green">${customer.phone || '-'}</a></p>
                            </div>
                            <div>
                                <span class="text-gray-500">Email:</span>
                                <p class="font-medium">${customer.email || '-'}</p>
                            </div>
                            <div class="md:col-span-2">
                                <span class="text-gray-500">Address:</span>
                                <p class="font-medium">${customer.address || customer.current_address || '-'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Date of Birth:</span>
                                <p class="font-medium">${customer.date_of_birth || '-'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Platform:</span>
                                <p class="font-medium">${customer.gig_platform || '-'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Driver's License -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3"><i class="fas fa-id-card text-fleetzy-green mr-2"></i>Driver's License</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">DL Number:</span>
                                <p class="font-medium">${customer.dl_number || '-'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">State:</span>
                                <p class="font-medium">${customer.dl_state || '-'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Expiry:</span>
                                <p class="font-medium">${customer.dl_expiry_date || '-'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-green-600">$${totalPaid.toLocaleString()}</p>
                            <p class="text-sm text-gray-500">Total Paid</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600">${rentals?.length || 0}</p>
                            <p class="text-sm text-gray-500">Total Rentals</p>
                        </div>
                        <div class="bg-${latePayments > 0 ? 'red' : 'gray'}-50 dark:bg-${latePayments > 0 ? 'red' : 'gray'}-900/20 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-${latePayments > 0 ? 'red' : 'gray'}-600">${latePayments}</p>
                            <p class="text-sm text-gray-500">Late Payments</p>
                        </div>
                    </div>
                    
                    <!-- Rental History -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3"><i class="fas fa-car text-fleetzy-green mr-2"></i>Rental History</h4>
                        ${rentals && rentals.length > 0 ? `
                        <div class="space-y-3 max-h-48 overflow-y-auto">
                            ${rentals.map(r => {
                                const vehicle = r.vehicles;
                                const vehicleStr = vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Unknown Vehicle';
                                const statusColor = r.rental_status === 'active' ? 'green' : r.rental_status === 'completed' ? 'blue' : 'gray';
                                return `
                                <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg p-3">
                                    <div>
                                        <p class="font-medium">${vehicleStr}</p>
                                        <p class="text-sm text-gray-500">${formatDate(r.start_date)} - ${r.end_date ? formatDate(r.end_date) : 'Ongoing'}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full bg-${statusColor}-100 text-${statusColor}-800">${r.rental_status || 'Unknown'}</span>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        ` : '<p class="text-gray-500 text-sm">No rental history</p>'}
                    </div>
                    
                    <!-- Recent Payments -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3"><i class="fas fa-dollar-sign text-fleetzy-green mr-2"></i>Recent Payments</h4>
                        ${payments && payments.length > 0 ? `
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${payments.slice(0, 5).map(p => `
                                <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg p-3">
                                    <div>
                                        <p class="font-medium">$${(p.paid_amount || 0).toLocaleString()}</p>
                                        <p class="text-sm text-gray-500">${formatDate(p.paid_date)} via ${p.payment_method || 'Unknown'}</p>
                                    </div>
                                    ${p.is_late ? '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Late</span>' : '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">On Time</span>'}
                                </div>
                            `).join('')}
                        </div>
                        ` : '<p class="text-gray-500 text-sm">No payment history</p>'}
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading customer detail:', error);
        content.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                <p>Error loading customer profile</p>
            </div>
        `;
    }
}

function closeCustomerDetailModal() {
    document.getElementById('modal-customer-detail').classList.add('hidden');
    document.body.style.overflow = '';
}

// Edit customer
async function editCustomer(customerId) {
    document.getElementById('modal-edit-customer').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    try {
        const { data: customer, error } = await db
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
        
        if (error) throw error;
        
        // Populate form
        document.getElementById('edit-customer-id').value = customer.id;
        document.getElementById('edit-full-name').value = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim();
        document.getElementById('edit-phone').value = customer.phone || '';
        document.getElementById('edit-email').value = customer.email || '';
        document.getElementById('edit-dob').value = customer.date_of_birth || '';
        document.getElementById('edit-address').value = customer.address || customer.current_address || '';
        document.getElementById('edit-dl-number').value = customer.dl_number || '';
        document.getElementById('edit-dl-state').value = customer.dl_state || '';
        document.getElementById('edit-dl-expiry').value = customer.dl_expiry_date || '';
        document.getElementById('edit-emergency-name').value = customer.emergency_contact_name || '';
        document.getElementById('edit-emergency-phone').value = customer.emergency_contact_phone || '';
        document.getElementById('edit-emergency-relationship').value = customer.emergency_contact_relationship || '';
        document.getElementById('edit-status').value = customer.status || customer.application_status || 'pending';
        document.getElementById('edit-payment-method').value = customer.payment_method_primary || customer.preferred_payment_method || '';
        document.getElementById('edit-notes').value = customer.notes || '';
        
    } catch (error) {
        console.error('Error loading customer for edit:', error);
        showToast('Error loading customer data', 'error');
        closeEditCustomerModal();
    }
}

function closeEditCustomerModal() {
    document.getElementById('modal-edit-customer').classList.add('hidden');
    document.body.style.overflow = '';
}

async function saveCustomerEdits(event) {
    event.preventDefault();
    
    const customerId = document.getElementById('edit-customer-id').value;
    const fullName = document.getElementById('edit-full-name').value;
    const nameParts = fullName.trim().split(' ');
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';
    
    try {
        const { error } = await db
            .from('customers')
            .update({
                full_name: fullName,
                first_name: firstName,
                last_name: lastName,
                phone: document.getElementById('edit-phone').value,
                email: document.getElementById('edit-email').value,
                date_of_birth: document.getElementById('edit-dob').value || null,
                address: document.getElementById('edit-address').value,
                current_address: document.getElementById('edit-address').value,
                dl_number: document.getElementById('edit-dl-number').value,
                dl_state: document.getElementById('edit-dl-state').value,
                dl_expiry_date: document.getElementById('edit-dl-expiry').value || null,
                emergency_contact_name: document.getElementById('edit-emergency-name').value,
                emergency_contact_phone: document.getElementById('edit-emergency-phone').value,
                emergency_contact_relationship: document.getElementById('edit-emergency-relationship').value,
                status: document.getElementById('edit-status').value,
                application_status: document.getElementById('edit-status').value,
                payment_method_primary: document.getElementById('edit-payment-method').value,
                preferred_payment_method: document.getElementById('edit-payment-method').value,
                notes: document.getElementById('edit-notes').value,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
        
        if (error) throw error;
        
        showToast('Customer updated successfully! âœ“', 'success');
        closeEditCustomerModal();
        loadCustomersTab();
        
    } catch (error) {
        console.error('Error saving customer:', error);
        showToast('Error saving changes: ' + error.message, 'error');
    }
}

// Start rental for customer (when called from Customers tab with specific customer)
async function startRentalForCustomer(customerId) {
    document.getElementById('modal-start-rental-customer').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    try {
        // Get customer info
        const { data: customer } = await db
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
        
        if (customer) {
            const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
            
            // Update customer info section to show read-only selection - use stable container ID
            const customerInfoDiv = document.getElementById('rental-customer-info-container');
            if (customerInfoDiv) {
                customerInfoDiv.innerHTML = `
                    <h3 class="font-semibold mb-2">Customer</h3>
                    <p class="text-lg font-medium">${customerName}</p>
                    <p id="rental-customer-phone" class="text-sm text-gray-500">${customer.phone || ''}</p>
                `;
            }
            
            // Set the hidden customer ID field
            document.getElementById('rental-customer-id').value = customer.id;
        }
        
        // Get available vehicles (case-insensitive)
        const { data: allVehicles } = await db.from('vehicles').select('*');
        const availableVehicles = (allVehicles || []).filter(v => {
            const status = (v.status || '').toLowerCase();
            return status === 'active' || status === 'available';
        });
        
        const select = document.getElementById('rental-vehicle-select');
        select.innerHTML = '<option value="">-- Select available vehicle --</option>' +
            (availableVehicles.length === 0 ? 
                '<option disabled>No vehicles available</option>' :
                availableVehicles.map(v => 
                    `<option value="${v.id}" data-rate="${v.weekly_rate || 400}" data-mileage="${v.current_mileage || 0}">${v.year} ${v.make} ${v.model} (${v.license_plate || 'No plate'}) - $${v.weekly_rate || 400}/wk</option>`
                ).join('')
            );
        
        // Set default start date to today
        document.getElementById('rental-start-date').value = new Date().toISOString().split('T')[0];
        
        // Reset duration type
        const durationTypeSelect = document.getElementById('rental-duration-type');
        if (durationTypeSelect) {
            durationTypeSelect.value = 'weeks';
            document.getElementById('rental-weeks').style.display = 'block';
            document.getElementById('rental-weeks').value = '2';
        }
        
        // Update summary
        updateRentalSummary();
        
    } catch (error) {
        console.error('Error loading rental form:', error);
        showToast('Error loading rental form: ' + error.message, 'error');
    }
}

function closeStartRentalCustomerModal() {
    document.getElementById('modal-start-rental-customer').classList.add('hidden');
    document.body.style.overflow = '';
}

// Handle duration type change (Fixed vs Ongoing)
function onDurationTypeChange() {
    const durationType = document.getElementById('rental-duration-type').value;
    const weeksInput = document.getElementById('rental-weeks');
    const helpText = document.getElementById('duration-help-text');
    
    if (durationType === 'ongoing') {
        weeksInput.style.display = 'none';
        weeksInput.required = false;
        helpText.textContent = 'Week-to-week rental with no fixed end date. Customer pays weekly until rental ends.';
    } else {
        weeksInput.style.display = 'block';
        weeksInput.required = true;
        helpText.textContent = 'Minimum 1 week. End date will be calculated automatically.';
    }
    
    updateRentalSummary();
}

function updateRentalSummary() {
    const rate = parseFloat(document.getElementById('rental-weekly-rate').value) || 400;
    const deposit = parseFloat(document.getElementById('rental-deposit').value) || 500;
    const startDate = document.getElementById('rental-start-date').value;
    const durationType = document.getElementById('rental-duration-type')?.value || 'weeks';
    const weeks = parseInt(document.getElementById('rental-weeks').value) || 2;
    
    document.getElementById('summary-weekly').textContent = `$${rate.toLocaleString()}`;
    document.getElementById('summary-deposit').textContent = `$${deposit.toLocaleString()}.00`;
    document.getElementById('summary-total-due').textContent = `$${(rate + deposit).toLocaleString()}`;
    
    // Update rental type display
    const rentalTypeEl = document.getElementById('summary-rental-type');
    const endDateEl = document.getElementById('summary-end-date');
    
    if (durationType === 'ongoing') {
        if (rentalTypeEl) rentalTypeEl.textContent = 'Ongoing (Week-to-Week)';
        if (endDateEl) endDateEl.innerHTML = '<span class="text-blue-500">No End Date</span>';
    } else {
        if (rentalTypeEl) rentalTypeEl.textContent = `Fixed Term (${weeks} week${weeks > 1 ? 's' : ''})`;
        if (startDate && endDateEl) {
            const endDateCalc = new Date(startDate);
            endDateCalc.setDate(endDateCalc.getDate() + (weeks * 7));
            endDateEl.textContent = endDateCalc.toLocaleDateString();
        }
    }
    
    if (startDate) {
        const firstPaymentDate = new Date(startDate);
        firstPaymentDate.setDate(firstPaymentDate.getDate() + 7);
        document.getElementById('summary-first-due').textContent = firstPaymentDate.toLocaleDateString();
    }
}

// Add event listeners for rental form updates
document.addEventListener('DOMContentLoaded', () => {
    ['rental-weekly-rate', 'rental-deposit', 'rental-start-date', 'rental-weeks'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', updateRentalSummary);
            el.addEventListener('change', updateRentalSummary);
        }
    });
    
    // When vehicle selected, update rate and mileage
    const vehicleSelect = document.getElementById('rental-vehicle-select');
    if (vehicleSelect) {
        vehicleSelect.addEventListener('change', (e) => {
            const selected = e.target.options[e.target.selectedIndex];
            if (selected.dataset.rate) {
                document.getElementById('rental-weekly-rate').value = selected.dataset.rate;
            }
            if (selected.dataset.mileage) {
                document.getElementById('rental-start-mileage').value = selected.dataset.mileage;
            }
            updateRentalSummary();
        });
    }
});

async function submitStartRentalForCustomer(event) {
    event.preventDefault();
    
    const customerId = document.getElementById('rental-customer-id').value;
    const vehicleId = document.getElementById('rental-vehicle-select').value;
    const startDate = document.getElementById('rental-start-date').value;
    const durationType = document.getElementById('rental-duration-type')?.value || 'weeks';
    const weeks = durationType === 'ongoing' ? null : parseInt(document.getElementById('rental-weeks').value);
    const weeklyRate = parseFloat(document.getElementById('rental-weekly-rate').value);
    const deposit = parseFloat(document.getElementById('rental-deposit').value);
    const startMileage = parseInt(document.getElementById('rental-start-mileage').value) || null;
    
    if (!customerId) {
        showToast('Please select a customer', 'warning');
        return;
    }
    
    if (!vehicleId) {
        showToast('Please select a vehicle', 'warning');
        return;
    }
    
    try {
        // Generate rental ID
        const { data: lastRental } = await db
            .from('rentals')
            .select('rental_id')
            .order('created_at', { ascending: false })
            .limit(1);
        
        let nextNum = 1;
        if (lastRental && lastRental[0]?.rental_id) {
            const match = lastRental[0].rental_id.match(/R(\d+)/);
            if (match) nextNum = parseInt(match[1]) + 1;
        }
        const rentalId = `R${String(nextNum).padStart(3, '0')}`;
        
        // Calculate end date (null for ongoing rentals)
        let endDate = null;
        let isOngoing = durationType === 'ongoing';
        
        if (!isOngoing && weeks) {
            const endDateCalc = new Date(startDate);
            endDateCalc.setDate(endDateCalc.getDate() + (weeks * 7));
            endDate = endDateCalc.toISOString().split('T')[0];
        }
        
        // Calculate first payment due
        const nextPaymentDue = new Date(startDate);
        nextPaymentDue.setDate(nextPaymentDue.getDate() + 7);
        
        // Create rental record
        const rentalData = {
            rental_id: rentalId,
            customer_id: customerId,
            vehicle_id: vehicleId,
            start_date: startDate,
            end_date: endDate,  // null for ongoing
            weeks_contracted: weeks,  // null for ongoing
            weekly_rate: weeklyRate,
            deposit_amount: deposit,
            total_amount_due: isOngoing ? null : (weeklyRate * weeks),  // null for ongoing (calculated as they go)
            total_amount_paid: 0,
            balance_remaining: isOngoing ? null : (weeklyRate * weeks),
            rental_status: 'active',
            payment_frequency: 'Weekly',
            next_payment_due: nextPaymentDue.toISOString().split('T')[0],
            start_mileage: startMileage,
            is_ongoing: isOngoing  // Track if this is an ongoing rental
        };
        
        const { data: rental, error: rentalError } = await db
            .from('rentals')
            .insert(rentalData)
            .select()
            .single();
        
        if (rentalError) throw rentalError;
        
        // Update vehicle status with expected return date
        const vehicleUpdate = { 
            status: 'Rented',
            updated_at: new Date().toISOString()
        };
        
        // Add expected return date if not ongoing
        if (endDate) {
            vehicleUpdate.expected_return_date = endDate;
        }
        
        await db
            .from('vehicles')
            .update(vehicleUpdate)
            .eq('id', vehicleId);
        
        // Update customer deposit info
        await db
            .from('customers')
            .update({
                current_deposit_amount: deposit,
                deposit_status: 'Held',
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
        
        // Upload contract if provided
        const contractFile = document.getElementById('rental-contract-file')?.files[0];
        if (contractFile && rental?.id) {
            try {
                const contractUrl = await uploadContractForRental(rental.id, customerId, contractFile);
                if (contractUrl) {
                    showToast('Contract uploaded successfully!', 'success');
                }
            } catch (contractErr) {
                console.error('Contract upload failed:', contractErr);
                showToast('Rental created but contract upload failed. You can upload it later via Manage Documents.', 'warning');
            }
        }
        
        const rentalType = isOngoing ? 'ongoing week-to-week' : `${weeks}-week`;
        showToast(`Rental ${rentalId} created successfully! ðŸš— (${rentalType} rental)`, 'success');
        closeStartRentalCustomerModal();
        loadCustomersTab();
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
        // Refresh rentals tab
        if (typeof loadRentalsTab === 'function') {
            await loadRentalsTab();
        }
        
        // Refresh vehicles tab
        if (typeof loadVehiclesTab === 'function') {
            await loadVehiclesTab();
        }
        
    } catch (error) {
        console.error('Error creating rental:', error);
        showToast('Error creating rental: ' + error.message, 'error');
    }
}

// ===========================
// RENTALS TAB FUNCTIONS
// ===========================
let allRentalsTabData = [];
let rentalsVehiclesList = [];

async function loadRentalsTab() {
    const tbody = document.getElementById('rentals-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                <p>Loading rentals...</p>
            </td>
        </tr>
    `;
    
    try {
        // Check cache freshness
        const cacheAge = dashboardCache.lastUpdated ? (new Date() - dashboardCache.lastUpdated) / 1000 : Infinity;
        let rentals, vehicles, payments;
        
        if (cacheAge < 30 && dashboardCache.rentals.length > 0) {
            console.log('Using cached dashboard data for Rentals tab');
            rentals = dashboardCache.rentals;
            vehicles = dashboardCache.vehicles;
            payments = dashboardCache.payments;
        } else {
            console.log('Fetching fresh data for Rentals tab');
            const { data: rentalsData, error: rentalsError } = await db
                .from('rentals')
                .select('*, customers(*), vehicles(*)')
                .order('created_at', { ascending: false });
            
            if (rentalsError) throw rentalsError;
            rentals = rentalsData || [];
            
            const { data: vehiclesData } = await db.from('vehicles').select('*');
            vehicles = vehiclesData || [];
            
            const { data: paymentsData } = await db.from('payments').select('*');
            payments = paymentsData || [];
            
            // Update cache
            dashboardCache.rentals = rentals;
            dashboardCache.vehicles = vehicles;
            dashboardCache.payments = payments;
            dashboardCache.lastUpdated = new Date();
        }
        
        allRentalsTabData = rentals || [];
        rentalsVehiclesList = vehicles || [];
        
        // Populate vehicle filter dropdown
        populateRentalsVehicleFilter(vehicles);
        
        // Update stats
        updateRentalsStats(rentals, payments);
        
        // Render table
        renderRentalsTable(allRentalsTabData);
        
    } catch (error) {
        console.error('Error loading rentals:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                    <p>Error loading rentals. Please try again.</p>
                    <button onclick="loadRentalsTab()" class="mt-3 text-sm text-fleetzy-green hover:underline">
                        <i class="fas fa-sync-alt mr-1"></i>Retry
                    </button>
                </td>
            </tr>
        `;
    }
}

function populateRentalsVehicleFilter(vehicles) {
    const select = document.getElementById('rentals-vehicle-filter');
    if (!select) return;
    
    select.innerHTML = '<option value="">All Vehicles</option>' +
        (vehicles || []).map(v => 
            `<option value="${v.id}">${v.year} ${v.make} ${v.model} (${v.license_plate || 'N/A'})</option>`
        ).join('');
}

function updateRentalsStats(rentals, payments) {
    const active = rentals.filter(r => r.rental_status === 'active').length;
    const pending = rentals.filter(r => ['pending', 'pending_approval', 'pending_rental'].includes(r.rental_status)).length;
    const completed = rentals.filter(r => r.rental_status === 'completed').length;
    
    // Rentals ending in next 7 days
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    const endingSoon = rentals.filter(r => {
        if (r.rental_status !== 'active') return false;
        const endDate = new Date(r.end_date);
        return endDate >= today && endDate <= nextWeek;
    }).length;
    
    // Monthly revenue from payments
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const monthlyPayments = (payments || []).filter(p => {
        const paidDate = new Date(p.paid_date);
        return paidDate.getMonth() === currentMonth && paidDate.getFullYear() === currentYear;
    });
    const monthlyRevenue = monthlyPayments.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
    
    document.getElementById('rentals-active').textContent = active;
    document.getElementById('rentals-pending').textContent = pending;
    document.getElementById('rentals-ending-soon').textContent = endingSoon;
    document.getElementById('rentals-completed').textContent = completed;
    document.getElementById('rentals-monthly-revenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
}

function renderRentalsTable(rentals) {
    const tbody = document.getElementById('rentals-table-body');
    if (!tbody) return;
    
    if (rentals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-key text-4xl mb-2"></i>
                    <p>No rentals found</p>
                    <button onclick="openStartRentalModal()" class="mt-3 bg-fleetzy-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Start First Rental
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('rentals-count').textContent = '0';
        return;
    }
    
    tbody.innerHTML = rentals.map(rental => {
        const customer = rental.customers || {};
        const vehicle = rental.vehicles || {};
        const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const vehicleInfo = vehicle.id ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Not Assigned';
        const vehicleId = vehicle.vehicle_id || '';
        const licensePlate = vehicle.license_plate || 'N/A';
        
        // Status badge
        const statusBadges = {
            'active': { class: 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400', label: 'Active', icon: 'fa-check-circle' },
            'pending': { class: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400', label: 'Pending', icon: 'fa-clock' },
            'pending_approval': { class: 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400', label: 'Pending Approval', icon: 'fa-hourglass-half' },
            'pending_rental': { class: 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400', label: 'Ready for Pickup', icon: 'fa-car' },
            'completed': { class: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-400', label: 'Completed', icon: 'fa-flag-checkered' },
            'cancelled': { class: 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400', label: 'Cancelled', icon: 'fa-ban' }
        };
        const status = rental.rental_status || 'pending';
        const badge = statusBadges[status] || statusBadges['pending'];
        
        // Dates
        const startDate = rental.start_date ? new Date(rental.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
        const endDate = rental.end_date ? new Date(rental.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Ongoing';
        
        // Next payment
        let nextPaymentDisplay = 'N/A';
        let nextPaymentClass = 'text-gray-500';
        if (rental.next_payment_due && status === 'active') {
            const nextPaymentDate = new Date(rental.next_payment_due);
            const today = new Date();
            const daysUntil = Math.ceil((nextPaymentDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil < 0) {
                nextPaymentDisplay = `${Math.abs(daysUntil)}d overdue`;
                nextPaymentClass = 'text-red-600 dark:text-red-400 font-semibold';
            } else if (daysUntil <= 2) {
                nextPaymentDisplay = daysUntil === 0 ? 'Today' : `${daysUntil}d`;
                nextPaymentClass = 'text-orange-600 dark:text-orange-400 font-semibold';
            } else {
                nextPaymentDisplay = nextPaymentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // Actions based on status
        let actions = '';
        if (status === 'active') {
            actions = `
                <button onclick="openRecordPaymentForRental('${rental.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Record Payment">
                    <i class="fas fa-dollar-sign"></i>
                </button>
                <button onclick="viewRentalDetails('${rental.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="quickEndRental('${rental.id}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="End Rental">
                    <i class="fas fa-flag-checkered"></i>
                </button>
            `;
        } else if (status === 'pending' || status === 'pending_approval') {
            actions = `
                <button onclick="approveRental('${rental.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Approve">
                    <i class="fas fa-check"></i>
                </button>
                <button onclick="viewRentalDetails('${rental.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="cancelRental('${rental.id}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Cancel">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else if (status === 'pending_rental') {
            actions = `
                <button onclick="activateRental('${rental.id}')" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded" title="Start/Activate Rental">
                    <i class="fas fa-play"></i>
                </button>
                <button onclick="viewRentalDetails('${rental.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="cancelRental('${rental.id}')" class="p-1.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Cancel">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            actions = `
                <button onclick="viewRentalDetails('${rental.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        }
        
        // Customer profile image
        const profileImg = customer.selfie_url
            ? `<img src="${customer.selfie_url}" class="w-10 h-10 rounded-full object-cover border border-gray-200 dark:border-gray-600" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(customerName)}&background=059669&color=fff&size=40'">`
            : `<div class="w-10 h-10 rounded-full bg-fleetzy-green flex items-center justify-center text-white text-sm font-semibold">${customerName.charAt(0).toUpperCase()}</div>`;
        
        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        ${profileImg}
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${customerName}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${rental.rental_id || '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium">${vehicleInfo}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${vehicleId} â€¢ ${licensePlate}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badge.class}">
                        <i class="fas ${badge.icon} mr-1"></i>${badge.label}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm">${startDate}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">to ${endDate}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-semibold text-fleetzy-green">$${rental.weekly_rate || 400}/wk</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Deposit: $${rental.deposit_amount || 500}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${nextPaymentClass} text-sm">${nextPaymentDisplay}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex items-center justify-center gap-1">
                        ${actions}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('rentals-count').textContent = rentals.length;
}

function filterRentalsTable() {
    const search = document.getElementById('rentals-search')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('rentals-status-filter')?.value || '';
    const vehicleFilter = document.getElementById('rentals-vehicle-filter')?.value || '';
    
    let filtered = allRentalsTabData;
    
    // Search filter
    if (search) {
        filtered = filtered.filter(r => {
            const customer = r.customers || {};
            const vehicle = r.vehicles || {};
            const customerName = (customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`).toLowerCase();
            const vehicleInfo = `${vehicle.year || ''} ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.license_plate || ''}`.toLowerCase();
            const rentalId = (r.rental_id || '').toLowerCase();
            return customerName.includes(search) || vehicleInfo.includes(search) || rentalId.includes(search);
        });
    }
    
    // Status filter
    if (statusFilter) {
        filtered = filtered.filter(r => r.rental_status === statusFilter);
    }
    
    // Vehicle filter
    if (vehicleFilter) {
        filtered = filtered.filter(r => r.vehicle_id === vehicleFilter);
    }
    
    renderRentalsTable(filtered);
}

function sortRentalsTable() {
    const sortBy = document.getElementById('rentals-sort')?.value || 'newest';
    
    let sorted = [...allRentalsTabData];
    
    switch (sortBy) {
        case 'oldest':
            sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            break;
        case 'next-payment':
            sorted.sort((a, b) => {
                if (!a.next_payment_due) return 1;
                if (!b.next_payment_due) return -1;
                return new Date(a.next_payment_due) - new Date(b.next_payment_due);
            });
            break;
        case 'customer':
            sorted.sort((a, b) => {
                const nameA = a.customers?.full_name || a.customers?.first_name || '';
                const nameB = b.customers?.full_name || b.customers?.first_name || '';
                return nameA.localeCompare(nameB);
            });
            break;
        default: // newest
            sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }
    
    renderRentalsTable(sorted);
}

// Open Start Rental Modal (generic - for Quick Actions)
async function openStartRentalModal() {
    // Create a generic start rental modal that allows customer selection
    document.getElementById('modal-start-rental-customer').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    try {
        // Clear previous customer selection
        document.getElementById('rental-customer-id').value = '';
        
        // Fetch ALL customers first, then filter for approved
        const { data: allCustomers, error: customersError } = await db
            .from('customers')
            .select('*');
        
        if (customersError) {
            console.error('Error fetching customers:', customersError);
            throw customersError;
        }
        
        console.log('All customers fetched:', allCustomers?.length || 0);
        
        // Filter for approved customers (case-insensitive)
        const approvedCustomers = (allCustomers || []).filter(c => {
            const status = (c.status || c.application_status || '').toLowerCase();
            return status === 'approved';
        });
        
        console.log('Approved customers:', approvedCustomers.length);
        
        // Check for active rentals to exclude customers already renting
        const { data: activeRentals } = await db
            .from('rentals')
            .select('customer_id')
            .eq('rental_status', 'active');
        
        const activeCustomerIds = new Set((activeRentals || []).map(r => r.customer_id));
        const availableCustomers = approvedCustomers.filter(c => !activeCustomerIds.has(c.id));
        
        console.log('Available customers (not currently renting):', availableCustomers.length);
        
        // Replace customer info with select dropdown - use stable container ID
        const customerInfoDiv = document.getElementById('rental-customer-info-container');
        if (!customerInfoDiv) {
            console.error('Customer info container not found!');
            throw new Error('Modal structure error: rental-customer-info-container not found');
        }
        
        customerInfoDiv.innerHTML = `
            <h3 class="font-semibold mb-2">Select Customer</h3>
            <select id="rental-customer-select" onchange="onRentalCustomerSelect(this.value)"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                <option value="">-- Select approved customer --</option>
                ${availableCustomers.length === 0 ? 
                    '<option disabled>No approved customers available</option>' :
                    availableCustomers.map(c => {
                        const name = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || 'Unknown';
                        return `<option value="${c.id}" data-name="${name}" data-phone="${c.phone || ''}">${name} - ${c.phone || 'No phone'}</option>`;
                    }).join('')
                }
            </select>
            <p id="rental-customer-phone" class="text-sm text-gray-500 mt-2"></p>
            ${availableCustomers.length === 0 ? 
                '<p class="text-sm text-orange-500 mt-2"><i class="fas fa-info-circle mr-1"></i>No approved customers without active rentals. Approve a customer first or check existing rentals.</p>' : 
                ''
            }
        `;
        
        // Get available vehicles
        const { data: vehicles, error: vehiclesError } = await db
            .from('vehicles')
            .select('*');
        
        if (vehiclesError) {
            console.error('Error fetching vehicles:', vehiclesError);
        }
        
        // Filter for available vehicles (case-insensitive)
        const availableVehicles = (vehicles || []).filter(v => {
            const status = (v.status || '').toLowerCase();
            return status === 'active' || status === 'available';
        });
        
        console.log('Available vehicles:', availableVehicles.length);
        
        const select = document.getElementById('rental-vehicle-select');
        if (select) {
            select.innerHTML = '<option value="">-- Select available vehicle --</option>' +
                (availableVehicles.length === 0 ? 
                    '<option disabled>No vehicles available</option>' :
                    availableVehicles.map(v => 
                        `<option value="${v.id}" data-rate="${v.weekly_rate || 400}" data-mileage="${v.current_mileage || 0}">${v.year} ${v.make} ${v.model} (${v.license_plate || 'No plate'}) - $${v.weekly_rate || 400}/wk</option>`
                    ).join('')
                );
        }
        
        // Set default start date to today
        document.getElementById('rental-start-date').value = new Date().toISOString().split('T')[0];
        
        // Reset duration type
        const durationTypeSelect = document.getElementById('rental-duration-type');
        if (durationTypeSelect) {
            durationTypeSelect.value = 'weeks';
            document.getElementById('rental-weeks').style.display = 'block';
            document.getElementById('rental-weeks').value = '2';
        }
        
        updateRentalSummary();
        
    } catch (error) {
        console.error('Error loading rental form:', error);
        showToast('Error loading rental form: ' + error.message, 'error');
    }
}

function onRentalCustomerSelect(customerId) {
    const select = document.getElementById('rental-customer-select');
    const option = select.options[select.selectedIndex];
    
    document.getElementById('rental-customer-id').value = customerId;
    document.getElementById('rental-customer-phone').textContent = option.dataset.phone || '';
}

// View rental details
async function viewRentalDetails(rentalId) {
    const rental = allRentalsTabData.find(r => r.id === rentalId);
    if (!rental) {
        showToast('Rental not found', 'error');
        return;
    }
    
    const customer = rental.customers || {};
    const vehicle = rental.vehicles || {};
    const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
    const vehicleInfo = vehicle.id ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Not Assigned';
    
    // Create a detailed view alert/modal
    const details = `
RENTAL DETAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Rental ID: ${rental.rental_id || 'N/A'}
Status: ${rental.rental_status || 'Unknown'}

CUSTOMER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Name: ${customerName}
Phone: ${customer.phone || 'N/A'}
Email: ${customer.email || 'N/A'}

VEHICLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${vehicleInfo}
ID: ${vehicle.vehicle_id || 'N/A'}
Plate: ${vehicle.license_plate || 'N/A'}

RENTAL TERMS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Weekly Rate: $${rental.weekly_rate || 400}
Deposit: $${rental.deposit_amount || 500}
Start Date: ${rental.start_date || 'N/A'}
End Date: ${rental.end_date || 'Ongoing'}
Next Payment: ${rental.next_payment_due || 'N/A'}

MILEAGE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Start: ${rental.start_mileage || 'N/A'}
End: ${rental.end_mileage || 'N/A'}
    `.trim();
    
    alert(details);
}

// Approve pending rental
async function approveRental(rentalId) {
    if (!confirm('Approve this rental application?')) return;
    
    try {
        const { error } = await db
            .from('rentals')
            .update({
                rental_status: 'pending_rental',
                updated_at: new Date().toISOString()
            })
            .eq('id', rentalId);
        
        if (error) throw error;
        
        showToast('Rental approved! Ready for pickup.', 'success');
        loadRentalsTab();
        loadDashboardData();
        
    } catch (error) {
        console.error('Error approving rental:', error);
        showToast('Error approving rental', 'error');
    }
}

// Activate rental (customer picks up vehicle)
async function activateRental(rentalId) {
    if (!confirm('Mark this rental as active? This means the customer has picked up the vehicle.')) return;
    
    try {
        const rental = allRentalsTabData.find(r => r.id === rentalId);
        
        const { error } = await db
            .from('rentals')
            .update({
                rental_status: 'active',
                start_date: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString()
            })
            .eq('id', rentalId);
        
        if (error) throw error;
        
        // Update vehicle status
        if (rental?.vehicle_id) {
            await db
                .from('vehicles')
                .update({ 
                    status: 'Rented',
                    updated_at: new Date().toISOString()
                })
                .eq('id', rental.vehicle_id);
        }
        
        showToast('Rental activated! Vehicle is now rented.', 'success');
        loadRentalsTab();
        loadDashboardData();
        
    } catch (error) {
        console.error('Error activating rental:', error);
        showToast('Error activating rental', 'error');
    }
}

// Cancel rental
async function cancelRental(rentalId) {
    if (!confirm('Cancel this rental? This action cannot be undone.')) return;
    
    try {
        const rental = allRentalsTabData.find(r => r.id === rentalId);
        
        const { error } = await db
            .from('rentals')
            .update({
                rental_status: 'cancelled',
                updated_at: new Date().toISOString()
            })
            .eq('id', rentalId);
        
        if (error) throw error;
        
        // If vehicle was assigned, make it available again
        if (rental?.vehicle_id) {
            await db
                .from('vehicles')
                .update({ 
                    status: 'Active',
                    updated_at: new Date().toISOString()
                })
                .eq('id', rental.vehicle_id);
        }
        
        showToast('Rental cancelled.', 'success');
        loadRentalsTab();
        loadDashboardData();
        
    } catch (error) {
        console.error('Error cancelling rental:', error);
        showToast('Error cancelling rental', 'error');
    }
}

// Open Record Payment for specific rental
function openRecordPaymentForRental(rentalId) {
    openModal('record-payment');
    
    // Pre-select this rental in the payment form if the select exists
    setTimeout(() => {
        const rentalSelect = document.getElementById('payment-rental-select');
        if (rentalSelect) {
            rentalSelect.value = rentalId;
            // Trigger change event to update other fields
            rentalSelect.dispatchEvent(new Event('change'));
        }
    }, 300);
}

// ===========================
// PAYMENTS TAB FUNCTIONS (placeholder)
// ===========================
// ===========================
// PAYMENTS TAB - Full Implementation
// ===========================
let allPaymentsCache = [];

async function loadPaymentsTab() {
    const tbody = document.getElementById('payments-table-body');
    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-3xl mb-2"></i><p>Loading payments...</p></td></tr>';
    
    try {
        const { data: payments, error } = await db
            .from('payments')
            .select('*, customers(*), rentals(*, vehicles(*))')
            .order('paid_date', { ascending: false });
        
        if (error) throw error;
        
        allPaymentsCache = payments || [];
        updatePaymentsStats(allPaymentsCache);
        renderPaymentsTable(allPaymentsCache);
        
    } catch (error) {
        console.error('Error loading payments:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-circle text-3xl mb-2"></i><p>Error loading payments</p></td></tr>';
    }
}

function updatePaymentsStats(payments) {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // This month's confirmed payments
    const thisMonthPayments = payments.filter(p => {
        const paidDate = new Date(p.paid_date);
        return paidDate.getMonth() === currentMonth && 
               paidDate.getFullYear() === currentYear && 
               p.payment_status === 'confirmed';
    });
    const monthTotal = thisMonthPayments.reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
    document.getElementById('payments-month-total').textContent = '$' + monthTotal.toLocaleString();
    
    // Pending approval
    const pendingCount = payments.filter(p => p.payment_status === 'pending').length;
    document.getElementById('payments-pending-count').textContent = pendingCount;
    
    // Calculate overdue from rentals
    const overdueAmount = calculateOverdueAmount();
    document.getElementById('payments-overdue-amount').textContent = '$' + overdueAmount.toLocaleString();
    
    // Collection rate (confirmed / total this month)
    const totalPaymentsThisMonth = payments.filter(p => {
        const paidDate = new Date(p.paid_date);
        return paidDate.getMonth() === currentMonth && paidDate.getFullYear() === currentYear;
    }).length;
    const confirmedThisMonth = thisMonthPayments.length;
    const collectionRate = totalPaymentsThisMonth > 0 ? Math.round((confirmedThisMonth / totalPaymentsThisMonth) * 100) : 100;
    document.getElementById('payments-collection-rate').textContent = collectionRate + '%';
}

function calculateOverdueAmount() {
    const today = new Date();
    let overdueTotal = 0;
    
    const activeRentals = (dashboardCache.rentals || []).filter(r => r.rental_status === 'active');
    activeRentals.forEach(rental => {
        if (rental.next_payment_due) {
            const dueDate = new Date(rental.next_payment_due);
            if (dueDate < today) {
                overdueTotal += parseFloat(rental.weekly_rate) || 400;
            }
        }
    });
    
    return overdueTotal;
}

function renderPaymentsTable(payments) {
    const tbody = document.getElementById('payments-table-body');
    
    if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-receipt text-5xl mb-3 text-gray-300"></i><p>No payments found</p><button onclick="openModal(\'record-payment\')" class="mt-3 text-fleetzy-green hover:underline">Record your first payment</button></td></tr>';
        return;
    }
    
    tbody.innerHTML = payments.map(payment => {
        const customer = payment.customers || {};
        const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const amount = parseFloat(payment.paid_amount) || 0;
        const method = payment.payment_method || 'Unknown';
        const status = payment.payment_status || 'pending';
        const paidDate = payment.paid_date ? new Date(payment.paid_date).toLocaleDateString() : 'N/A';
        const paymentType = payment.payment_type || 'weekly';
        
        // Method badge colors
        const methodColors = {
            zelle: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400',
            cashapp: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
            venmo: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
            stripe: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400',
            cash: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
            paypal: 'bg-sky-100 text-sky-800 dark:bg-sky-900/30 dark:text-sky-400'
        };
        const methodClass = methodColors[method.toLowerCase()] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        
        // Status badge
        const statusColors = {
            confirmed: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
            pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
            failed: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'
        };
        const statusClass = statusColors[status] || 'bg-gray-100 text-gray-800';
        
        // Type badge
        const typeLabels = { weekly: 'Weekly Rent', deposit: 'Deposit', late_fee: 'Late Fee' };
        const typeLabel = typeLabels[paymentType] || 'Payment';
        
        // Actions based on status
        let actions = '';
        if (status === 'pending') {
            actions = `
                <button onclick="approvePayment('${payment.id}')" class="text-green-600 hover:text-green-800 mx-1" title="Approve">
                    <i class="fas fa-check-circle"></i>
                </button>
                <button onclick="rejectPayment('${payment.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Reject">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
        }
        if (payment.screenshot_url) {
            actions += `<button onclick="viewPaymentScreenshot('${payment.screenshot_url}')" class="text-blue-600 hover:text-blue-800 mx-1" title="View Screenshot"><i class="fas fa-image"></i></button>`;
        }
        actions += `<button onclick="viewPaymentDetails('${payment.id}')" class="text-gray-600 hover:text-gray-800 mx-1" title="Details"><i class="fas fa-eye"></i></button>`;
        
        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <img src="${customer.selfie_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(customerName)}&background=059669&color=fff`}" 
                             class="w-10 h-10 rounded-full mr-3 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(customerName)}&background=059669&color=fff'">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">${customerName}</p>
                            <p class="text-xs text-gray-500">${payment.payment_id || payment.id.substring(0, 8)}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="text-lg font-bold text-gray-900 dark:text-white">$${amount.toLocaleString()}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-sm text-gray-600 dark:text-gray-400">${typeLabel}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${methodClass}">${method.charAt(0).toUpperCase() + method.slice(1)}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-gray-700 dark:text-gray-300">${paidDate}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                </td>
                <td class="px-6 py-4 text-center">
                    ${actions}
                </td>
            </tr>
        `;
    }).join('');
}

function filterPayments() {
    const search = document.getElementById('payments-search')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('payments-status-filter')?.value || '';
    const methodFilter = document.getElementById('payments-method-filter')?.value || '';
    const typeFilter = document.getElementById('payments-type-filter')?.value || '';
    
    let filtered = [...allPaymentsCache];
    
    if (search) {
        filtered = filtered.filter(p => {
            const customer = p.customers || {};
            const customerName = (customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`).toLowerCase();
            return customerName.includes(search) || (p.payment_id || '').toLowerCase().includes(search);
        });
    }
    
    if (statusFilter) {
        filtered = filtered.filter(p => p.payment_status === statusFilter);
    }
    
    if (methodFilter) {
        filtered = filtered.filter(p => (p.payment_method || '').toLowerCase() === methodFilter);
    }
    
    if (typeFilter) {
        filtered = filtered.filter(p => p.payment_type === typeFilter);
    }
    
    renderPaymentsTable(filtered);
}

async function approvePayment(paymentId) {
    if (!confirm('Approve this payment?')) return;
    
    try {
        const { error } = await db
            .from('payments')
            .update({ 
                payment_status: 'confirmed',
                approved_by: 'Admin',
                approved_at: new Date().toISOString()
            })
            .eq('id', paymentId);
        
        if (error) throw error;
        
        showToast('Payment approved! âœ“', 'success');
        loadPaymentsTab();
        loadDashboardData();
        
    } catch (error) {
        console.error('Error approving payment:', error);
        showToast('Error approving payment', 'error');
    }
}

async function rejectPayment(paymentId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return;
    
    try {
        const { error } = await db
            .from('payments')
            .update({ 
                payment_status: 'failed',
                notes: reason ? `Rejected: ${reason}` : 'Rejected by admin'
            })
            .eq('id', paymentId);
        
        if (error) throw error;
        
        showToast('Payment rejected', 'warning');
        loadPaymentsTab();
        
    } catch (error) {
        console.error('Error rejecting payment:', error);
        showToast('Error rejecting payment', 'error');
    }
}

function viewPaymentScreenshot(url) {
    if (url) {
        window.open(url, '_blank');
    } else {
        showToast('No screenshot available', 'info');
    }
}

function viewPaymentDetails(paymentId) {
    const payment = allPaymentsCache.find(p => p.id === paymentId);
    if (!payment) return;
    
    const customer = payment.customers || {};
    const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
    
    alert(`Payment Details:
    
ID: ${payment.payment_id || paymentId.substring(0, 8)}
Customer: ${customerName}
Amount: $${payment.paid_amount}
Method: ${payment.payment_method}
Date: ${payment.paid_date}
Status: ${payment.payment_status}
Notes: ${payment.notes || 'None'}`);
}

function exportPayments() {
    if (allPaymentsCache.length === 0) {
        showToast('No payments to export', 'warning');
        return;
    }
    
    const csv = [
        ['Payment ID', 'Customer', 'Amount', 'Type', 'Method', 'Date', 'Status', 'Notes'].join(','),
        ...allPaymentsCache.map(p => {
            const customer = p.customers || {};
            const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim();
            return [
                p.payment_id || p.id.substring(0, 8),
                `"${customerName}"`,
                p.paid_amount,
                p.payment_type || 'weekly',
                p.payment_method,
                p.paid_date,
                p.payment_status,
                `"${(p.notes || '').replace(/"/g, '""')}"`
            ].join(',');
        })
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fleetzy-payments-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Payments exported!', 'success');
}

// ===========================
// REPORTS TAB - Full Implementation
// ===========================

async function loadReportsData() {
    try {
        const period = document.getElementById('reports-period')?.value || 'this_month';
        const dateRange = getDateRange(period);
        
        // Load all data including expenses
        const { data: payments } = await db.from('payments').select('*, customers(*)').eq('payment_status', 'confirmed');
        const { data: rentals } = await db.from('rentals').select('*, customers(*), vehicles(*)');
        const { data: vehicles } = await db.from('vehicles').select('*');
        const { data: expenses } = await db.from('expenses').select('*');
        
        // Filter payments by date range
        const filteredPayments = (payments || []).filter(p => {
            const date = new Date(p.paid_date);
            return date >= dateRange.start && date <= dateRange.end;
        });
        
        // Filter expenses by date range
        const filteredExpenses = (expenses || []).filter(e => {
            if (!e.expense_date) return false;
            const date = new Date(e.expense_date);
            return date >= dateRange.start && date <= dateRange.end;
        });
        
        // Update stats
        updateReportsMetrics(filteredPayments, rentals || [], vehicles || [], filteredExpenses);
        updateRevenueBreakdown(filteredPayments);
        updateUpcomingPayments(rentals || []);
        updateRecentPayments(payments || []);
        updateCustomerReliability(rentals || [], payments || []);
        
    } catch (error) {
        console.error('Error loading reports:', error);
        showToast('Error loading reports', 'error');
    }
}

function getDateRange(period) {
    const now = new Date();
    let start, end;
    
    switch (period) {
        case 'this_week':
            start = new Date(now);
            start.setDate(now.getDate() - now.getDay());
            start.setHours(0, 0, 0, 0);
            end = new Date(now);
            break;
        case 'this_month':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now);
            break;
        case 'last_month':
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
        case 'this_quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            start = new Date(now.getFullYear(), quarter * 3, 1);
            end = new Date(now);
            break;
        case 'this_year':
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now);
            break;
        case 'all_time':
            start = new Date(2020, 0, 1);
            end = new Date(now);
            break;
        default:
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now);
    }
    
    return { start, end };
}

function updateReportsMetrics(payments, rentals, vehicles, expenses) {
    expenses = expenses || [];
    
    // Total revenue
    const totalRevenue = payments.reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
    document.getElementById('reports-total-revenue').textContent = '$' + totalRevenue.toLocaleString();
    
    // Total expenses
    const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
    const expensesEl = document.getElementById('reports-total-expenses');
    if (expensesEl) expensesEl.textContent = '$' + totalExpenses.toLocaleString();
    
    // Net profit
    const netProfit = totalRevenue - totalExpenses;
    const profitEl = document.getElementById('reports-net-profit');
    if (profitEl) {
        profitEl.textContent = (netProfit >= 0 ? '$' : '-$') + Math.abs(netProfit).toLocaleString();
        profitEl.className = netProfit >= 0 
            ? 'text-2xl font-bold text-fleetzy-green' 
            : 'text-2xl font-bold text-red-500';
    }
    
    // Total rentals in period
    document.getElementById('reports-total-rentals').textContent = rentals.filter(r => 
        r.rental_status === 'active' || r.rental_status === 'completed'
    ).length;
    
    // Fleet utilization
    const totalVehicles = vehicles.length || 1;
    const rentedVehicles = vehicles.filter(v => 
        v.vehicle_status === 'rented' || v.vehicle_status === 'Currently Rented'
    ).length;
    const utilization = Math.round((rentedVehicles / totalVehicles) * 100);
    document.getElementById('reports-utilization').textContent = utilization + '%';
    
    // Avg per vehicle
    const avgPerVehicle = totalVehicles > 0 ? Math.round(totalRevenue / totalVehicles) : 0;
    const avgEl = document.getElementById('reports-avg-per-vehicle');
    if (avgEl) avgEl.textContent = '$' + avgPerVehicle.toLocaleString();
    
    // Top earner vehicle
    const vehicleRevenue = {};
    payments.forEach(p => {
        const rental = rentals.find(r => r.id === p.rental_id);
        if (rental && rental.vehicle_id) {
            vehicleRevenue[rental.vehicle_id] = (vehicleRevenue[rental.vehicle_id] || 0) + parseFloat(p.paid_amount || 0);
        }
    });
    const topEarnerEntry = Object.entries(vehicleRevenue).sort((a, b) => b[1] - a[1])[0];
    const topEarnerVehicle = topEarnerEntry ? vehicles.find(v => v.id === topEarnerEntry[0]) : null;
    const topEarnerName = topEarnerVehicle ? (topEarnerVehicle.vehicle_id || topEarnerVehicle.license_plate || 'Vehicle') : '-';
    const topEl = document.getElementById('reports-top-earner');
    if (topEl) topEl.textContent = topEarnerName;
    
    // Deposits held
    const depositsHeld = rentals
        .filter(r => r.rental_status === 'active')
        .reduce((sum, r) => sum + (parseFloat(r.deposit_amount) || 0), 0);
    document.getElementById('reports-deposits-held').textContent = '$' + depositsHeld.toLocaleString();
    
    // Customer stats
    const uniqueCustomers = new Set(rentals.map(r => r.customer_id)).size;
    const activeCustomers = rentals.filter(r => r.rental_status === 'active').length;
    
    const totalCustomersEl = document.getElementById('reports-total-customers');
    if (totalCustomersEl) totalCustomersEl.textContent = uniqueCustomers;
    
    const activeCustomersEl = document.getElementById('reports-active-customers');
    if (activeCustomersEl) activeCustomersEl.textContent = activeCustomers;
    
    // Average reliability score
    const customersWithRentals = rentals
        .filter(r => r.customers)
        .map(r => r.customers);
    const avgScore = customersWithRentals.length > 0 
        ? (customersWithRentals.reduce((sum, c) => sum + (parseFloat(c.payment_reliability_score) || 5), 0) / customersWithRentals.length).toFixed(1)
        : '5.0';
    const scoreEl = document.getElementById('reports-avg-score');
    if (scoreEl) scoreEl.textContent = avgScore + '/10';
}

function updateRevenueBreakdown(payments) {
    const rentalRevenue = payments
        .filter(p => !p.payment_type || p.payment_type === 'weekly')
        .reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
    
    const depositRevenue = payments
        .filter(p => p.payment_type === 'deposit')
        .reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
    
    const lateFees = payments
        .filter(p => p.payment_type === 'late_fee')
        .reduce((sum, p) => sum + (parseFloat(p.paid_amount) || 0), 0);
    
    const total = rentalRevenue + depositRevenue + lateFees;
    
    document.getElementById('reports-rental-revenue').textContent = '$' + rentalRevenue.toLocaleString();
    document.getElementById('reports-deposit-revenue').textContent = '$' + depositRevenue.toLocaleString();
    document.getElementById('reports-late-fees').textContent = '$' + lateFees.toLocaleString();
    document.getElementById('reports-total-collected').textContent = '$' + total.toLocaleString();
    
    // Update bars
    const maxVal = Math.max(rentalRevenue, depositRevenue, lateFees, 1);
    document.getElementById('reports-rental-bar').style.width = ((rentalRevenue / total) * 100 || 0) + '%';
    document.getElementById('reports-deposit-bar').style.width = ((depositRevenue / total) * 100 || 0) + '%';
    document.getElementById('reports-late-bar').style.width = ((lateFees / total) * 100 || 0) + '%';
}

function updateUpcomingPayments(rentals) {
    const container = document.getElementById('upcoming-payments-list');
    const today = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    
    const upcomingRentals = rentals
        .filter(r => {
            if (r.rental_status !== 'active') return false;
            if (!r.next_payment_due) return false;
            const dueDate = new Date(r.next_payment_due);
            return dueDate >= today && dueDate <= nextWeek;
        })
        .sort((a, b) => new Date(a.next_payment_due) - new Date(b.next_payment_due));
    
    if (upcomingRentals.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No payments due in the next 7 days</p>';
        return;
    }
    
    container.innerHTML = upcomingRentals.map(rental => {
        const customer = rental.customers || {};
        const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const dueDate = new Date(rental.next_payment_due);
        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        const urgencyClass = daysUntil <= 1 ? 'text-red-500' : daysUntil <= 3 ? 'text-orange-500' : 'text-gray-500';
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <div class="flex items-center">
                    <img src="${customer.selfie_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(customerName)}&background=059669&color=fff`}" 
                         class="w-8 h-8 rounded-full mr-3">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white text-sm">${customerName}</p>
                        <p class="text-xs ${urgencyClass}">${daysUntil === 0 ? 'Due today' : daysUntil === 1 ? 'Due tomorrow' : `Due in ${daysUntil} days`}</p>
                    </div>
                </div>
                <span class="font-bold text-gray-900 dark:text-white">$${rental.weekly_rate || 400}</span>
            </div>
        `;
    }).join('');
}

function updateRecentPayments(payments) {
    const container = document.getElementById('recent-payments-list');
    const recentPayments = payments.slice(0, 5);
    
    if (recentPayments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent payments</p>';
        return;
    }
    
    container.innerHTML = recentPayments.map(payment => {
        const customer = payment.customers || {};
        const customerName = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown';
        const paidDate = payment.paid_date ? new Date(payment.paid_date).toLocaleDateString() : 'N/A';
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                        <i class="fas fa-check text-green-600 text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white text-sm">${customerName}</p>
                        <p class="text-xs text-gray-500">${paidDate}</p>
                    </div>
                </div>
                <span class="font-bold text-green-600">+$${payment.paid_amount}</span>
            </div>
        `;
    }).join('');
}

function updateCustomerReliability(rentals, payments) {
    const container = document.getElementById('customer-reliability-list');
    
    // Group by customer
    const customerStats = {};
    
    rentals.forEach(rental => {
        const customer = rental.customers || {};
        const customerId = rental.customer_id;
        if (!customerId) return;
        
        if (!customerStats[customerId]) {
            customerStats[customerId] = {
                name: customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim(),
                selfie: customer.selfie_url,
                totalRentals: 0,
                activeRentals: 0,
                score: customer.payment_reliability_score || 5
            };
        }
        
        customerStats[customerId].totalRentals++;
        if (rental.rental_status === 'active') {
            customerStats[customerId].activeRentals++;
        }
    });
    
    const customers = Object.values(customerStats).sort((a, b) => b.score - a.score).slice(0, 5);
    
    if (customers.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No customer data</p>';
        return;
    }
    
    container.innerHTML = customers.map(customer => {
        const scoreColor = customer.score >= 7 ? 'text-green-500' : customer.score >= 4 ? 'text-yellow-500' : 'text-red-500';
        const scoreBg = customer.score >= 7 ? 'bg-green-100 dark:bg-green-900/30' : customer.score >= 4 ? 'bg-yellow-100 dark:bg-yellow-900/30' : 'bg-red-100 dark:bg-red-900/30';
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <div class="flex items-center">
                    <img src="${customer.selfie || `https://ui-avatars.com/api/?name=${encodeURIComponent(customer.name)}&background=059669&color=fff`}" 
                         class="w-8 h-8 rounded-full mr-3">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white text-sm">${customer.name || 'Unknown'}</p>
                        <p class="text-xs text-gray-500">${customer.totalRentals} rental${customer.totalRentals !== 1 ? 's' : ''}</p>
                    </div>
                </div>
                <span class="px-2 py-1 rounded-full text-xs font-bold ${scoreBg} ${scoreColor}">${customer.score.toFixed(1)}/10</span>
            </div>
        `;
    }).join('');
}

function exportReports() {
    showToast('Generating report...', 'info');
    
    setTimeout(() => {
        const period = document.getElementById('reports-period')?.value || 'this_month';
        const revenue = document.getElementById('reports-total-revenue')?.textContent || '$0';
        const expenses = document.getElementById('reports-total-expenses')?.textContent || '$0';
        const profit = document.getElementById('reports-net-profit')?.textContent || '$0';
        const rentals = document.getElementById('reports-total-rentals')?.textContent || '0';
        const utilization = document.getElementById('reports-utilization')?.textContent || '0%';
        const avgPerVehicle = document.getElementById('reports-avg-per-vehicle')?.textContent || '$0';
        const topEarner = document.getElementById('reports-top-earner')?.textContent || '-';
        const depositsHeld = document.getElementById('reports-deposits-held')?.textContent || '$0';
        const totalCustomers = document.getElementById('reports-total-customers')?.textContent || '0';
        const activeCustomers = document.getElementById('reports-active-customers')?.textContent || '0';
        const avgScore = document.getElementById('reports-avg-score')?.textContent || '5.0/10';
        
        const report = `FLEETZY BUSINESS REPORT
Generated: ${new Date().toLocaleString()}
Period: ${period.replace(/_/g, ' ').toUpperCase()}

FINANCIAL SUMMARY
==================
Total Revenue: ${revenue}
Total Expenses: ${expenses}
Net Profit: ${profit}
Deposits Held: ${depositsHeld}

FLEET PERFORMANCE
==================
Total Rentals: ${rentals}
Fleet Utilization: ${utilization}
Avg Revenue/Vehicle: ${avgPerVehicle}
Top Earning Vehicle: ${topEarner}

CUSTOMER INSIGHTS
==================
Total Customers: ${totalCustomers}
Active Renters: ${activeCustomers}
Avg Reliability Score: ${avgScore}

REVENUE BREAKDOWN
==================
Weekly Rentals: ${document.getElementById('reports-rental-revenue')?.textContent || '$0'}
Deposits: ${document.getElementById('reports-deposit-revenue')?.textContent || '$0'}
Late Fees: ${document.getElementById('reports-late-fees')?.textContent || '$0'}
---
Total Collected: ${document.getElementById('reports-total-collected')?.textContent || '$0'}

---
Report generated by Fleetzy Admin Dashboard
`;
        
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fleetzy-report-${period}-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Report exported!', 'success');
    }, 500);
}

async function reinstateCustomer(customerId) {
    if (!confirm('Reinstate this customer and set their status back to Pending for review?')) return;
    
    try {
        const { error } = await db
            .from('customers')
            .update({
                status: 'pending',
                application_status: 'pending',
                rejection_reason: null,
                rejected_at: null,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
        
        if (error) throw error;
        
        showToast('Customer reinstated for review! âœ“', 'success');
        loadCustomersTab();
        
    } catch (error) {
        console.error('Error reinstating customer:', error);
        showToast('Error reinstating customer', 'error');
    }
}

// Delete customer permanently
async function deleteCustomer(customerId, customerName) {
    // First, check what kind of rentals exist for this customer
    const { data: rentals, error: rentalCheckError } = await db
        .from('rentals')
        .select('id, rental_status, vehicle_id')
        .eq('customer_id', customerId);
    
    if (rentalCheckError) {
        console.error('Error checking rentals:', rentalCheckError);
    }
    
    // Categorize rentals - ONLY block for truly ACTIVE rentals (vehicle currently in use)
    const activeRentals = rentals?.filter(r => r.rental_status === 'active') || [];
    const pendingRentals = rentals?.filter(r => 
        ['pending_approval', 'pending_rental', 'pending'].includes(r.rental_status)
    ) || [];
    const completedRentals = rentals?.filter(r => 
        ['completed', 'cancelled', 'ended'].includes(r.rental_status)
    ) || [];
    
    // Block deletion ONLY if there's an ACTIVE rental with a vehicle assigned
    if (activeRentals.length > 0) {
        showToast(`Cannot delete: Customer has ${activeRentals.length} active rental(s) with vehicles in use. End the rental first.`, 'error');
        return;
    }
    
    // Build confirmation message
    let confirmMsg = `Are you sure you want to DELETE "${customerName}"?\n\n`;
    confirmMsg += `This will permanently remove:\n- Customer profile\n- All associated documents\n`;
    if (pendingRentals.length > 0) {
        confirmMsg += `- ${pendingRentals.length} pending rental application(s)\n`;
    }
    if (completedRentals.length > 0) {
        confirmMsg += `- ${completedRentals.length} completed rental record(s)\n`;
    }
    confirmMsg += `\nâš ï¸ This action cannot be undone!`;
    
    if (!confirm(confirmMsg)) return;
    
    // Second confirmation
    const confirmText = prompt(`To confirm deletion, type "DELETE" (all caps):`);
    if (confirmText !== 'DELETE') {
        showToast('Deletion cancelled - confirmation text did not match', 'warning');
        return;
    }
    
    try {
        // Delete related records first (foreign key constraints)
        if (rentals && rentals.length > 0) {
            const rentalIds = rentals.map(r => r.id);
            
            // Delete payments first
            await db.from('payments').delete().in('rental_id', rentalIds);
            
            // Delete all rentals for this customer (pending, completed, etc.)
            await db.from('rentals').delete().eq('customer_id', customerId);
        }
        
        // Delete the customer
        const { error } = await db
            .from('customers')
            .delete()
            .eq('id', customerId);
        
        if (error) throw error;
        
        showToast(`Customer "${customerName}" deleted successfully`, 'success');
        loadCustomersTab();
        
        // Also refresh dashboard if we're caching data
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error deleting customer:', error);
        showToast('Error deleting customer: ' + (error.message || 'Unknown error'), 'error');
    }
}

// Send SMS to customer
async function sendMessageToCustomer(customerId) {
    try {
        const { data: customer } = await db
            .from('customers')
            .select('phone, full_name, first_name')
            .eq('id', customerId)
            .single();
        
        if (!customer?.phone) {
            showToast('No phone number found for this customer', 'warning');
            return;
        }
        
        const name = customer.full_name || customer.first_name || 'Customer';
        const message = prompt(`Send SMS to ${name}:\n\nEnter your message:`);
        
        if (message === null || message.trim() === '') return;
        
        // You could integrate with your GHL API here to send SMS
        // For now, we'll just open the phone app
        const encodedMessage = encodeURIComponent(message);
        const phone = customer.phone.replace(/\D/g, '');
        
        // Try to open SMS app
        window.open(`sms:${phone}?body=${encodedMessage}`, '_blank');
        
        showToast('Opening SMS app...', 'info');
        
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error preparing message', 'error');
    }
}

// View customer's rentals
async function viewCustomerRentals(customerId) {
    // For now, open the customer detail which shows rentals
    viewCustomerDetail(customerId);
}

// Export customers
function exportCustomers() {
    if (allCustomersTabData.length === 0) {
        showToast('No customers to export', 'warning');
        return;
    }
    
    const headers = ['Customer ID', 'Name', 'Phone', 'Email', 'Status', 'Type', 'Applied', 'Total Rentals', 'DL Number', 'DL State', 'DL Expiry'];
    const rows = allCustomersTabData.map(c => [
        c.customer_id || '',
        c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim(),
        c.phone || '',
        c.email || '',
        c.status || c.application_status || 'pending',
        (c.is_company_rental || c.is_corporate_rental) ? 'Corporate' : 'Individual',
        c.created_at ? new Date(c.created_at).toLocaleDateString() : '',
        c.rental_count || 0,
        c.dl_number || '',
        c.dl_state || '',
        c.dl_expiry_date || ''
    ]);
    
    const csvContent = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fleetzy-customers-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showToast('Customers exported to CSV!', 'success');
}

// Close customer detail modal on backdrop click
document.getElementById('modal-customer-detail')?.addEventListener('click', (e) => {
    if (e.target.id === 'modal-customer-detail') closeCustomerDetailModal();
});

document.getElementById('modal-edit-customer')?.addEventListener('click', (e) => {
    if (e.target.id === 'modal-edit-customer') closeEditCustomerModal();
});

document.getElementById('modal-start-rental-customer')?.addEventListener('click', (e) => {
    if (e.target.id === 'modal-start-rental-customer') closeStartRentalCustomerModal();
});

    </script>

    <!-- ========================================
         FORM #1: ADD VEHICLE MODAL
         Integrated: November 19, 2025
         ======================================== -->
<!-- ========================================
     FORM #1: ADD VEHICLE MODAL
     Complete with validation, image upload, and database insert
     ======================================== -->

<!-- Modal Backdrop -->
<div id="modal-add-vehicle" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <!-- Modal Container -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-car text-fleetzy-green mr-3"></i>
                Add New Vehicle
            </h2>
            <button onclick="closeModal('add-vehicle')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Body (Scrollable) -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
            <form id="form-add-vehicle" class="space-y-6">
                
                <!-- SECTION: Vehicle Photo -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center mb-4">
                        <i class="fas fa-camera text-fleetzy-green mr-2"></i>
                        Vehicle Photo
                    </h3>
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-fleetzy-green transition-colors">
                        <input type="file" 
                               id="vehicle-photo-input" 
                               accept="image/*" 
                               capture="environment"
                               required
                               class="hidden"
                               onchange="handleVehiclePhotoUpload(event)">
                        <label for="vehicle-photo-input" class="cursor-pointer block">
                            <div id="photo-upload-area">
                                <i class="fas fa-camera text-5xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                                    Click to upload or take photo *
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">
                                    Max 5MB â€¢ JPG, PNG, HEIC
                                </p>
                            </div>
                        </label>
                        <div id="vehicle-photo-preview" class="mt-4 hidden">
                            <img src="" class="max-w-full h-64 mx-auto rounded-lg shadow-lg object-cover">
                            <button type="button" 
                                    onclick="removeVehiclePhoto()"
                                    class="mt-3 text-red-600 hover:text-red-700 dark:text-red-400 text-sm">
                                <i class="fas fa-trash mr-1"></i>Remove Photo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SECTION: Basic Details -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-info-circle text-fleetzy-green mr-2"></i>
                            Basic Details
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Friendly Name (REQUIRED) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Vehicle Name *
                                <span class="text-xs text-gray-500 ml-2">(e.g., "Silver Camry" or "Red Civic")</span>
                            </label>
                            <input type="text" 
                                   name="friendly_name" 
                                   required
                                   placeholder="e.g., Silver Camry"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Year -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Year *
                            </label>
                            <select name="year" required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                                <option value="">Select Year...</option>
                            </select>
                        </div>

                        <!-- Make -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Make *
                            </label>
                            <input type="text" 
                                   name="make" 
                                   required
                                   placeholder="e.g., Toyota"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Model *
                            </label>
                            <input type="text" 
                                   name="model" 
                                   required
                                   placeholder="e.g., Camry"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Color -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Color
                            </label>
                            <select name="color"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                                <option value="">Select Color...</option>
                                <option value="White">White</option>
                                <option value="Black">Black</option>
                                <option value="Silver">Silver</option>
                                <option value="Gray">Gray</option>
                                <option value="Red">Red</option>
                                <option value="Blue">Blue</option>
                                <option value="Green">Green</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- VIN -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                VIN *
                                <span class="text-xs text-gray-500 ml-2">(17 characters, unique)</span>
                            </label>
                            <input type="text" 
                                   name="vin" 
                                   required
                                   maxlength="17"
                                   minlength="17"
                                   placeholder="e.g., 1HGCM82633A123456"
                                   oninput="validateVIN(this)"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent uppercase">
                            <p id="vin-error" class="hidden text-sm text-red-600 dark:text-red-400 mt-1">
                                <i class="fas fa-exclamation-circle mr-1"></i>VIN must be exactly 17 characters
                            </p>
                            <p id="vin-duplicate-error" class="hidden text-sm text-red-600 dark:text-red-400 mt-1">
                                <i class="fas fa-exclamation-circle mr-1"></i>This VIN already exists in the system
                            </p>
                        </div>

                        <!-- License Plate -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                License Plate
                            </label>
                            <input type="text" 
                                   name="license_plate"
                                   placeholder="e.g., ABC-1234"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent uppercase">
                        </div>

                        <!-- Condition -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Condition
                            </label>
                            <select name="condition"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                                <option value="">Select Condition...</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good" selected>Good</option>
                                <option value="Fair">Fair</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SECTION: Mileage Info -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-tachometer-alt text-fleetzy-green mr-2"></i>
                            Mileage Info
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Current Mileage -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Current Mileage
                            </label>
                            <input type="number" 
                                   name="current_mileage"
                                   min="0"
                                   placeholder="e.g., 50000"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Last Service Mileage -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Last Service Mileage
                            </label>
                            <input type="number" 
                                   name="last_service_mileage"
                                   min="0"
                                   placeholder="e.g., 48000"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- SECTION: GPS & Insurance -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-shield-alt text-fleetzy-green mr-2"></i>
                            GPS & Insurance
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- GPS Device ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                GPS Device ID
                                <span class="text-xs text-gray-500 ml-2">(Spy Spot GPS)</span>
                            </label>
                            <input type="text" 
                                   name="gps_device_id"
                                   placeholder="e.g., GPS-123456"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- GPS Cost (Monthly) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                GPS Cost (Monthly)
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="gps_cost_monthly" 
                                       step="0.01" 
                                       min="0"
                                       value="25"
                                       placeholder="e.g., 25"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Insurance Cost (Monthly) - REQUIRED -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Insurance Cost (Monthly) *
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="insurance_monthly" 
                                       required
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 150"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Registration Cost -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Registration Cost (Annual)
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="registration_cost"
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 75"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Toll Tag ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Toll Tag ID
                                <span class="text-xs text-gray-500 ml-2">(EZ-TAG, TxTag, etc.)</span>
                            </label>
                            <input type="text" 
                                   name="toll_tag_id"
                                   placeholder="e.g., TAG-123456"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- SECTION: Purchase Details (Required) -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-file-invoice-dollar text-fleetzy-green mr-2"></i>
                            Purchase Details
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Purchase Price - REQUIRED -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Purchase Price *
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="purchase_price" 
                                       required
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 8500"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Purchase Date - REQUIRED -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Purchase Date *
                            </label>
                            <input type="date" 
                                   name="purchase_date"
                                   required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Monthly Payment - REQUIRED -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Monthly Payment *
                                <span class="text-xs text-gray-500 ml-1">(if financed)</span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="monthly_payment" 
                                       required
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 285"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Down Payment -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Down Payment
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="down_payment" 
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 850"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Loan Amount -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Loan Amount
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="loan_amount" 
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 7650"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>

                        <!-- Initial Prep Cost -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Initial Prep Cost
                                <span class="text-xs text-gray-500 ml-1">(cleaning, fixes)</span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 dark:text-gray-400">$</span>
                                <input type="number" 
                                       name="initial_prep_cost" 
                                       step="0.01" 
                                       min="0"
                                       placeholder="e.g., 200"
                                       class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: Maintenance -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-wrench text-fleetzy-green mr-2"></i>
                            Maintenance Info
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Last Service Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Last Service Date
                            </label>
                            <input type="date" 
                                   name="last_service_date"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

            </form>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" 
                    onclick="closeModal('add-vehicle')" 
                    class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                Cancel
            </button>
            <button type="submit" 
                    form="form-add-vehicle"
                    id="submit-add-vehicle"
                    class="px-6 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                <i class="fas fa-check mr-2"></i>
                <span id="submit-text">Add Vehicle</span>
                <i class="fas fa-spinner fa-spin ml-2 hidden" id="submit-spinner"></i>
            </button>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL #2: ADD CUSTOMER
     ======================================== -->
<div id="modal-add-customer" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <!-- Modal Container -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-user-plus text-fleetzy-green mr-3"></i>
                Add New Customer
            </h2>
            <button onclick="closeModal('add-customer')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Body (Scrollable) -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
            <form id="form-add-customer" class="space-y-6">
                
                <!-- SECTION: Customer Type Toggle -->
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg border-2 border-fleetzy-green">
                    <label class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center">
                            <i class="fas fa-building text-fleetzy-green text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold text-gray-900 dark:text-white">Corporate Rental</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Company pays for driver (no income proof needed)</div>
                            </div>
                        </div>
                        <div class="relative">
                            <input type="checkbox" 
                                   id="is-company-rental"
                                   name="is_company_rental"
                                   onchange="toggleCustomerType()"
                                   class="sr-only peer">
                            <div class="w-14 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-fleetzy-green"></div>
                        </div>
                    </label>
                </div>

                <!-- SECTION: Personal Information -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-id-card text-fleetzy-green mr-2"></i>
                            <span id="personal-info-title">Driver Information</span>
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Full Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Full Name *
                            </label>
                            <input type="text" 
                                   name="full_name" 
                                   required
                                   placeholder="e.g., John Michael Smith"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Phone *
                            </label>
                            <input type="tel" 
                                   name="phone" 
                                   required
                                   placeholder="+1 (281) 555-1234"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Email *
                            </label>
                            <input type="email" 
                                   name="email" 
                                   required
                                   placeholder="john.smith@example.com"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Date of Birth -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Date of Birth
                            </label>
                            <input type="date" 
                                   name="date_of_birth"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Address -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Current Address
                            </label>
                            <input type="text" 
                                   name="current_address"
                                   placeholder="1234 Main St, Houston, TX 77001"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- SECTION: Driver's License Info -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-id-card-alt text-fleetzy-green mr-2"></i>
                            Driver's License
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- DL Number -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                DL Number *
                            </label>
                            <input type="text" 
                                   name="dl_number" 
                                   required
                                   placeholder="e.g., 12345678"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent uppercase">
                        </div>

                        <!-- DL State -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                DL State *
                            </label>
                            <select name="dl_state" required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                                <option value="">Select State...</option>
                                <option value="TX" selected>Texas</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <!-- Add more states as needed -->
                            </select>
                        </div>

                        <!-- DL Expiry Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                DL Expiry Date
                            </label>
                            <input type="date" 
                                   name="dl_expiry_date"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- SECTION: Gig Platform Info -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-car-side text-fleetzy-green mr-2"></i>
                            Gig Platform (Optional)
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Gig Platform -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Platform
                            </label>
                            <select name="gig_platform"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                                <option value="">Select Platform...</option>
                                <option value="Uber">Uber</option>
                                <option value="Lyft">Lyft</option>
                                <option value="DoorDash">DoorDash</option>
                                <option value="Uber Eats">Uber Eats</option>
                                <option value="GrubHub">GrubHub</option>
                                <option value="Instacart">Instacart</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Gig Rating -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Platform Rating
                            </label>
                            <input type="number" 
                                   name="gig_rating"
                                   step="0.01"
                                   min="0"
                                   max="5"
                                   placeholder="e.g., 4.85"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- SECTION: Company Information (Corporate Only) -->
                <div id="company-info-section" class="hidden">
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-building text-fleetzy-green mr-2"></i>
                            Company Information
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Company Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Company Name *
                            </label>
                            <input type="text" 
                                   name="company_name"
                                   placeholder="e.g., Acme Delivery Inc"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Company Contact Person -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                HR Contact Person *
                            </label>
                            <input type="text" 
                                   name="company_contact_person"
                                   placeholder="e.g., Jane Smith"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Company Phone -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Company Phone *
                            </label>
                            <input type="tel" 
                                   name="company_phone"
                                   placeholder="+1 (281) 555-5678"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>

                        <!-- Company Email -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Company Email *
                            </label>
                            <input type="email" 
                                   name="company_email"
                                   placeholder="hr@acmedelivery.com"
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-fleetzy-green focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mt-1 mr-3"></i>
                            <div class="text-sm text-blue-800 dark:text-blue-200">
                                <strong>Corporate Rental Process:</strong> HR representative will receive the contract first. After HR signs, the driver will receive the contract to sign. Both signatures are required before rental starts.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: Document Uploads -->
                <div>
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-camera text-fleetzy-green mr-2"></i>
                            Required Documents
                        </h3>
                    </div>
                    
                    <!-- DL Front Photo -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Driver's License (Front) *
                        </label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                            <input type="file" 
                                   id="dl-front-input" 
                                   accept="image/*" 
                                   capture="environment"
                                   required
                                   class="hidden"
                                   onchange="handleImageUpload(event, 'dl-front')">
                            <label for="dl-front-input" class="cursor-pointer block">
                                <div id="dl-front-upload-area">
                                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Click to upload or take photo *</p>
                                </div>
                            </label>
                            <div id="dl-front-preview" class="mt-2 hidden">
                                <img src="" class="max-w-full h-40 mx-auto rounded-lg object-cover">
                                <button type="button" 
                                        onclick="removeImage('dl-front')"
                                        class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- DL Back Photo -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Driver's License (Back) *
                        </label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                            <input type="file" 
                                   id="dl-back-input" 
                                   accept="image/*" 
                                   capture="environment"
                                   required
                                   class="hidden"
                                   onchange="handleImageUpload(event, 'dl-back')">
                            <label for="dl-back-input" class="cursor-pointer block">
                                <div id="dl-back-upload-area">
                                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Click to upload or take photo *</p>
                                </div>
                            </label>
                            <div id="dl-back-preview" class="mt-2 hidden">
                                <img src="" class="max-w-full h-40 mx-auto rounded-lg object-cover">
                                <button type="button" 
                                        onclick="removeImage('dl-back')"
                                        class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Selfie Photo -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Selfie Photo *
                        </label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                            <input type="file" 
                                   id="selfie-input" 
                                   accept="image/*" 
                                   capture="user"
                                   required
                                   class="hidden"
                                   onchange="handleImageUpload(event, 'selfie')">
                            <label for="selfie-input" class="cursor-pointer block">
                                <div id="selfie-upload-area">
                                    <i class="fas fa-user-circle text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Click to take selfie *</p>
                                </div>
                            </label>
                            <div id="selfie-preview" class="mt-2 hidden">
                                <img src="" class="max-w-full h-40 mx-auto rounded-lg object-cover">
                                <button type="button" 
                                        onclick="removeImage('selfie')"
                                        class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Income Proof (Individual Only) -->
                    <div id="income-proof-section">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Weekly Earnings Proof *
                            <span class="text-xs text-gray-500 ml-2">(Screenshot from gig app)</span>
                        </label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                            <input type="file" 
                                   id="income-proof-input" 
                                   accept="image/*" 
                                   capture="environment"
                                   required
                                   class="hidden"
                                   onchange="handleImageUpload(event, 'income-proof')">
                            <label for="income-proof-input" class="cursor-pointer block">
                                <div id="income-proof-upload-area">
                                    <i class="fas fa-file-invoice-dollar text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Click to upload earnings proof *</p>
                                </div>
                            </label>
                            <div id="income-proof-preview" class="mt-2 hidden">
                                <img src="" class="max-w-full h-40 mx-auto rounded-lg object-cover">
                                <button type="button" 
                                        onclick="removeImage('income-proof')"
                                        class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" 
                    onclick="closeModal('add-customer')" 
                    class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                Cancel
            </button>
            <button type="submit" 
                    form="form-add-customer"
                    id="submit-add-customer"
                    class="px-6 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                <i class="fas fa-check mr-2"></i>
                <span id="submit-customer-text">Add Customer</span>
                <i class="fas fa-spinner fa-spin ml-2 hidden" id="submit-customer-spinner"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: START RENTAL -->
<!-- ============================================ -->
<div id="modal-start-rental" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-car-side text-fleetzy-green mr-2"></i>Start New Rental
            </h2>
            <button onclick="closeModal('start-rental')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="form-start-rental" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Customer Selection -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Customer <span class="text-red-500">*</span>
                    </label>
                    <select 
                        name="customer_id" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="">Select a customer...</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Choose an approved customer
                    </p>
                </div>

                <!-- Vehicle Selection -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Vehicle <span class="text-red-500">*</span>
                    </label>
                    <select 
                        name="vehicle_id" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="">Select a vehicle...</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Only available vehicles shown
                    </p>
                </div>

                <!-- Start Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Start Date <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        name="start_date" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Weekly Rate -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Weekly Rate <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                        <input 
                            type="number" 
                            name="weekly_rate" 
                            required 
                            step="0.01"
                            min="0"
                            value="400"
                            class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                </div>


                <!-- Deposit Amount -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Deposit Amount <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                        <input 
                            type="number" 
                            name="deposit_amount" 
                            required 
                            step="0.01"
                            min="0"
                            value="500"
                            class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                </div>

                <!-- Starting Mileage -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Starting Mileage <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="number" 
                        name="start_mileage" 
                        id="rental-start-mileage"
                        required 
                        min="0"
                        placeholder="Current odometer reading"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Payment Method
                    </label>
                    <select 
                        name="payment_method" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="zelle">Zelle</option>
                        <option value="cashapp">CashApp</option>
                        <option value="venmo">Venmo</option>
                        <option value="stripe">Stripe (Card)</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>

                <!-- Payment Summary -->
                <div class="col-span-2 bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-gray-800 dark:text-white">
                        <i class="fas fa-calculator text-fleetzy-green mr-2"></i>Payment Summary
                    </h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <span class="text-gray-600 dark:text-gray-400">Weekly Rate:</span>
                        <span class="text-right font-medium" id="summary-weekly-rate">$400.00</span>
                        <span class="text-gray-600 dark:text-gray-400">Deposit:</span>
                        <span class="text-right font-medium" id="summary-deposit">$500.00</span>
                        <div class="col-span-2 border-t border-gray-300 dark:border-gray-600 my-2"></div>
                        <span class="font-bold text-gray-800 dark:text-white">Total Due Today:</span>
                        <span class="text-right font-bold text-fleetzy-green text-lg" id="summary-total">$900.00</span>
                    </div>
                </div>

                <!-- Pickup Inspection Photos -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-camera text-fleetzy-green mr-2"></i>Pickup Inspection Photos
                    </label>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Take photos of the vehicle before handover (recommended)</p>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-front').click()">
                            <input type="file" id="pickup-photo-front" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'front')">
                            <div id="pickup-front-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-car text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Front</span>
                            </div>
                            <img id="pickup-front-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-back').click()">
                            <input type="file" id="pickup-photo-back" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'back')">
                            <div id="pickup-back-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-car text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Back</span>
                            </div>
                            <img id="pickup-back-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-driver').click()">
                            <input type="file" id="pickup-photo-driver" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'driver')">
                            <div id="pickup-driver-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-car-side text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Driver</span>
                            </div>
                            <img id="pickup-driver-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-passenger').click()">
                            <input type="file" id="pickup-photo-passenger" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'passenger')">
                            <div id="pickup-passenger-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-car-side text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Pass.</span>
                            </div>
                            <img id="pickup-passenger-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-interior').click()">
                            <input type="file" id="pickup-photo-interior" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'interior')">
                            <div id="pickup-interior-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-couch text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Interior</span>
                            </div>
                            <img id="pickup-interior-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                        <div class="photo-upload-box" onclick="document.getElementById('pickup-photo-odometer').click()">
                            <input type="file" id="pickup-photo-odometer" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'pickup', 'odometer')">
                            <div id="pickup-odometer-area" class="flex flex-col items-center justify-center h-full">
                                <i class="fas fa-tachometer-alt text-2xl text-gray-400 mb-1"></i>
                                <span class="text-xs text-gray-500">Odom.</span>
                            </div>
                            <img id="pickup-odometer-preview" class="hidden w-full h-full object-cover rounded">
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Pickup Notes
                    </label>
                    <textarea 
                        name="pickup_notes" 
                        rows="2"
                        placeholder="Any existing damage or notes about the vehicle..."
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green focus:border-transparent dark:bg-gray-700 dark:text-white"></textarea>
                </div>
            </div>
        </form>

        <!-- Modal Footer -->
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button 
                type="button" 
                onclick="closeModal('start-rental')" 
                class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                Cancel
            </button>
            <button 
                type="submit" 
                form="form-start-rental"
                id="btn-submit-rental"
                class="px-6 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                <span id="rental-submit-text">Start Rental</span>
                <i id="rental-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: RECORD PAYMENT -->
<!-- ============================================ -->
<div id="modal-record-payment" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-dollar-sign text-fleetzy-green mr-2"></i>Record Payment
            </h2>
            <button onclick="closeModal('record-payment')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="form-record-payment" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Select Rental <span class="text-red-500">*</span>
                </label>
                <select name="rental_id" id="payment-rental-select" required onchange="loadRentalPaymentInfo()" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    <option value="">Select active rental...</option>
                </select>
            </div>
            <div id="rental-payment-info" class="hidden bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Customer:</span>
                    <span id="payment-info-customer" class="font-medium">-</span>
                    <span class="text-gray-600 dark:text-gray-400">Vehicle:</span>
                    <span id="payment-info-vehicle" class="font-medium">-</span>
                    <span class="text-gray-600 dark:text-gray-400">Weekly Rate:</span>
                    <span id="payment-info-rate" class="font-medium">-</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount ($) <span class="text-red-500">*</span></label>
                    <input type="number" name="paid_amount" required step="0.01" min="0" placeholder="400.00" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Payment Date <span class="text-red-500">*</span></label>
                    <input type="date" name="paid_date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Payment Method <span class="text-red-500">*</span></label>
                <select name="payment_method" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    <option value="">Select method...</option>
                    <option value="zelle">Zelle</option>
                    <option value="cashapp">CashApp</option>
                    <option value="venmo">Venmo</option>
                    <option value="stripe">Stripe (Card)</option>
                    <option value="cash">Cash</option>
                    <option value="paypal">PayPal</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Payment Screenshot</label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                    <input type="file" id="payment-screenshot-input" accept="image/*" class="hidden" onchange="handlePaymentScreenshot(event)">
                    <label for="payment-screenshot-input" class="cursor-pointer block">
                        <div id="payment-screenshot-area">
                            <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Upload payment confirmation</p>
                        </div>
                    </label>
                    <div id="payment-screenshot-preview" class="hidden">
                        <img src="" class="max-w-full h-32 mx-auto rounded-lg object-cover">
                        <button type="button" onclick="removePaymentScreenshot()" class="mt-2 text-red-600 text-sm"><i class="fas fa-trash mr-1"></i>Remove</button>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
                <textarea name="notes" rows="2" placeholder="Any notes..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white"></textarea>
            </div>
        </form>
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" onclick="closeModal('record-payment')" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" form="form-record-payment" id="btn-submit-payment" class="px-6 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 flex items-center">
                <span id="payment-submit-text">Record Payment</span>
                <i id="payment-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: END RENTAL -->
<!-- ============================================ -->
<div id="modal-end-rental" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-flag-checkered text-red-500 mr-2"></i>End Rental
            </h2>
            <button onclick="closeModal('end-rental')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="form-end-rental" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Rental <span class="text-red-500">*</span></label>
                <select name="rental_id" id="end-rental-select" required onchange="loadRentalEndInfo()" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    <option value="">Select active rental...</option>
                </select>
            </div>
            <div id="end-rental-info" class="hidden bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><span class="text-gray-500 block">Customer</span><p id="end-info-customer" class="font-semibold">-</p></div>
                    <div><span class="text-gray-500 block">Vehicle</span><p id="end-info-vehicle" class="font-semibold">-</p></div>
                    <div><span class="text-gray-500 block">Start Date</span><p id="end-info-start-date" class="font-semibold">-</p></div>
                    <div><span class="text-gray-500 block">Deposit Held</span><p id="end-info-deposit" class="font-semibold text-green-600">-</p></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date <span class="text-red-500">*</span></label>
                    <input type="date" name="end_date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ending Mileage <span class="text-red-500">*</span></label>
                    <input type="number" name="end_mileage" required placeholder="Odometer reading" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"><i class="fas fa-camera text-red-500 mr-2"></i>Return Inspection Photos</label>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-front').click()">
                        <input type="file" id="return-photo-front" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'front')">
                        <div id="return-front-area"><i class="fas fa-car text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Front</span></div>
                        <img id="return-front-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-back').click()">
                        <input type="file" id="return-photo-back" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'back')">
                        <div id="return-back-area"><i class="fas fa-car text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Back</span></div>
                        <img id="return-back-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-driver').click()">
                        <input type="file" id="return-photo-driver" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'driver')">
                        <div id="return-driver-area"><i class="fas fa-car-side text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Driver</span></div>
                        <img id="return-driver-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-passenger').click()">
                        <input type="file" id="return-photo-passenger" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'passenger')">
                        <div id="return-passenger-area"><i class="fas fa-car-side text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Pass.</span></div>
                        <img id="return-passenger-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-interior').click()">
                        <input type="file" id="return-photo-interior" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'interior')">
                        <div id="return-interior-area"><i class="fas fa-couch text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Interior</span></div>
                        <img id="return-interior-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                    <div class="photo-upload-box" onclick="document.getElementById('return-photo-odometer').click()">
                        <input type="file" id="return-photo-odometer" accept="image/*" capture="environment" class="hidden" onchange="handleInspectionPhoto(event, 'return', 'odometer')">
                        <div id="return-odometer-area"><i class="fas fa-tachometer-alt text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-500">Odom.</span></div>
                        <img id="return-odometer-preview" class="hidden w-full h-full object-cover rounded">
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <label class="flex items-center"><input type="checkbox" name="has_damage" class="mr-3 w-5 h-5 text-fleetzy-green rounded" onchange="toggleDamageSection()"><span class="font-medium">Vehicle has new damage</span></label>
                <div id="damage-details-section" class="hidden mt-4 space-y-3">
                    <textarea name="damage_description" rows="2" placeholder="Describe the damage..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estimated Repair Cost ($)</label>
                        <input type="number" name="damage_cost" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h4 class="font-semibold mb-3"><i class="fas fa-hand-holding-usd text-green-500 mr-2"></i>Deposit Decision</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deposit Action <span class="text-red-500">*</span></label>
                        <select name="deposit_action" required onchange="updateDepositReturn()" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            <option value="return_full">Return Full Deposit</option>
                            <option value="return_partial">Return Partial (deduct damages)</option>
                            <option value="forfeit">Forfeit Entire Deposit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount to Return ($)</label>
                        <input type="number" name="deposit_return_amount" id="deposit-return-amount" step="0.01" placeholder="500.00" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Return Notes</label>
                <textarea name="return_notes" rows="2" placeholder="Any final notes..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
            </div>
        </form>
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" onclick="closeModal('end-rental')" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" form="form-end-rental" id="btn-submit-end-rental" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center">
                <span id="end-rental-submit-text">End Rental</span>
                <i id="end-rental-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: LOG EXPENSE -->
<!-- ============================================ -->
<div id="modal-log-expense" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-receipt text-orange-500 mr-2"></i>Log Expense
            </h2>
            <button onclick="closeModal('log-expense')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="form-log-expense" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vehicle <span class="text-red-500">*</span></label>
                <select name="vehicle_id" id="expense-vehicle-select" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    <option value="">Select vehicle...</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expense Type <span class="text-red-500">*</span></label>
                    <select name="expense_type" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="">Select type...</option>
                        <option value="maintenance">Maintenance/Repair</option>
                        <option value="oil_change">Oil Change</option>
                        <option value="tires">Tires</option>
                        <option value="insurance">Insurance</option>
                        <option value="registration">Registration</option>
                        <option value="car_wash">Car Wash/Detail</option>
                        <option value="fuel">Fuel</option>
                        <option value="towing">Towing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date <span class="text-red-500">*</span></label>
                    <input type="date" name="expense_date" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount ($) <span class="text-red-500">*</span></label>
                    <input type="number" name="amount" required step="0.01" min="0" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vendor</label>
                    <input type="text" name="vendor" placeholder="Triple 7 Roadside" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                <textarea name="description" rows="2" placeholder="Details about this expense..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Receipt Photo</label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-fleetzy-green transition-colors">
                    <input type="file" id="expense-receipt-input" accept="image/*" class="hidden" onchange="handleExpenseReceipt(event)">
                    <label for="expense-receipt-input" class="cursor-pointer block">
                        <div id="expense-receipt-area">
                            <i class="fas fa-receipt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Upload receipt</p>
                        </div>
                    </label>
                    <div id="expense-receipt-preview" class="hidden">
                        <img src="" class="max-w-full h-32 mx-auto rounded-lg object-cover">
                        <button type="button" onclick="removeExpenseReceipt()" class="mt-2 text-red-600 text-sm"><i class="fas fa-trash mr-1"></i>Remove</button>
                    </div>
                </div>
            </div>
        </form>
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" onclick="closeModal('log-expense')" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" form="form-log-expense" id="btn-submit-expense" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center">
                <span id="expense-submit-text">Log Expense</span>
                <i id="expense-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: EDIT VEHICLE -->
<!-- ============================================ -->
<div id="modal-edit-vehicle" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-edit text-fleetzy-green mr-2"></i>Edit Vehicle
            </h2>
            <button onclick="closeModal('edit-vehicle')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="form-edit-vehicle" class="p-6 space-y-6">
            <!-- Hidden field for vehicle ID -->
            <input type="hidden" name="id" id="edit-vehicle-id">
            
            <!-- Vehicle Header with Image -->
            <div class="flex items-start space-x-6">
                <div class="w-48 h-36 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden flex-shrink-0">
                    <img id="edit-vehicle-image" src="" class="w-full h-full object-cover" alt="Vehicle">
                </div>
                <div class="flex-1">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle ID</label>
                            <input type="text" id="edit-vehicle-display-id" disabled class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-400">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Friendly Name</label>
                            <input type="text" name="friendly_name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white" placeholder="e.g., White Camry #1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Basic Info Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-car text-fleetzy-green mr-2"></i>Vehicle Information
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
                        <input type="number" name="year" min="2000" max="2030" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Make</label>
                        <input type="text" name="make" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                        <input type="text" name="model" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                        <input type="text" name="color" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">VIN</label>
                        <input type="text" name="vin" maxlength="17" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white font-mono uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License Plate</label>
                        <input type="text" name="license_plate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                            <option value="Active">Active</option>
                            <option value="Maintenance">In Maintenance</option>
                            <option value="Retired">Retired</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Mileage & Service Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>Mileage & Service
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Mileage</label>
                        <input type="number" name="current_mileage" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Service Date</label>
                        <input type="date" name="last_service_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Service Mileage</label>
                        <input type="number" name="last_service_mileage" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Condition</label>
                        <select name="condition" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Financial Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-dollar-sign text-green-500 mr-2"></i>Financial Information
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monthly Payment ($)</label>
                        <input type="number" name="monthly_payment" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Insurance/Month ($)</label>
                        <input type="number" name="insurance_monthly" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">GPS Cost/Month ($)</label>
                        <input type="number" name="gps_cost_monthly" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Loan Amount ($)</label>
                        <input type="number" name="loan_amount" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
            </div>
            
            <!-- GPS & Tracking Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>GPS & Tracking
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">GPS Device ID</label>
                        <input type="text" name="gps_device_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Toll Tag ID</label>
                        <input type="text" name="toll_tag_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="flex items-center pt-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="gps_active" class="w-5 h-5 text-fleetzy-green rounded focus:ring-fleetzy-green">
                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">GPS Active</span>
                        </label>
                    </div>
                </div>
            </div>
        </form>
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button type="button" onclick="closeModal('edit-vehicle')" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Cancel</button>
            <button type="submit" form="form-edit-vehicle" id="btn-submit-edit-vehicle" class="px-6 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                <span id="edit-vehicle-submit-text">Save Changes</span>
                <i id="edit-vehicle-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: SERVICE HISTORY -->
<!-- ============================================ -->
<div id="modal-service-history" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-wrench text-orange-500 mr-2"></i>Service History
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="service-history-vehicle-name">Loading...</p>
            </div>
            <button onclick="closeModal('service-history')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Add Service Button -->
        <div class="px-6 pt-4">
            <button onclick="showAddServiceForm()" id="btn-show-add-service" class="px-4 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Add Service Record
            </button>
        </div>
        
        <!-- Add Service Form (Hidden by default) -->
        <div id="add-service-form-container" class="hidden px-6 py-4">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                <h4 class="font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-plus-circle text-fleetzy-green mr-2"></i>New Service Record
                </h4>
                <form id="form-add-service" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <input type="hidden" name="vehicle_id" id="add-service-vehicle-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Service Type <span class="text-red-500">*</span></label>
                        <select name="maintenance_type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                            <option value="">Select...</option>
                            <option value="Oil Change">Oil Change</option>
                            <option value="Tire Rotation">Tire Rotation</option>
                            <option value="Brake Service">Brake Service</option>
                            <option value="Transmission">Transmission Service</option>
                            <option value="State Inspection">State Inspection</option>
                            <option value="AC Service">AC Service</option>
                            <option value="Battery">Battery Replacement</option>
                            <option value="Tires">New Tires</option>
                            <option value="General Repair">General Repair</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date <span class="text-red-500">*</span></label>
                        <input type="date" name="actual_date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mileage <span class="text-red-500">*</span></label>
                        <input type="number" name="actual_mileage" required min="0" placeholder="105,600" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cost ($) <span class="text-red-500">*</span></label>
                        <input type="number" name="cost" required step="0.01" min="0" placeholder="75.00" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Service Provider</label>
                        <input type="text" name="service_provider" placeholder="Triple 7 Roadside" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                        <input type="text" name="notes" placeholder="Additional details..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-fleetzy-green dark:bg-gray-600 dark:text-white">
                    </div>
                    <div class="col-span-4 flex justify-end space-x-2 pt-2">
                        <button type="button" onclick="hideAddServiceForm()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                        <button type="submit" id="btn-submit-service" class="px-4 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                            <span id="add-service-submit-text">Add Service</span>
                            <i id="add-service-submit-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Service History Table -->
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Date</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Service Type</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Mileage</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Cost</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Provider</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Notes</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="service-history-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading service history...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Stats -->
            <div id="service-summary" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-gray-800 dark:text-white" id="service-total-count">0</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Services</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-green-600" id="service-total-cost">$0</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Spent</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-blue-600" id="service-last-date">-</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Last Service</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-2xl font-bold text-orange-600" id="service-avg-cost">$0</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Avg Cost/Service</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: VEHICLE EXPENSES -->
<!-- ============================================ -->
<div id="modal-vehicle-expenses" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-file-invoice-dollar text-green-600 mr-2"></i>Vehicle Expenses
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="vehicle-expenses-name">Loading...</p>
            </div>
            <button onclick="closeModal('vehicle-expenses')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Date Filter -->
        <div class="px-6 pt-4 flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label class="text-sm text-gray-600 dark:text-gray-400">From:</label>
                <input type="date" id="expense-filter-from" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm">
            </div>
            <div class="flex items-center space-x-2">
                <label class="text-sm text-gray-600 dark:text-gray-400">To:</label>
                <input type="date" id="expense-filter-to" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm">
            </div>
            <button onclick="filterVehicleExpenses()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-filter mr-1"></i>Filter
            </button>
            <button onclick="clearExpenseFilter()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm">
                Clear
            </button>
            <div class="flex-1"></div>
            <button onclick="openLogExpenseForVehicle()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Add Expense
            </button>
        </div>
        
        <!-- Expense Summary Cards -->
        <div class="px-6 py-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                    <p class="text-2xl font-bold" id="expense-total">$0</p>
                    <p class="text-sm opacity-80">Total Expenses</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                    <p class="text-2xl font-bold" id="expense-maintenance">$0</p>
                    <p class="text-sm opacity-80">Maintenance</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                    <p class="text-2xl font-bold" id="expense-fuel">$0</p>
                    <p class="text-sm opacity-80">Fuel</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-4 text-white">
                    <p class="text-2xl font-bold" id="expense-insurance">$0</p>
                    <p class="text-sm opacity-80">Insurance</p>
                </div>
                <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg p-4 text-white">
                    <p class="text-2xl font-bold" id="expense-other">$0</p>
                    <p class="text-sm opacity-80">Other</p>
                </div>
            </div>
        </div>
        
        <!-- Expenses Table -->
        <div class="p-6 pt-0">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Date</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Type</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Amount</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Vendor</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Description</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Receipt</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vehicle-expenses-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading expenses...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL: VEHICLE STATS -->
<!-- ============================================ -->
<div id="modal-vehicle-stats" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-chart-line text-purple-500 mr-2"></i>Vehicle Statistics
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="vehicle-stats-name">Loading...</p>
            </div>
            <button onclick="closeModal('vehicle-stats')" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Vehicle Overview Card -->
            <div class="flex items-start space-x-6 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6">
                <div class="w-56 h-40 bg-gray-200 dark:bg-gray-600 rounded-lg overflow-hidden flex-shrink-0">
                    <img id="stats-vehicle-image" src="" class="w-full h-full object-cover" alt="Vehicle">
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="stats-vehicle-title">Loading...</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-4" id="stats-vehicle-subtitle">Loading...</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Status</p>
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold" id="stats-vehicle-status">-</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Current Mileage</p>
                            <p class="text-lg font-bold text-gray-800 dark:text-white" id="stats-current-mileage">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Condition</p>
                            <p class="text-lg font-bold text-gray-800 dark:text-white" id="stats-condition">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-5 text-white">
                    <i class="fas fa-dollar-sign text-3xl opacity-50 mb-2"></i>
                    <p class="text-3xl font-bold" id="stats-total-revenue">$0</p>
                    <p class="text-sm opacity-80">Total Revenue</p>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-xl p-5 text-white">
                    <i class="fas fa-receipt text-3xl opacity-50 mb-2"></i>
                    <p class="text-3xl font-bold" id="stats-total-expenses">$0</p>
                    <p class="text-sm opacity-80">Total Expenses</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-5 text-white">
                    <i class="fas fa-chart-pie text-3xl opacity-50 mb-2"></i>
                    <p class="text-3xl font-bold" id="stats-net-profit">$0</p>
                    <p class="text-sm opacity-80">Net Profit</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl p-5 text-white">
                    <i class="fas fa-percentage text-3xl opacity-50 mb-2"></i>
                    <p class="text-3xl font-bold" id="stats-roi">0%</p>
                    <p class="text-sm opacity-80">ROI</p>
                </div>
            </div>
            
            <!-- Rental History & Performance -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Rental Stats -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                    <h4 class="font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-car-side text-fleetzy-green mr-2"></i>Rental Performance
                    </h4>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Total Rentals</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-total-rentals">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Days Rented (All Time)</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-days-rented">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Utilization Rate</span>
                            <span class="font-bold text-fleetzy-green" id="stats-utilization">0%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Avg Rental Duration</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-avg-duration">0 days</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Miles Driven (Total)</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-miles-driven">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Breakdown -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                    <h4 class="font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-coins text-orange-500 mr-2"></i>Cost Breakdown
                    </h4>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Purchase Price</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-purchase-price">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Loan Payments (Total)</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-loan-total">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Insurance (Total)</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-insurance-total">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Maintenance (Total)</span>
                            <span class="font-bold text-gray-800 dark:text-white" id="stats-maintenance-total">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Monthly Operating Cost</span>
                            <span class="font-bold text-orange-600" id="stats-monthly-cost">$0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Timeline -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                <h4 class="font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-history text-blue-500 mr-2"></i>Recent Activity
                </h4>
                <div id="stats-recent-activity" class="space-y-3">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading activity...</p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
            <button onclick="exportVehicleStats()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i class="fas fa-download mr-2"></i>Export Report
            </button>
            <button onclick="closeModal('vehicle-stats')" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">Close</button>
        </div>
    </div>
</div>

<style>
/* Photo upload boxes for inspection */
.photo-upload-box {
    aspect-ratio: 4/3;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}
.photo-upload-box:hover {
    border-color: #059669;
    background: rgba(5, 150, 105, 0.05);
}
.photo-upload-box.has-photo {
    border-style: solid;
    border-color: #059669;
}

/* Facebook Marketplace Styles */
.marketplace-section {
    display: none;
}
.marketplace-section.active {
    display: block;
}
.fb-blue { color: #1877f2; }
.template-card {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border: 2px solid #334155;
    border-radius: 16px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.template-card:hover, .template-card.selected {
    border-color: #10b981;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
}
.template-card.selected {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
}
.output-box {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 20px;
    font-family: 'DM Sans', monospace;
    white-space: pre-wrap;
    line-height: 1.6;
    max-height: 300px;
    overflow-y: auto;
}
.copy-btn {
    background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}
.copy-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Sidebar Styles */
.sidebar {
    width: 250px;
    min-height: calc(100vh - 64px);
    background: white;
    border-right: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}
.dark .sidebar {
    background: #1f2937;
    border-color: #374151;
}
.sidebar-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 3px solid transparent;
}
.sidebar-item:hover {
    background: #f3f4f6;
    color: #059669;
}
.dark .sidebar-item:hover {
    background: #374151;
}
.sidebar-item.active {
    background: #ecfdf5;
    color: #059669;
    border-left-color: #059669;
    font-weight: 600;
}
.dark .sidebar-item.active {
    background: rgba(5, 150, 105, 0.1);
}
.sidebar-item i {
    width: 24px;
    margin-right: 12px;
}
.main-content {
    flex: 1;
    min-width: 0;
}
.content-section {
    display: none;
}
.content-section.active {
    display: block;
}

    </style>

<script>
// Global variables for this form
let vehiclePhotoFile = null;

// Populate year dropdown (2015-2025)
document.addEventListener('DOMContentLoaded', () => {
    const yearSelect = document.querySelector('#form-add-vehicle select[name="year"]');
    const currentYear = new Date().getFullYear();
    for (let year = currentYear; year >= 2015; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
});

// Handle vehicle photo upload
function handleVehiclePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Photo must be less than 5MB', 'error');
        event.target.value = '';
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        event.target.value = '';
        return;
    }
    
    vehiclePhotoFile = file;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('photo-upload-area').classList.add('hidden');
        const preview = document.getElementById('vehicle-photo-preview');
        preview.classList.remove('hidden');
        preview.querySelector('img').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Remove vehicle photo
function removeVehiclePhoto() {
    vehiclePhotoFile = null;
    document.getElementById('vehicle-photo-input').value = '';
    document.getElementById('vehicle-photo-preview').classList.add('hidden');
    document.getElementById('photo-upload-area').classList.remove('hidden');
}

// Validate VIN format
async function validateVIN(input) {
    const vin = input.value.toUpperCase();
    input.value = vin;
    
    const vinError = document.getElementById('vin-error');
    const duplicateError = document.getElementById('vin-duplicate-error');
    
    // Hide both errors first
    vinError.classList.add('hidden');
    duplicateError.classList.add('hidden');
    
    // Check length
    if (vin.length > 0 && vin.length !== 17) {
        vinError.classList.remove('hidden');
        return false;
    }
    
    // Check if VIN already exists in database
    if (vin.length === 17) {
        const { data, error } = await db
            .from('vehicles')
            .select('vin')
            .eq('vin', vin)
            .single();
        
        if (data) {
            duplicateError.classList.remove('hidden');
            return false;
        }
    }
    
    return true;
}

// Generate next vehicle ID (V-001, V-002, etc.)
async function generateVehicleId() {
    const { data, error } = await db
        .from('vehicles')
        .select('vehicle_id')
        .order('created_at', { ascending: false })
        .limit(1);
    
    if (error || !data || data.length === 0) {
        return 'V-001';
    }
    
    const lastId = data[0].vehicle_id;
    const match = lastId.match(/V-(\d+)/);
    if (match) {
        const nextNum = parseInt(match[1]) + 1;
        return `V-${nextNum.toString().padStart(3, '0')}`;
    }
    
    return 'V-001';
}

// Upload vehicle photo to Supabase Storage
async function uploadVehiclePhoto(vehicleId) {
    if (!vehiclePhotoFile) {
        throw new Error('No photo file selected');
    }
    
    // Create unique filename
    const fileExt = vehiclePhotoFile.name.split('.').pop();
    const fileName = `${vehicleId}.${fileExt}`;
    const filePath = fileName;
    
    // Upload to Supabase Storage (vehicle-images bucket)
    const { data, error } = await db.storage
        .from('vehicle-images')
        .upload(filePath, vehiclePhotoFile, {
            cacheControl: '3600',
            upsert: true
        });
    
    if (error) {
        throw error;
    }
    
    // Get public URL
    const { data: urlData } = db.storage
        .from('vehicle-images')
        .getPublicUrl(filePath);
    
    return urlData.publicUrl;
}

// Form submission handler
document.getElementById('form-add-vehicle').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validate photo is uploaded
    if (!vehiclePhotoFile) {
        showToast('Please upload a vehicle photo', 'error');
        return;
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('submit-add-vehicle');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Adding Vehicle...';
    submitSpinner.classList.remove('hidden');
    
    try {
        // Collect form data
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Validate VIN one more time
        const vinValid = await validateVIN(document.querySelector('input[name="vin"]'));
        if (!vinValid) {
            throw new Error('Please fix VIN errors before submitting');
        }
        
        // Generate vehicle ID
        const vehicleId = await generateVehicleId();
        
        // Upload photo first
        showToast('Uploading vehicle photo...', 'info');
        const photoUrl = await uploadVehiclePhoto(vehicleId);
        
        // Prepare data for database with CORRECT column names
        const vehicleData = {
            vehicle_id: vehicleId,
            friendly_name: data.friendly_name.trim(),
            year: parseInt(data.year),
            make: data.make.trim(),
            model: data.model.trim(),
            vin: data.vin.toUpperCase().trim(),
            color: data.color || null,
            license_plate: data.license_plate ? data.license_plate.toUpperCase().trim() : null,
            condition: data.condition || null,
            purchase_date: data.purchase_date,
            purchase_price: parseFloat(data.purchase_price),
            monthly_payment: parseFloat(data.monthly_payment),
            down_payment: data.down_payment ? parseFloat(data.down_payment) : null,
            loan_amount: data.loan_amount ? parseFloat(data.loan_amount) : null,
            initial_prep_cost: data.initial_prep_cost ? parseFloat(data.initial_prep_cost) : null,
            current_mileage: data.current_mileage ? parseInt(data.current_mileage) : null,
            last_service_mileage: data.last_service_mileage ? parseInt(data.last_service_mileage) : null,
            last_service_date: data.last_service_date || null,
            gps_device_id: data.gps_device_id ? data.gps_device_id.trim() : null,
            gps_cost_monthly: data.gps_cost_monthly ? parseFloat(data.gps_cost_monthly) : 25.00,
            gps_active: true,
            toll_tag_id: data.toll_tag_id ? data.toll_tag_id.trim() : null,
            insurance_monthly: parseFloat(data.insurance_monthly),
            registration_cost: data.registration_cost ? parseFloat(data.registration_cost) : null,
            status: 'Active',
            image_url: photoUrl,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        // Insert into database
        const { data: insertedVehicle, error: insertError } = await db
            .from('vehicles')
            .insert([vehicleData])
            .select()
            .single();
        
        if (insertError) {
            throw insertError;
        }
        
        // Success!
        showToast(`Vehicle ${vehicleId} added successfully! âœ“`, 'success');
        
        // Close modal and reset form
        closeModal('add-vehicle');
        e.target.reset();
        removeVehiclePhoto();
        
        // Refresh dashboard data
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error adding vehicle:', error);
        showToast(error.message || 'Error adding vehicle. Please try again.', 'error');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitText.textContent = 'Add Vehicle';
        submitSpinner.classList.add('hidden');
    }
});


// Close modal when clicking backdrop
document.getElementById('modal-add-vehicle').addEventListener('click', (e) => {
    if (e.target.id === 'modal-add-vehicle') {
        closeModal('add-vehicle');
    }
});

// ========================================
// FORM #2: ADD CUSTOMER - JAVASCRIPT
// ========================================

// Global variables for customer form
let customerImages = {
    dlFront: null,
    dlBack: null,
    selfie: null,
    incomeProof: null
};

// Toggle between Individual and Corporate customer types
function toggleCustomerType() {
    const isCompany = document.getElementById('is-company-rental').checked;
    const companySection = document.getElementById('company-info-section');
    const incomeSection = document.getElementById('income-proof-section');
    const personalInfoTitle = document.getElementById('personal-info-title');
    const incomeProofInput = document.getElementById('income-proof-input');
    
    // Get company fields
    const companyFields = [
        document.querySelector('input[name="company_name"]'),
        document.querySelector('input[name="company_contact_person"]'),
        document.querySelector('input[name="company_phone"]'),
        document.querySelector('input[name="company_email"]')
    ];
    
    if (isCompany) {
        // Corporate mode
        companySection.classList.remove('hidden');
        incomeSection.classList.add('hidden');
        personalInfoTitle.textContent = 'Driver Information';
        incomeProofInput.required = false;
        
        // Make company fields required
        companyFields.forEach(field => {
            if (field) field.required = true;
        });
    } else {
        // Individual mode
        companySection.classList.add('hidden');
        incomeSection.classList.remove('hidden');
        personalInfoTitle.textContent = 'Personal Information';
        incomeProofInput.required = true;
        
        // Make company fields optional
        companyFields.forEach(field => {
            if (field) field.required = false;
        });
    }
}

// Handle image upload
function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Photo must be less than 5MB', 'error');
        event.target.value = '';
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showToast('Please upload an image file', 'error');
        event.target.value = '';
        return;
    }
    
    // Store file
    const typeMap = {
        'dl-front': 'dlFront',
        'dl-back': 'dlBack',
        'selfie': 'selfie',
        'income-proof': 'incomeProof'
    };
    customerImages[typeMap[type]] = file;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById(`${type}-upload-area`).classList.add('hidden');
        const preview = document.getElementById(`${type}-preview`);
        preview.classList.remove('hidden');
        preview.querySelector('img').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Remove image
function removeImage(type) {
    const typeMap = {
        'dl-front': 'dlFront',
        'dl-back': 'dlBack',
        'selfie': 'selfie',
        'income-proof': 'incomeProof'
    };
    customerImages[typeMap[type]] = null;
    
    document.getElementById(`${type}-input`).value = '';
    document.getElementById(`${type}-preview`).classList.add('hidden');
    document.getElementById(`${type}-upload-area`).classList.remove('hidden');
}

// Generate customer ID
async function generateCustomerId() {
    const { data, error } = await db
        .from('customers')
        .select('customer_id')
        .order('created_at', { ascending: false })
        .limit(1);
    
    if (error) {
        console.error('Error fetching last customer:', error);
        return 'C001';
    }
    
    if (!data || data.length === 0) {
        return 'C001';
    }
    
    const lastId = data[0].customer_id;
    if (!lastId) return 'C001';
    
    const numericPart = parseInt(lastId.substring(1));
    const nextNumber = numericPart + 1;
    return `C${String(nextNumber).padStart(3, '0')}`;
}

// Upload image to Supabase Storage
async function uploadCustomerImage(customerId, file, type) {
    if (!file) return null;
    
    const bucketMap = {
        dlFront: 'drivers-licenses',
        dlBack: 'drivers-licenses',
        selfie: 'selfies',
        incomeProof: 'income-proofs'
    };
    
    const fileNameMap = {
        dlFront: `${customerId}_dl_front`,
        dlBack: `${customerId}_dl_back`,
        selfie: `${customerId}_selfie`,
        incomeProof: `${customerId}_income`
    };
    
    const bucket = bucketMap[type];
    const fileExt = file.name.split('.').pop();
    const fileName = `${fileNameMap[type]}.${fileExt}`;
    
    const { data, error } = await db.storage
        .from(bucket)
        .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
        });
    
    if (error) {
        throw error;
    }
    
    const { data: urlData } = db.storage
        .from(bucket)
        .getPublicUrl(fileName);
    
    return urlData.publicUrl;
}

// Create GHL contact
async function createGHLContact(customerData) {
    try {
        // Extract first and last name from full name
        const nameParts = customerData.full_name.trim().split(' ');
        const firstName = nameParts[0];
        const lastName = nameParts.slice(1).join(' ') || firstName;
        
        const response = await fetch('https://services.leadconnectorhq.com/contacts/', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer pit-4d55d16a-38d4-47ef-ba74-ba3f6327a4b0',
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
            },
            body: JSON.stringify({
                firstName: firstName,
                lastName: lastName,
                email: customerData.email,
                phone: customerData.phone,
                tags: ['customer', customerData.is_company_rental ? 'corporate' : 'individual']
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to create GHL contact');
        }
        
        const result = await response.json();
        return result.contact.id;
        
    } catch (error) {
        console.error('Error creating GHL contact:', error);
        return null; // Continue even if GHL creation fails
    }
}

// Form submission handler
document.getElementById('form-add-customer').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const isCompany = document.getElementById('is-company-rental').checked;
    
    // Validate required images
    if (!customerImages.dlFront) {
        showToast('Please upload driver\'s license front photo', 'error');
        return;
    }
    if (!customerImages.dlBack) {
        showToast('Please upload driver\'s license back photo', 'error');
        return;
    }
    if (!customerImages.selfie) {
        showToast('Please upload selfie photo', 'error');
        return;
    }
    if (!isCompany && !customerImages.incomeProof) {
        showToast('Please upload income proof (required for individual customers)', 'error');
        return;
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('submit-add-customer');
    const submitText = document.getElementById('submit-customer-text');
    const submitSpinner = document.getElementById('submit-customer-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Adding Customer...';
    submitSpinner.classList.remove('hidden');
    
    try {
        // Collect form data
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Generate customer ID
        const customerId = await generateCustomerId();
        
        // Upload images
        showToast('Uploading documents...', 'info');
        
        const [dlFrontUrl, dlBackUrl, selfieUrl, incomeProofUrl] = await Promise.all([
            uploadCustomerImage(customerId, customerImages.dlFront, 'dlFront'),
            uploadCustomerImage(customerId, customerImages.dlBack, 'dlBack'),
            uploadCustomerImage(customerId, customerImages.selfie, 'selfie'),
            !isCompany ? uploadCustomerImage(customerId, customerImages.incomeProof, 'incomeProof') : null
        ]);
        
        // Create GHL contact
        showToast('Creating contact...', 'info');
        const ghlContactId = await createGHLContact({
            full_name: data.full_name,
            email: data.email,
            phone: data.phone,
            is_company_rental: isCompany
        });
        
        // Prepare customer data with EXACT column names
        const customerData = {
            customer_id: customerId,
            ghl_contact_id: ghlContactId,
            full_name: data.full_name.trim(),
            phone: data.phone.trim(),
            email: data.email.trim(),
            date_of_birth: data.date_of_birth || null,
            current_address: data.current_address ? data.current_address.trim() : null,
            dl_number: data.dl_number.toUpperCase().trim(),
            dl_state: data.dl_state,
            dl_expiry_date: data.dl_expiry_date || null,
            dl_photo_front_url: dlFrontUrl,
            dl_photo_back_url: dlBackUrl,
            selfie_url: selfieUrl,
            gig_platform: data.gig_platform || null,
            gig_rating: data.gig_rating ? parseFloat(data.gig_rating) : null,
            weekly_earnings_proof_url: incomeProofUrl,
            is_company_rental: isCompany,
            application_type: isCompany ? 'company' : 'self',
            company_name: isCompany ? data.company_name.trim() : null,
            company_contact_person: isCompany ? data.company_contact_person.trim() : null,
            company_phone: isCompany ? data.company_phone.trim() : null,
            company_email: isCompany ? data.company_email.trim() : null,
            status: 'Pending',
            background_check_status: 'pending',
            mvr_status: 'pending',
            deposit_amount: 500.00,
            deposit_status: 'held',
            deposit_balance: 500.00,
            payment_reliability_score: 5.00,
            vehicle_care_rating: 5.00,
            late_payment_count: 0,
            contract_signed: false,
            verification_completed: false,
            email_verified: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        // Insert into database
        const { data: insertedCustomer, error: insertError } = await db
            .from('customers')
            .insert([customerData])
            .select()
            .single();
        
        if (insertError) {
            throw insertError;
        }
        
        // Success!
        showToast(`Customer ${customerId} added successfully! âœ“`, 'success');
        
        // Close modal and reset form
        closeModal('add-customer');
        e.target.reset();
        
        // Reset images
        customerImages = {
            dlFront: null,
            dlBack: null,
            selfie: null,
            incomeProof: null
        };
        
        // Reset all image previews
        ['dl-front', 'dl-back', 'selfie', 'income-proof'].forEach(type => {
            const preview = document.getElementById(`${type}-preview`);
            const uploadArea = document.getElementById(`${type}-upload-area`);
            if (preview) preview.classList.add('hidden');
            if (uploadArea) uploadArea.classList.remove('hidden');
        });
        
        // Reset toggle
        document.getElementById('is-company-rental').checked = false;
        toggleCustomerType();
        
        // Refresh dashboard data
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error adding customer:', error);
        showToast(error.message || 'Error adding customer. Please try again.', 'error');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitText.textContent = 'Add Customer';
        submitSpinner.classList.add('hidden');
    }
});

// Close modal when clicking backdrop
document.getElementById('modal-add-customer').addEventListener('click', (e) => {
    if (e.target.id === 'modal-add-customer') {
        closeModal('add-customer');
    }
});

// End of existing handlers from backup


// ===========================
// NEW MODAL HANDLERS
// ===========================

// Global state for new forms
let inspectionPhotos = { pickup: {}, return: {} };
let paymentScreenshotFile = null;
let expenseReceiptFile = null;
let allRentalsCache = [];
let allVehiclesCache = [];

// Open modal helper (extend existing)
function openModal(modalName) {
    const modal = document.getElementById(`modal-${modalName}`);
    if (modal) {
        modal.classList.remove('hidden');
        // Load data for specific modals
        if (modalName === 'start-rental') loadStartRentalData();
        if (modalName === 'record-payment') loadPaymentFormData();
        if (modalName === 'end-rental') loadEndRentalFormData();
        if (modalName === 'log-expense') loadExpenseFormData();
    }
}

// Close modal helper (extend existing)
function closeModal(modalName) {
    const modal = document.getElementById(`modal-${modalName}`);
    if (modal) {
        modal.classList.add('hidden');
        // Reset form if exists
        const form = modal.querySelector('form');
        if (form) form.reset();
    }
}

// ===========================
// START RENTAL HANDLERS
// ===========================
async function loadStartRentalData() {
    try {
        // Load approved customers
        const { data: customers } = await db.from('customers').select('*').or('application_status.eq.approved,status.eq.approved');
        const customerSelect = document.querySelector('#form-start-rental select[name="customer_id"]');
        customerSelect.innerHTML = '<option value="">Select a customer...</option>' +
            (customers || []).map(c => `<option value="${c.id}">${c.full_name || c.first_name + ' ' + (c.last_name || '')} - ${c.phone || ''}</option>`).join('');
        
        // Load available vehicles
        const { data: vehicles } = await db.from('vehicles').select('*').or('status.eq.Active,status.eq.active');
        const { data: activeRentals } = await db.from('rentals').select('vehicle_id').eq('rental_status', 'active');
        const rentedVehicleIds = (activeRentals || []).map(r => r.vehicle_id);
        const availableVehicles = (vehicles || []).filter(v => !rentedVehicleIds.includes(v.id));
        
        allVehiclesCache = vehicles || [];
        
        const vehicleSelect = document.querySelector('#form-start-rental select[name="vehicle_id"]');
        vehicleSelect.innerHTML = '<option value="">Select a vehicle...</option>' +
            availableVehicles.map(v => `<option value="${v.id}" data-rate="${v.weekly_rental_rate || 400}" data-mileage="${v.current_mileage || 0}">${v.year} ${v.make} ${v.model} - ${v.license_plate || 'No plate'}</option>`).join('');
        
        // Set default date
        document.querySelector('#form-start-rental input[name="start_date"]').value = new Date().toISOString().split('T')[0];
        
        // Add change listener for vehicle selection
        vehicleSelect.onchange = function() {
            const option = this.options[this.selectedIndex];
            if (option.dataset.rate) {
                document.querySelector('#form-start-rental input[name="weekly_rate"]').value = option.dataset.rate;
                document.getElementById('rental-start-mileage').value = option.dataset.mileage || '';
                updateRentalSummary();
            }
        };
        
        // Add listeners for summary calculation
        ['weekly_rate', 'deposit_amount'].forEach(field => {
            const input = document.querySelector(`#form-start-rental input[name="${field}"]`);
            if (input) input.onchange = updateRentalSummary;
        });
        
        updateRentalSummary();
    } catch (error) {
        console.error('Error loading rental data:', error);
        showToast('Error loading form data', 'error');
    }
}

function updateRentalSummary() {
    const rate = parseFloat(document.querySelector('#form-start-rental input[name="weekly_rate"]')?.value) || 400;
    const deposit = parseFloat(document.querySelector('#form-start-rental input[name="deposit_amount"]')?.value) || 500;
    
    document.getElementById('summary-weekly-rate').textContent = '$' + rate.toFixed(2);
    document.getElementById('summary-deposit').textContent = '$' + deposit.toFixed(2);
    document.getElementById('summary-total').textContent = '$' + (rate + deposit).toFixed(2);
}

// Handle inspection photo uploads
function handleInspectionPhoto(event, type, position) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!inspectionPhotos[type]) inspectionPhotos[type] = {};
    inspectionPhotos[type][position] = file;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const areaId = `${type}-${position}-area`;
        const previewId = `${type}-${position}-preview`;
        const area = document.getElementById(areaId);
        const preview = document.getElementById(previewId);
        
        if (area) area.classList.add('hidden');
        if (preview) {
            preview.classList.remove('hidden');
            preview.src = e.target.result;
            preview.parentElement.classList.add('has-photo');
        }
    };
    reader.readAsDataURL(file);
}

// Upload file to Supabase storage
async function uploadToStorage(bucket, file, folder = '') {
    const timestamp = Date.now();
    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const path = folder ? `${folder}/${timestamp}_${safeName}` : `${timestamp}_${safeName}`;
    
    const { data, error } = await db.storage.from(bucket).upload(path, file);
    if (error) throw error;
    
    const { data: urlData } = db.storage.from(bucket).getPublicUrl(path);
    return urlData.publicUrl;
}

// Start Rental form submission
document.getElementById('form-start-rental').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-rental');
    const submitText = document.getElementById('rental-submit-text');
    const submitSpinner = document.getElementById('rental-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Starting...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Generate rental ID
        const { count } = await db.from('rentals').select('*', { count: 'exact', head: true });
        data.rental_id = `R-${String((count || 0) + 1).padStart(3, '0')}`;
        data.rental_status = 'active';
        
        // Convert numeric fields
        data.weekly_rate = parseFloat(data.weekly_rate);
        data.deposit_amount = parseFloat(data.deposit_amount);
        data.start_mileage = parseInt(data.start_mileage);
        
        // Calculate next payment due (7 days from start)
        const startDate = new Date(data.start_date);
        const nextPaymentDue = new Date(startDate);
        nextPaymentDue.setDate(nextPaymentDue.getDate() + 7);
        data.next_payment_due = nextPaymentDue.toISOString().split('T')[0];
        
        // Upload inspection photos
        const photos = {};
        for (const [position, file] of Object.entries(inspectionPhotos.pickup || {})) {
            if (file) {
                photos[position] = await uploadToStorage('inspection_photos', file, `pickup_${data.rental_id}`);
            }
        }
        if (Object.keys(photos).length > 0) {
            data.pickup_photos = photos;
        }
        
        // Insert rental
        const { error: rentalError } = await db.from('rentals').insert([data]);
        if (rentalError) throw rentalError;
        
        // Update vehicle status
        await db.from('vehicles').update({ status: 'rented' }).eq('id', data.vehicle_id);
        
        showToast('Rental started successfully! ðŸš—', 'success');
        closeModal('start-rental');
        inspectionPhotos.pickup = {};
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error starting rental:', error);
        showToast(error.message || 'Error starting rental', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Start Rental';
        submitSpinner.classList.add('hidden');
    }
});

// ===========================
// RECORD PAYMENT HANDLERS
// ===========================
async function loadPaymentFormData() {
    try {
        const { data: rentals } = await db.from('rentals').select('*, customers(*), vehicles(*)').eq('rental_status', 'active');
        allRentalsCache = rentals || [];
        
        const select = document.getElementById('payment-rental-select');
        select.innerHTML = '<option value="">Select active rental...</option>' +
            (rentals || []).map(r => {
                const customerName = r.customers ? (r.customers.full_name || r.customers.first_name) : 'Unknown';
                const vehicleInfo = r.vehicles ? `${r.vehicles.year} ${r.vehicles.make}` : 'Unknown';
                return `<option value="${r.id}" data-customer="${customerName}" data-vehicle="${vehicleInfo}" data-rate="${r.weekly_rate}">${customerName} - ${vehicleInfo}</option>`;
            }).join('');
        
        document.querySelector('#form-record-payment input[name="paid_date"]').value = new Date().toISOString().split('T')[0];
    } catch (error) {
        console.error('Error loading payment data:', error);
    }
}

function loadRentalPaymentInfo() {
    const select = document.getElementById('payment-rental-select');
    const option = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('rental-payment-info');
    
    if (option && option.value) {
        document.getElementById('payment-info-customer').textContent = option.dataset.customer;
        document.getElementById('payment-info-vehicle').textContent = option.dataset.vehicle;
        document.getElementById('payment-info-rate').textContent = '$' + option.dataset.rate + '/week';
        infoDiv.classList.remove('hidden');
    } else {
        infoDiv.classList.add('hidden');
    }
}

function handlePaymentScreenshot(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    paymentScreenshotFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('payment-screenshot-area').classList.add('hidden');
        const preview = document.getElementById('payment-screenshot-preview');
        preview.classList.remove('hidden');
        preview.querySelector('img').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function removePaymentScreenshot() {
    paymentScreenshotFile = null;
    document.getElementById('payment-screenshot-input').value = '';
    document.getElementById('payment-screenshot-area').classList.remove('hidden');
    document.getElementById('payment-screenshot-preview').classList.add('hidden');
}

// Record Payment form submission
document.getElementById('form-record-payment').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-payment');
    const submitText = document.getElementById('payment-submit-text');
    const submitSpinner = document.getElementById('payment-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Recording...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Generate payment ID
        const { count } = await db.from('payments').select('*', { count: 'exact', head: true });
        data.payment_id = `P-${String((count || 0) + 1).padStart(3, '0')}`;
        data.payment_status = 'confirmed';
        data.paid_amount = parseFloat(data.paid_amount);
        
        // Upload screenshot if exists
        if (paymentScreenshotFile) {
            data.screenshot_url = await uploadToStorage('payment-screenshots', paymentScreenshotFile, data.payment_id);
        }
        
        // Get rental info for customer_id
        const rental = allRentalsCache.find(r => r.id === data.rental_id);
        if (rental) {
            data.customer_id = rental.customer_id;
            
            // Update rental next payment due
            const nextDue = new Date(rental.next_payment_due || new Date());
            nextDue.setDate(nextDue.getDate() + 7);
            await db.from('rentals').update({ 
                next_payment_due: nextDue.toISOString().split('T')[0],
                last_payment_date: data.paid_date
            }).eq('id', data.rental_id);
        }
        
        const { error } = await db.from('payments').insert([data]);
        if (error) throw error;
        
        showToast('Payment recorded successfully! ðŸ’°', 'success');
        closeModal('record-payment');
        paymentScreenshotFile = null;
        
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error recording payment:', error);
        showToast(error.message || 'Error recording payment', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Record Payment';
        submitSpinner.classList.add('hidden');
    }
});

// ===========================
// QUICK END RENTAL (From Dashboard)
// ===========================
async function quickEndRental(rentalId) {
    if (!confirm('Are you sure you want to end this rental?\n\nThis will mark the rental as completed and make the vehicle available again.')) return;
    
    try {
        // Get the rental details first
        const { data: rental, error: fetchError } = await db
            .from('rentals')
            .select('*, customers(*), vehicles(*)')
            .eq('id', rentalId)
            .single();
        
        if (fetchError) throw fetchError;
        
        const customerName = rental.customers ? (rental.customers.full_name || `${rental.customers.first_name} ${rental.customers.last_name}`) : 'Unknown';
        const vehicleInfo = rental.vehicles ? `${rental.vehicles.year} ${rental.vehicles.make} ${rental.vehicles.model}` : 'Unknown';
        
        // Ask for end mileage
        const endMileage = prompt(`Enter the ending mileage for ${vehicleInfo}:`, rental.vehicles?.current_mileage || '');
        if (endMileage === null) return;
        
        // Update rental to completed
        const { error: updateError } = await db
            .from('rentals')
            .update({
                rental_status: 'completed',
                end_date: new Date().toISOString().split('T')[0],
                end_mileage: endMileage ? parseInt(endMileage) : null,
                updated_at: new Date().toISOString()
            })
            .eq('id', rentalId);
        
        if (updateError) throw updateError;
        
        // Update vehicle status back to Active
        if (rental.vehicle_id) {
            const vehicleUpdate = { 
                status: 'Active',
                updated_at: new Date().toISOString()
            };
            if (endMileage) {
                vehicleUpdate.current_mileage = parseInt(endMileage);
            }
            await db.from('vehicles').update(vehicleUpdate).eq('id', rental.vehicle_id);
        }
        
        // Update customer to not active renter
        if (rental.customer_id) {
            await db.from('customers').update({ 
                is_active_renter: false,
                updated_at: new Date().toISOString()
            }).eq('id', rental.customer_id);
        }
        
        showToast(`Rental for ${customerName} ended successfully! âœ“`, 'success');
        
        // Refresh dashboard, customers, and rentals tabs
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        if (typeof loadCustomersTab === 'function') {
            await loadCustomersTab();
        }
        if (typeof loadRentalsTab === 'function') {
            await loadRentalsTab();
        }
        
    } catch (error) {
        console.error('Error ending rental:', error);
        showToast('Error ending rental: ' + (error.message || 'Unknown error'), 'error');
    }
}

// End rental from customer row (finds rental by customer_id)
async function endCustomerRental(customerId) {
    try {
        // Find active rental for this customer
        const { data: rentals, error: fetchError } = await db
            .from('rentals')
            .select('*, customers(*), vehicles(*)')
            .eq('customer_id', customerId)
            .eq('rental_status', 'active')
            .limit(1);
        
        if (fetchError) throw fetchError;
        
        if (!rentals || rentals.length === 0) {
            showToast('No active rental found for this customer.', 'warning');
            return;
        }
        
        // Use quickEndRental with the found rental
        await quickEndRental(rentals[0].id);
        
    } catch (error) {
        console.error('Error finding customer rental:', error);
        showToast('Error finding rental: ' + (error.message || 'Unknown error'), 'error');
    }
}

// ===========================
// END RENTAL HANDLERS
// ===========================
async function loadEndRentalFormData() {
    try {
        const { data: rentals } = await db.from('rentals').select('*, customers(*), vehicles(*)').eq('rental_status', 'active');
        allRentalsCache = rentals || [];
        
        const select = document.getElementById('end-rental-select');
        select.innerHTML = '<option value="">Select active rental...</option>' +
            (rentals || []).map(r => {
                const customerName = r.customers ? (r.customers.full_name || r.customers.first_name) : 'Unknown';
                const vehicleInfo = r.vehicles ? `${r.vehicles.year} ${r.vehicles.make} ${r.vehicles.model}` : 'Unknown';
                return `<option value="${r.id}" data-customer="${customerName}" data-vehicle="${vehicleInfo}" data-start="${r.start_date}" data-deposit="${r.deposit_amount || 500}">${customerName} - ${vehicleInfo}</option>`;
            }).join('');
        
        document.querySelector('#form-end-rental input[name="end_date"]').value = new Date().toISOString().split('T')[0];
    } catch (error) {
        console.error('Error loading end rental data:', error);
    }
}

function loadRentalEndInfo() {
    const select = document.getElementById('end-rental-select');
    const option = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('end-rental-info');
    
    if (option && option.value) {
        document.getElementById('end-info-customer').textContent = option.dataset.customer;
        document.getElementById('end-info-vehicle').textContent = option.dataset.vehicle;
        document.getElementById('end-info-start-date').textContent = option.dataset.start;
        document.getElementById('end-info-deposit').textContent = '$' + option.dataset.deposit;
        document.getElementById('deposit-return-amount').value = option.dataset.deposit;
        infoDiv.classList.remove('hidden');
    } else {
        infoDiv.classList.add('hidden');
    }
}

function toggleDamageSection() {
    const hasDamage = document.querySelector('#form-end-rental input[name="has_damage"]').checked;
    document.getElementById('damage-details-section').classList.toggle('hidden', !hasDamage);
    if (hasDamage) {
        document.querySelector('#form-end-rental select[name="deposit_action"]').value = 'return_partial';
    }
}

function updateDepositReturn() {
    const action = document.querySelector('#form-end-rental select[name="deposit_action"]').value;
    const select = document.getElementById('end-rental-select');
    const option = select.options[select.selectedIndex];
    const fullDeposit = parseFloat(option?.dataset?.deposit || 500);
    
    if (action === 'return_full') {
        document.getElementById('deposit-return-amount').value = fullDeposit;
    } else if (action === 'forfeit') {
        document.getElementById('deposit-return-amount').value = 0;
    }
}

// End Rental form submission
document.getElementById('form-end-rental').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-end-rental');
    const submitText = document.getElementById('end-rental-submit-text');
    const submitSpinner = document.getElementById('end-rental-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Ending...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        const rental = allRentalsCache.find(r => r.id === data.rental_id);
        
        // Upload return inspection photos
        const photos = {};
        for (const [position, file] of Object.entries(inspectionPhotos.return || {})) {
            if (file) {
                photos[position] = await uploadToStorage('inspection_photos', file, `return_${rental?.rental_id || data.rental_id}`);
            }
        }
        
        // Update rental
        const updateData = {
            rental_status: 'completed',
            end_date: data.end_date,
            end_mileage: parseInt(data.end_mileage),
            return_photos: Object.keys(photos).length > 0 ? photos : null,
            has_damage: data.has_damage === 'on',
            damage_description: data.damage_description || null,
            damage_cost: data.damage_cost ? parseFloat(data.damage_cost) : null,
            deposit_action: data.deposit_action,
            deposit_return_amount: parseFloat(data.deposit_return_amount || 0),
            return_notes: data.return_notes
        };
        
        const { error } = await db.from('rentals').update(updateData).eq('id', data.rental_id);
        if (error) throw error;
        
        // Update vehicle status back to Active and update mileage
        if (rental) {
            await db.from('vehicles').update({ 
                status: 'Active',
                current_mileage: parseInt(data.end_mileage)
            }).eq('id', rental.vehicle_id);
        }
        
        showToast('Rental ended successfully! âœ“', 'success');
        closeModal('end-rental');
        inspectionPhotos.return = {};
        
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
    } catch (error) {
        console.error('Error ending rental:', error);
        showToast(error.message || 'Error ending rental', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'End Rental';
        submitSpinner.classList.add('hidden');
    }
});

// ===========================
// LOG EXPENSE HANDLERS
// ===========================
async function loadExpenseFormData() {
    try {
        const { data: vehicles } = await db.from('vehicles').select('*');
        allVehiclesCache = vehicles || [];
        
        const select = document.getElementById('expense-vehicle-select');
        select.innerHTML = '<option value="">Select vehicle...</option>' +
            (vehicles || []).map(v => `<option value="${v.id}">${v.year} ${v.make} ${v.model} - ${v.license_plate || 'No plate'}</option>`).join('');
        
        document.querySelector('#form-log-expense input[name="expense_date"]').value = new Date().toISOString().split('T')[0];
    } catch (error) {
        console.error('Error loading expense data:', error);
    }
}

function handleExpenseReceipt(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    expenseReceiptFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('expense-receipt-area').classList.add('hidden');
        const preview = document.getElementById('expense-receipt-preview');
        preview.classList.remove('hidden');
        preview.querySelector('img').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function removeExpenseReceipt() {
    expenseReceiptFile = null;
    document.getElementById('expense-receipt-input').value = '';
    document.getElementById('expense-receipt-area').classList.remove('hidden');
    document.getElementById('expense-receipt-preview').classList.add('hidden');
}

// Log Expense form submission
document.getElementById('form-log-expense').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-expense');
    const submitText = document.getElementById('expense-submit-text');
    const submitSpinner = document.getElementById('expense-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Logging...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        data.expense_id = `E-${Date.now()}`;
        data.amount = parseFloat(data.amount);
        
        // Upload receipt if exists
        if (expenseReceiptFile) {
            data.receipt_url = await uploadToStorage('payment-screenshots', expenseReceiptFile, `expense_${data.expense_id}`);
        }
        
        const { error } = await db.from('expenses').insert([data]);
        if (error) throw error;
        
        showToast('Expense logged successfully! ðŸ“', 'success');
        closeModal('log-expense');
        expenseReceiptFile = null;
        
    } catch (error) {
        console.error('Error logging expense:', error);
        showToast(error.message || 'Error logging expense', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Log Expense';
        submitSpinner.classList.add('hidden');
    }
});

// ===========================
// CUSTOMER APPROVAL/REJECTION
// ===========================
async function approveCustomer(customerId) {
    if (!confirm('Approve this customer application?')) return;
    
    try {
        const { error } = await db.from('customers').update({ 
            application_status: 'approved',
            status: 'approved',
            approved_at: new Date().toISOString()
        }).eq('id', customerId);
        
        if (error) throw error;
        
        showToast('Customer approved! âœ“', 'success');
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        if (typeof loadCustomersTab === 'function') {
            await loadCustomersTab();
        }
    } catch (error) {
        console.error('Error approving customer:', error);
        showToast('Error approving customer', 'error');
    }
}

async function rejectCustomer(customerId) {
    const reason = prompt('Reason for rejection (optional):');
    if (reason === null) return;
    
    try {
        // Only update status - notes column doesn't exist in this schema
        const { error } = await db
            .from('customers')
            .update({ status: 'Rejected' })
            .eq('id', customerId);
        
        if (error) throw error;
        
        showToast('Customer rejected successfully.', 'info');
        
        // Refresh the customers tab if visible
        if (typeof loadCustomersTab === 'function') {
            await loadCustomersTab();
        }
        // Also refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error rejecting customer:', error);
        showToast('Error rejecting customer: ' + (error.message || 'Unknown error'), 'error');
    }
}

// Close modals on backdrop click
['start-rental', 'record-payment', 'end-rental', 'log-expense', 'edit-vehicle', 'service-history', 'vehicle-expenses', 'vehicle-stats'].forEach(modalName => {
    const modal = document.getElementById(`modal-${modalName}`);
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modalName);
        });
    }
});

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        ['add-vehicle', 'add-customer', 'start-rental', 'record-payment', 'end-rental', 'log-expense', 'edit-vehicle', 'service-history', 'vehicle-expenses', 'vehicle-stats'].forEach(modalName => {
            const modal = document.getElementById(`modal-${modalName}`);
            if (modal && !modal.classList.contains('hidden')) {
                closeModal(modalName);
            }
        });
    }
});

// ===========================
// EDIT VEHICLE MODAL
// ===========================
let currentEditVehicleId = null;

async function openEditVehicle(vehicleId) {
    currentEditVehicleId = vehicleId;
    
    try {
        // Fetch vehicle data
        const { data: vehicle, error } = await db
            .from('vehicles')
            .select('*')
            .eq('id', vehicleId)
            .single();
        
        if (error) throw error;
        
        // Populate form fields
        document.getElementById('edit-vehicle-id').value = vehicle.id;
        document.getElementById('edit-vehicle-display-id').value = vehicle.vehicle_id;
        document.getElementById('edit-vehicle-image').src = vehicle.image_url || 'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=400&h=250&fit=crop';
        
        // Basic info
        const form = document.getElementById('form-edit-vehicle');
        form.querySelector('[name="friendly_name"]').value = vehicle.friendly_name || '';
        form.querySelector('[name="year"]').value = vehicle.year || '';
        form.querySelector('[name="make"]').value = vehicle.make || '';
        form.querySelector('[name="model"]').value = vehicle.model || '';
        form.querySelector('[name="color"]').value = vehicle.color || '';
        form.querySelector('[name="vin"]').value = vehicle.vin || '';
        form.querySelector('[name="license_plate"]').value = vehicle.license_plate || '';
        form.querySelector('[name="status"]').value = vehicle.status || 'Active';
        
        // Mileage & Service
        form.querySelector('[name="current_mileage"]').value = vehicle.current_mileage || '';
        form.querySelector('[name="last_service_date"]').value = vehicle.last_service_date || '';
        form.querySelector('[name="last_service_mileage"]').value = vehicle.last_service_mileage || '';
        form.querySelector('[name="condition"]').value = vehicle.condition || 'Good';
        
        // Financial
        form.querySelector('[name="monthly_payment"]').value = vehicle.monthly_payment || '';
        form.querySelector('[name="insurance_monthly"]').value = vehicle.insurance_monthly || '';
        form.querySelector('[name="gps_cost_monthly"]').value = vehicle.gps_cost_monthly || '';
        form.querySelector('[name="loan_amount"]').value = vehicle.loan_amount || '';
        
        // GPS & Tracking
        form.querySelector('[name="gps_device_id"]').value = vehicle.gps_device_id || '';
        form.querySelector('[name="toll_tag_id"]').value = vehicle.toll_tag_id || '';
        form.querySelector('[name="gps_active"]').checked = vehicle.gps_active !== false;
        
        openModal('edit-vehicle');
    } catch (error) {
        console.error('Error loading vehicle:', error);
        showToast('Error loading vehicle data', 'error');
    }
}

// Form submission for Edit Vehicle
document.getElementById('form-edit-vehicle').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-edit-vehicle');
    const submitText = document.getElementById('edit-vehicle-submit-text');
    const submitSpinner = document.getElementById('edit-vehicle-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Saving...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        const updateData = {
            friendly_name: data.friendly_name || null,
            year: parseInt(data.year) || null,
            make: data.make || null,
            model: data.model || null,
            color: data.color || null,
            vin: data.vin ? data.vin.toUpperCase() : null,
            license_plate: data.license_plate ? data.license_plate.toUpperCase() : null,
            status: data.status || 'Active',
            current_mileage: parseInt(data.current_mileage) || null,
            last_service_date: data.last_service_date || null,
            last_service_mileage: parseInt(data.last_service_mileage) || null,
            condition: data.condition || null,
            monthly_payment: parseFloat(data.monthly_payment) || null,
            insurance_monthly: parseFloat(data.insurance_monthly) || null,
            gps_cost_monthly: parseFloat(data.gps_cost_monthly) || null,
            loan_amount: parseFloat(data.loan_amount) || null,
            gps_device_id: data.gps_device_id || null,
            toll_tag_id: data.toll_tag_id || null,
            gps_active: data.gps_active === 'on',
            updated_at: new Date().toISOString()
        };
        
        const { error } = await db
            .from('vehicles')
            .update(updateData)
            .eq('id', data.id);
        
        if (error) throw error;
        
        showToast('Vehicle updated successfully! âœ“', 'success');
        closeModal('edit-vehicle');
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error updating vehicle:', error);
        showToast(error.message || 'Error updating vehicle', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Save Changes';
        submitSpinner.classList.add('hidden');
    }
});

// ===========================
// SERVICE HISTORY MODAL
// ===========================
let currentServiceVehicleId = null;
let currentServiceVehicleData = null;

async function openServiceHistory(vehicleId) {
    currentServiceVehicleId = vehicleId;
    
    try {
        // Fetch vehicle info
        const { data: vehicle } = await db
            .from('vehicles')
            .select('*')
            .eq('id', vehicleId)
            .single();
        
        currentServiceVehicleData = vehicle;
        document.getElementById('service-history-vehicle-name').textContent = 
            `${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.vehicle_id})`;
        document.getElementById('add-service-vehicle-id').value = vehicleId;
        
        // Set default date for add service form
        document.querySelector('#form-add-service input[name="actual_date"]').value = new Date().toISOString().split('T')[0];
        document.querySelector('#form-add-service input[name="actual_mileage"]').value = vehicle.current_mileage || '';
        
        openModal('service-history');
        await loadServiceHistory(vehicleId);
    } catch (error) {
        console.error('Error opening service history:', error);
        showToast('Error loading vehicle', 'error');
    }
}

async function loadServiceHistory(vehicleId) {
    const tbody = document.getElementById('service-history-tbody');
    
    try {
        const { data: services, error } = await db
            .from('maintenance_schedule')
            .select('*')
            .eq('vehicle_id', vehicleId)
            .order('actual_date', { ascending: false });
        
        if (error) throw error;
        
        if (!services || services.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-tools text-4xl mb-3 text-gray-300"></i>
                        <p>No service records yet.</p>
                        <p class="text-sm">Click "Add Service Record" to log maintenance.</p>
                    </td>
                </tr>
            `;
            updateServiceSummary([]);
            return;
        }
        
        tbody.innerHTML = services.map(service => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">${formatDate(service.actual_date)}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${getServiceTypeBadge(service.maintenance_type)}">
                        ${service.maintenance_type}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">${(service.actual_mileage || 0).toLocaleString()} mi</td>
                <td class="px-4 py-3 text-sm font-semibold text-green-600">$${(service.cost || 0).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${service.service_provider || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${service.notes || '-'}</td>
                <td class="px-4 py-3 text-sm">
                    <button onclick="deleteServiceRecord('${service.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        updateServiceSummary(services);
    } catch (error) {
        console.error('Error loading service history:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading service history</p>
                </td>
            </tr>
        `;
    }
}

function updateServiceSummary(services) {
    const totalCount = services.length;
    const totalCost = services.reduce((sum, s) => sum + (s.cost || 0), 0);
    const lastDate = services.length > 0 ? formatDate(services[0].actual_date) : '-';
    const avgCost = totalCount > 0 ? (totalCost / totalCount) : 0;
    
    document.getElementById('service-total-count').textContent = totalCount;
    document.getElementById('service-total-cost').textContent = '$' + totalCost.toFixed(2);
    document.getElementById('service-last-date').textContent = lastDate;
    document.getElementById('service-avg-cost').textContent = '$' + avgCost.toFixed(2);
}

function getServiceTypeBadge(type) {
    const badges = {
        'Oil Change': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
        'Tire Rotation': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
        'Brake Service': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
        'State Inspection': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'General Repair': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'
    };
    return badges[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
}

function showAddServiceForm() {
    document.getElementById('add-service-form-container').classList.remove('hidden');
    document.getElementById('btn-show-add-service').classList.add('hidden');
}

function hideAddServiceForm() {
    document.getElementById('add-service-form-container').classList.add('hidden');
    document.getElementById('btn-show-add-service').classList.remove('hidden');
    document.getElementById('form-add-service').reset();
    // Reset default values
    document.querySelector('#form-add-service input[name="actual_date"]').value = new Date().toISOString().split('T')[0];
    if (currentServiceVehicleData) {
        document.querySelector('#form-add-service input[name="actual_mileage"]').value = currentServiceVehicleData.current_mileage || '';
    }
}

// Add Service Record form submission
document.getElementById('form-add-service').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('btn-submit-service');
    const submitText = document.getElementById('add-service-submit-text');
    const submitSpinner = document.getElementById('add-service-submit-spinner');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Adding...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        const serviceRecord = {
            vehicle_id: data.vehicle_id,
            maintenance_type: data.maintenance_type,
            actual_date: data.actual_date,
            actual_mileage: parseInt(data.actual_mileage),
            cost: parseFloat(data.cost),
            service_provider: data.service_provider || null,
            notes: data.notes || null,
            status: 'Completed',
            created_at: new Date().toISOString()
        };
        
        const { error } = await db
            .from('maintenance_schedule')
            .insert([serviceRecord]);
        
        if (error) throw error;
        
        // Update vehicle's last service info
        await db
            .from('vehicles')
            .update({
                last_service_date: data.actual_date,
                last_service_mileage: parseInt(data.actual_mileage),
                current_mileage: Math.max(currentServiceVehicleData?.current_mileage || 0, parseInt(data.actual_mileage)),
                updated_at: new Date().toISOString()
            })
            .eq('id', data.vehicle_id);
        
        showToast('Service record added! âœ“', 'success');
        hideAddServiceForm();
        await loadServiceHistory(currentServiceVehicleId);
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error adding service record:', error);
        showToast(error.message || 'Error adding service record', 'error');
    } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Add Service';
        submitSpinner.classList.add('hidden');
    }
});

async function deleteServiceRecord(serviceId) {
    if (!confirm('Delete this service record?')) return;
    
    try {
        const { error } = await db
            .from('maintenance_schedule')
            .delete()
            .eq('id', serviceId);
        
        if (error) throw error;
        
        showToast('Service record deleted', 'info');
        await loadServiceHistory(currentServiceVehicleId);
    } catch (error) {
        console.error('Error deleting service record:', error);
        showToast('Error deleting record', 'error');
    }
}

// ===========================
// VEHICLE EXPENSES MODAL
// ===========================
let currentExpenseVehicleId = null;
let currentExpenseVehicleData = null;
let allVehicleExpenses = [];

async function openVehicleExpenses(vehicleId) {
    currentExpenseVehicleId = vehicleId;
    
    try {
        // Fetch vehicle info
        const { data: vehicle } = await db
            .from('vehicles')
            .select('*')
            .eq('id', vehicleId)
            .single();
        
        currentExpenseVehicleData = vehicle;
        document.getElementById('vehicle-expenses-name').textContent = 
            `${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.vehicle_id})`;
        
        // Set default date range (last 3 months)
        const today = new Date();
        const threeMonthsAgo = new Date(today);
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        
        document.getElementById('expense-filter-from').value = threeMonthsAgo.toISOString().split('T')[0];
        document.getElementById('expense-filter-to').value = today.toISOString().split('T')[0];
        
        openModal('vehicle-expenses');
        await loadVehicleExpenses(vehicleId);
    } catch (error) {
        console.error('Error opening vehicle expenses:', error);
        showToast('Error loading vehicle', 'error');
    }
}

async function loadVehicleExpenses(vehicleId, fromDate = null, toDate = null) {
    const tbody = document.getElementById('vehicle-expenses-tbody');
    
    try {
        let query = db
            .from('expenses')
            .select('*')
            .eq('vehicle_id', vehicleId)
            .order('expense_date', { ascending: false });
        
        if (fromDate) query = query.gte('expense_date', fromDate);
        if (toDate) query = query.lte('expense_date', toDate);
        
        const { data: expenses, error } = await query;
        
        if (error) throw error;
        
        allVehicleExpenses = expenses || [];
        
        if (!expenses || expenses.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-file-invoice text-4xl mb-3 text-gray-300"></i>
                        <p>No expenses recorded.</p>
                        <p class="text-sm">Click "Add Expense" to log an expense.</p>
                    </td>
                </tr>
            `;
            updateExpenseSummary([]);
            return;
        }
        
        tbody.innerHTML = expenses.map(exp => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">${formatDate(exp.expense_date)}</td>
                <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${getExpenseTypeBadge(exp.expense_type)}">
                        ${formatExpenseType(exp.expense_type)}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-red-600">$${(exp.amount || 0).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${exp.vendor || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${exp.description || '-'}</td>
                <td class="px-4 py-3 text-sm">
                    ${exp.receipt_url ? 
                        `<a href="${exp.receipt_url}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fas fa-file-image"></i></a>` : 
                        '<span class="text-gray-400">-</span>'}
                </td>
                <td class="px-4 py-3 text-sm">
                    <button onclick="deleteExpenseRecord('${exp.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        updateExpenseSummary(expenses);
    } catch (error) {
        console.error('Error loading expenses:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading expenses</p>
                </td>
            </tr>
        `;
    }
}

function updateExpenseSummary(expenses) {
    const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    const maintenance = expenses.filter(e => ['maintenance', 'oil_change', 'tires'].includes(e.expense_type)).reduce((sum, e) => sum + (e.amount || 0), 0);
    const fuel = expenses.filter(e => e.expense_type === 'fuel').reduce((sum, e) => sum + (e.amount || 0), 0);
    const insurance = expenses.filter(e => e.expense_type === 'insurance').reduce((sum, e) => sum + (e.amount || 0), 0);
    const other = total - maintenance - fuel - insurance;
    
    document.getElementById('expense-total').textContent = '$' + total.toFixed(2);
    document.getElementById('expense-maintenance').textContent = '$' + maintenance.toFixed(2);
    document.getElementById('expense-fuel').textContent = '$' + fuel.toFixed(2);
    document.getElementById('expense-insurance').textContent = '$' + insurance.toFixed(2);
    document.getElementById('expense-other').textContent = '$' + other.toFixed(2);
}

function getExpenseTypeBadge(type) {
    const badges = {
        'maintenance': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
        'oil_change': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
        'tires': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
        'insurance': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
        'fuel': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'registration': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
        'towing': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
    };
    return badges[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
}

function formatExpenseType(type) {
    const types = {
        'maintenance': 'Maintenance',
        'oil_change': 'Oil Change',
        'tires': 'Tires',
        'insurance': 'Insurance',
        'registration': 'Registration',
        'car_wash': 'Car Wash',
        'fuel': 'Fuel',
        'towing': 'Towing',
        'other': 'Other'
    };
    return types[type] || type;
}

function filterVehicleExpenses() {
    const from = document.getElementById('expense-filter-from').value;
    const to = document.getElementById('expense-filter-to').value;
    loadVehicleExpenses(currentExpenseVehicleId, from, to);
}

function clearExpenseFilter() {
    document.getElementById('expense-filter-from').value = '';
    document.getElementById('expense-filter-to').value = '';
    loadVehicleExpenses(currentExpenseVehicleId);
}

function openLogExpenseForVehicle() {
    // Pre-select the vehicle in the Log Expense modal
    closeModal('vehicle-expenses');
    openModal('log-expense');
    
    // Wait for the modal to load, then select the vehicle
    setTimeout(async () => {
        const select = document.querySelector('#form-log-expense select[name="vehicle_id"]');
        if (select && currentExpenseVehicleId) {
            select.value = currentExpenseVehicleId;
        }
    }, 100);
}

async function deleteExpenseRecord(expenseId) {
    if (!confirm('Delete this expense record?')) return;
    
    try {
        const { error } = await db
            .from('expenses')
            .delete()
            .eq('id', expenseId);
        
        if (error) throw error;
        
        showToast('Expense deleted', 'info');
        await loadVehicleExpenses(currentExpenseVehicleId);
    } catch (error) {
        console.error('Error deleting expense:', error);
        showToast('Error deleting expense', 'error');
    }
}

// ===========================
// VEHICLE STATS MODAL
// ===========================
let currentStatsVehicleId = null;

async function openVehicleStats(vehicleId) {
    currentStatsVehicleId = vehicleId;
    
    try {
        // Fetch all data
        const [vehicleResult, rentalsResult, expensesResult, paymentsResult, servicesResult] = await Promise.all([
            db.from('vehicles').select('*').eq('id', vehicleId).single(),
            db.from('rentals').select('*').eq('vehicle_id', vehicleId),
            db.from('expenses').select('*').eq('vehicle_id', vehicleId),
            db.from('payments').select('*, rentals!inner(vehicle_id)').eq('rentals.vehicle_id', vehicleId),
            db.from('maintenance_schedule').select('*').eq('vehicle_id', vehicleId)
        ]);
        
        const vehicle = vehicleResult.data;
        const rentals = rentalsResult.data || [];
        const expenses = expensesResult.data || [];
        const payments = paymentsResult.data || [];
        const services = servicesResult.data || [];
        
        // Populate vehicle header
        document.getElementById('vehicle-stats-name').textContent = `${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.vehicle_id})`;
        document.getElementById('stats-vehicle-image').src = vehicle.image_url || 'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=400&h=250&fit=crop';
        document.getElementById('stats-vehicle-title').textContent = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
        document.getElementById('stats-vehicle-subtitle').textContent = `${vehicle.vehicle_id} â€¢ ${vehicle.color || 'N/A'} â€¢ ${vehicle.license_plate || 'No Plate'}`;
        
        // Status badge
        const statusEl = document.getElementById('stats-vehicle-status');
        const statusColors = {
            'Active': 'bg-green-500 text-white',
            'Maintenance': 'bg-orange-500 text-white',
            'Retired': 'bg-gray-500 text-white'
        };
        statusEl.className = `inline-block px-3 py-1 rounded-full text-sm font-semibold ${statusColors[vehicle.status] || 'bg-gray-500 text-white'}`;
        statusEl.textContent = vehicle.status || 'Unknown';
        
        document.getElementById('stats-current-mileage').textContent = (vehicle.current_mileage || 0).toLocaleString() + ' mi';
        document.getElementById('stats-condition').textContent = vehicle.condition || '-';
        
        // Calculate key metrics
        const totalRevenue = payments.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
        const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const maintenanceCost = services.reduce((sum, s) => sum + (s.cost || 0), 0);
        const netProfit = totalRevenue - totalExpenses - maintenanceCost;
        const purchasePrice = vehicle.purchase_price || 0;
        const roi = purchasePrice > 0 ? ((netProfit / purchasePrice) * 100) : 0;
        
        document.getElementById('stats-total-revenue').textContent = '$' + totalRevenue.toLocaleString();
        document.getElementById('stats-total-expenses').textContent = '$' + (totalExpenses + maintenanceCost).toLocaleString();
        document.getElementById('stats-net-profit').textContent = '$' + netProfit.toLocaleString();
        document.getElementById('stats-roi').textContent = roi.toFixed(1) + '%';
        
        // Rental stats
        const totalRentals = rentals.length;
        const completedRentals = rentals.filter(r => r.rental_status === 'completed');
        let totalDays = 0;
        completedRentals.forEach(r => {
            if (r.start_date && r.end_date) {
                const start = new Date(r.start_date);
                const end = new Date(r.end_date);
                totalDays += Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            }
        });
        
        const purchaseDate = vehicle.purchase_date ? new Date(vehicle.purchase_date) : new Date(vehicle.created_at);
        const daysSincePurchase = Math.ceil((new Date() - purchaseDate) / (1000 * 60 * 60 * 24));
        const utilization = daysSincePurchase > 0 ? ((totalDays / daysSincePurchase) * 100) : 0;
        const avgDuration = totalRentals > 0 ? Math.round(totalDays / totalRentals) : 0;
        
        // Miles driven calculation
        const startMileage = vehicle.last_service_mileage || vehicle.current_mileage || 0;
        const milesDriven = (vehicle.current_mileage || 0) - (vehicle.purchase_mileage || startMileage);
        
        document.getElementById('stats-total-rentals').textContent = totalRentals;
        document.getElementById('stats-days-rented').textContent = totalDays + ' days';
        document.getElementById('stats-utilization').textContent = utilization.toFixed(1) + '%';
        document.getElementById('stats-avg-duration').textContent = avgDuration + ' days';
        document.getElementById('stats-miles-driven').textContent = Math.max(0, milesDriven).toLocaleString() + ' mi';
        
        // Cost breakdown
        const monthsSincePurchase = Math.max(1, daysSincePurchase / 30);
        const loanTotal = (vehicle.monthly_payment || 0) * monthsSincePurchase;
        const insuranceTotal = (vehicle.insurance_monthly || 0) * monthsSincePurchase;
        const monthlyOperatingCost = (vehicle.monthly_payment || 0) + (vehicle.insurance_monthly || 0) + (vehicle.gps_cost_monthly || 0);
        
        document.getElementById('stats-purchase-price').textContent = '$' + (vehicle.purchase_price || 0).toLocaleString();
        document.getElementById('stats-loan-total').textContent = '$' + loanTotal.toFixed(0);
        document.getElementById('stats-insurance-total').textContent = '$' + insuranceTotal.toFixed(0);
        document.getElementById('stats-maintenance-total').textContent = '$' + maintenanceCost.toFixed(0);
        document.getElementById('stats-monthly-cost').textContent = '$' + monthlyOperatingCost.toFixed(0);
        
        // Recent activity timeline
        const activities = [];
        
        // Add recent rentals
        rentals.slice(0, 3).forEach(r => {
            activities.push({
                date: r.start_date,
                icon: 'fa-car',
                color: 'bg-green-500',
                text: `Rental started - ${r.rental_status}`
            });
        });
        
        // Add recent expenses
        expenses.slice(0, 3).forEach(e => {
            activities.push({
                date: e.expense_date,
                icon: 'fa-dollar-sign',
                color: 'bg-red-500',
                text: `${formatExpenseType(e.expense_type)} - $${(e.amount || 0).toFixed(2)}`
            });
        });
        
        // Add recent services
        services.filter(s => s.actual_date).slice(0, 3).forEach(s => {
            activities.push({
                date: s.actual_date,
                icon: 'fa-wrench',
                color: 'bg-orange-500',
                text: `${s.maintenance_type} - $${(s.cost || 0).toFixed(2)}`
            });
        });
        
        // Sort by date and take top 5
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recentActivities = activities.slice(0, 5);
        
        const activityContainer = document.getElementById('stats-recent-activity');
        if (recentActivities.length === 0) {
            activityContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No recent activity</p>';
        } else {
            activityContainer.innerHTML = recentActivities.map(a => `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 ${a.color} rounded-full flex items-center justify-center">
                        <i class="fas ${a.icon} text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800 dark:text-white">${a.text}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(a.date)}</p>
                    </div>
                </div>
            `).join('');
        }
        
        openModal('vehicle-stats');
    } catch (error) {
        console.error('Error loading vehicle stats:', error);
        showToast('Error loading vehicle statistics', 'error');
    }
}

function exportVehicleStats() {
    showToast('Export feature coming soon!', 'info');
}

// Helper function for date formatting
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Mark vehicle maintenance as complete
async function markMaintenanceComplete(vehicleId) {
    if (!confirm('Mark this vehicle as maintenance complete and return to Active status?')) return;
    
    try {
        const { error } = await db
            .from('vehicles')
            .update({ 
                status: 'Active',
                last_service_date: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString()
            })
            .eq('id', vehicleId);
        
        if (error) throw error;
        
        showToast('Vehicle returned to Active status! âœ“', 'success');
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
    } catch (error) {
        console.error('Error updating vehicle status:', error);
        showToast('Error updating vehicle status', 'error');
    }
}


// ===========================
// REVIEW APPLICATION MODAL
// ===========================
async function reviewCustomer(customerId) {
    // Show modal
    document.getElementById("modal-review-application").classList.remove("hidden");
    document.body.style.overflow = "hidden";
    
    const content = document.getElementById("review-modal-content");
    content.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-3xl text-fleetzy-green"></i></div>';
    
    try {
        const { data: customer, error } = await db.from("customers").select("*").eq("id", customerId).single();
        if (error) throw error;
        
        const selfieHtml = customer.selfie_url 
            ? '<img src="' + customer.selfie_url + '" class="w-48 h-48 object-cover rounded-lg border-2 border-gray-200 dark:border-gray-600 cursor-pointer" onclick="window.open(this.src, \'_blank\')">'
            : '<div class="w-48 h-48 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400"><i class="fas fa-user text-4xl"></i></div>';
        
        const dlFrontHtml = customer.dl_photo_front_url
            ? '<img src="' + customer.dl_photo_front_url + '" class="w-full max-w-sm rounded-lg border-2 border-gray-200 dark:border-gray-600 cursor-pointer" onclick="window.open(this.src, \'_blank\')">'
            : '<div class="w-full max-w-sm h-32 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400">No image</div>';
        
        const dlBackHtml = customer.dl_photo_back_url
            ? '<img src="' + customer.dl_photo_back_url + '" class="w-full max-w-sm rounded-lg border-2 border-gray-200 dark:border-gray-600 cursor-pointer" onclick="window.open(this.src, \'_blank\')">'
            : '<div class="w-full max-w-sm h-32 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400">No image</div>';
        
        const incomeHtml = customer.weekly_earnings_proof_url
            ? '<img src="' + customer.weekly_earnings_proof_url + '" class="w-full max-w-sm rounded-lg border-2 border-gray-200 dark:border-gray-600 cursor-pointer" onclick="window.open(this.src, \'_blank\')">'
            : '<div class="w-full max-w-sm h-32 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400">No image</div>';
        
        const statusClass = customer.status === "approved" ? "bg-green-100 text-green-800" : customer.status === "rejected" ? "bg-red-100 text-red-800" : "bg-yellow-100 text-yellow-800";
        
        content.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Photos -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-lg border-b pb-2 dark:border-gray-700">Photos & Documents</h3>
                    
                    <div>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-camera mr-1"></i>Selfie</p>
                        ${selfieHtml}
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-id-card mr-1"></i>License Front</p>
                        ${dlFrontHtml}
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-id-card mr-1"></i>License Back</p>
                        ${dlBackHtml}
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-file-invoice-dollar mr-1"></i>Income Proof</p>
                        ${incomeHtml}
                    </div>
                </div>
                
                <!-- Right Column: Details -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-lg border-b pb-2 dark:border-gray-700">Application Details</h3>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-2">
                        <h4 class="font-medium text-fleetzy-green"><i class="fas fa-user mr-2"></i>Personal Information</h4>
                        <p><strong>Name:</strong> ${customer.full_name || "N/A"}</p>
                        <p><strong>Email:</strong> ${customer.email || "N/A"}</p>
                        <p><strong>Phone:</strong> ${customer.phone || "N/A"}</p>
                        <p><strong>DOB:</strong> ${customer.date_of_birth || "N/A"}</p>
                        <p><strong>Address:</strong> ${customer.address || customer.current_address || "N/A"}</p>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-2">
                        <h4 class="font-medium text-fleetzy-green"><i class="fas fa-id-card mr-2"></i>License Information</h4>
                        <p><strong>DL Number:</strong> ${customer.dl_number || "N/A"}</p>
                        <p><strong>State:</strong> ${customer.dl_state || "N/A"}</p>
                        <p><strong>Expiry:</strong> ${customer.dl_expiry_date || "N/A"}</p>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-2">
                        <h4 class="font-medium text-fleetzy-green"><i class="fas fa-briefcase mr-2"></i>Employment</h4>
                        <p><strong>Platform:</strong> ${customer.gig_platform || "N/A"}</p>
                        <p><strong>Type:</strong> ${customer.is_company_rental ? "Corporate Rental" : "Individual"}</p>
                        ${customer.is_company_rental ? '<p><strong>Company:</strong> ' + (customer.company_name || "N/A") + '</p>' : ""}
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-2">
                        <h4 class="font-medium text-fleetzy-green"><i class="fas fa-clock mr-2"></i>Application Status</h4>
                        <p><strong>Status:</strong> <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${customer.status || "pending"}</span></p>
                        <p><strong>Applied:</strong> ${new Date(customer.created_at).toLocaleString()}</p>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4 mt-6 pt-6 border-t dark:border-gray-700">
                <button onclick="rejectCustomer('${customer.id}'); closeReviewModal();" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-times mr-2"></i>Reject
                </button>
                <button onclick="approveCustomer('${customer.id}'); closeReviewModal();" class="px-6 py-3 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-check mr-2"></i>Approve
                </button>
            </div>
        `;
    } catch (error) {
        console.error("Error loading customer:", error);
        content.innerHTML = '<div class="text-center py-12 text-red-500"><i class="fas fa-exclamation-circle text-3xl mb-2"></i><p>Error loading application</p></div>';
    }
}

function closeReviewModal() {
    document.getElementById("modal-review-application").classList.add("hidden");
    document.body.style.overflow = "";
}

// Close review modal on backdrop click
document.getElementById("modal-review-application")?.addEventListener("click", (e) => {
    if (e.target.id === "modal-review-application") closeReviewModal();
});

// =============================================
// DOCUMENT MANAGEMENT FUNCTIONS
// =============================================

let currentDocCustomer = null;
const docUrls = {};

// Storage bucket mappings
const DOC_BUCKETS = {
    selfie: 'selfies',
    dl_front: 'drivers-licenses',
    dl_back: 'drivers-licenses',
    income: 'income-proofs',
    insurance: 'drivers-licenses',  // Store insurance in DL bucket or create dedicated bucket
    contract: 'contracts'
};

// Database column mappings
const DOC_COLUMNS = {
    selfie: 'selfie_url',
    dl_front: 'dl_photo_front_url',
    dl_back: 'dl_photo_back_url',
    income: 'weekly_earnings_proof_url',
    insurance: 'insurance_card_url',
    contract: 'contract_url'  // This is on rentals table, not customers
};

// Open Document Management Modal
async function openDocumentsModal(customerId) {
    currentDocCustomer = null;
    Object.keys(docUrls).forEach(key => delete docUrls[key]);
    
    // Reset all previews
    ['selfie', 'dl_front', 'dl_back', 'income', 'insurance'].forEach(docType => {
        const preview = document.getElementById(`${docType}-preview`);
        const placeholder = document.getElementById(`${docType}-placeholder`);
        const viewBtn = document.getElementById(`${docType}-view-btn`);
        const uploadBox = document.getElementById(`${docType.replace('_', '-')}-upload-box`);
        
        if (preview) { preview.classList.add('hidden'); preview.src = ''; }
        if (placeholder) placeholder.classList.remove('hidden');
        if (viewBtn) viewBtn.classList.add('hidden');
        if (uploadBox) uploadBox.classList.remove('has-file');
    });
    
    // Reset contract section
    document.getElementById('contract-placeholder-text')?.classList.remove('hidden');
    document.getElementById('contract-view-section')?.classList.add('hidden');
    
    document.getElementById('modal-manage-documents').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    try {
        // Fetch customer data
        const { data: customer, error } = await db
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
        
        if (error) throw error;
        currentDocCustomer = customer;
        
        // Update header
        const name = customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Customer';
        document.getElementById('doc-customer-id').value = customer.id;
        document.getElementById('doc-customer-name').textContent = name;
        document.getElementById('doc-customer-phone').textContent = customer.phone || '-';
        document.getElementById('doc-customer-email').textContent = customer.email || '-';
        
        // Update photo
        const photoEl = document.getElementById('doc-customer-photo');
        if (customer.selfie_url) {
            photoEl.innerHTML = `<img src="${customer.selfie_url}" class="w-16 h-16 rounded-full object-cover">`;
        } else {
            photoEl.innerHTML = name.charAt(0).toUpperCase();
        }
        
        // Load existing documents
        loadExistingDocuments(customer);
        
        // Check for active rental contract
        await loadCustomerContract(customerId);
        
    } catch (error) {
        console.error('Error loading customer for documents:', error);
        showToast('Error loading customer', 'error');
    }
}

// Load existing documents into previews
function loadExistingDocuments(customer) {
    const docMappings = [
        { key: 'selfie', url: customer.selfie_url },
        { key: 'dl_front', url: customer.dl_photo_front_url },
        { key: 'dl_back', url: customer.dl_photo_back_url },
        { key: 'income', url: customer.weekly_earnings_proof_url },
        { key: 'insurance', url: customer.insurance_card_url }
    ];
    
    docMappings.forEach(({ key, url }) => {
        if (url) {
            docUrls[key] = url;
            showDocPreview(key, url);
        }
    });
}

// Load customer's current rental contract
async function loadCustomerContract(customerId) {
    try {
        const { data: rental, error } = await db
            .from('rentals')
            .select('contract_url, contract_signed_date, start_date')
            .eq('customer_id', customerId)
            .in('rental_status', ['active', 'pending'])
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
        
        if (rental && rental.contract_url) {
            docUrls.contract = rental.contract_url;
            document.getElementById('contract-placeholder-text').classList.add('hidden');
            document.getElementById('contract-view-section').classList.remove('hidden');
            document.getElementById('contract-date').textContent = `Signed: ${formatDate(rental.contract_signed_date || rental.start_date)}`;
        }
    } catch (e) {
        // No active rental - that's okay
    }
}

// Show document preview
function showDocPreview(docType, url) {
    const preview = document.getElementById(`${docType}-preview`);
    const placeholder = document.getElementById(`${docType}-placeholder`);
    const viewBtn = document.getElementById(`${docType}-view-btn`);
    const uploadBox = document.getElementById(`${docType.replace('_', '-')}-upload-box`);
    
    if (preview) {
        preview.src = url;
        preview.classList.remove('hidden');
    }
    if (placeholder) placeholder.classList.add('hidden');
    if (viewBtn) viewBtn.classList.remove('hidden');
    if (uploadBox) uploadBox.classList.add('has-file');
}

// Handle document upload
async function handleDocUpload(event, docType) {
    const file = event.target.files[0];
    if (!file || !currentDocCustomer) return;
    
    const customerId = currentDocCustomer.id;
    const bucket = DOC_BUCKETS[docType];
    const column = DOC_COLUMNS[docType];
    
    // Show progress
    document.getElementById('doc-upload-progress').classList.remove('hidden');
    document.getElementById('doc-upload-status').textContent = `Uploading ${docType.replace('_', ' ')}...`;
    document.getElementById('doc-upload-bar').style.width = '30%';
    
    try {
        // Generate unique filename
        const timestamp = Date.now();
        const fileExt = file.name.split('.').pop();
        const fileName = `${customerId}/${docType}_${timestamp}.${fileExt}`;
        
        // Upload to Supabase Storage
        document.getElementById('doc-upload-bar').style.width = '60%';
        const { data: uploadData, error: uploadError } = await db.storage
            .from(bucket)
            .upload(fileName, file, { 
                cacheControl: '3600',
                upsert: true 
            });
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = db.storage.from(bucket).getPublicUrl(fileName);
        const publicUrl = urlData.publicUrl;
        
        document.getElementById('doc-upload-bar').style.width = '80%';
        
        // Update customer record in database
        const updateData = {};
        updateData[column] = publicUrl;
        
        const { error: updateError } = await db
            .from('customers')
            .update(updateData)
            .eq('id', customerId);
        
        if (updateError) throw updateError;
        
        // Update local state and UI
        docUrls[docType] = publicUrl;
        currentDocCustomer[column] = publicUrl;
        showDocPreview(docType, publicUrl);
        
        document.getElementById('doc-upload-bar').style.width = '100%';
        showToast(`${docType.replace('_', ' ')} uploaded successfully!`, 'success');
        
        // Refresh customers table if visible
        if (typeof loadCustomersTab === 'function') {
            loadCustomersTab();
        }
        
    } catch (error) {
        console.error('Document upload error:', error);
        showToast(`Upload failed: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            document.getElementById('doc-upload-progress').classList.add('hidden');
            document.getElementById('doc-upload-bar').style.width = '0%';
        }, 1000);
    }
}

// View document in new tab
function viewDocument(docType) {
    const url = docUrls[docType];
    if (url) {
        window.open(url, '_blank');
    } else {
        showToast('Document not available', 'error');
    }
}

// Close documents modal
function closeDocumentsModal() {
    document.getElementById('modal-manage-documents').classList.add('hidden');
    document.body.style.overflow = '';
    currentDocCustomer = null;
}

// Close on backdrop click
document.getElementById('modal-manage-documents')?.addEventListener('click', (e) => {
    if (e.target.id === 'modal-manage-documents') closeDocumentsModal();
});

// =============================================
// CONTRACT UPLOAD FOR RENTALS
// =============================================

// Upload contract when starting a rental
async function uploadContractForRental(rentalId, customerId, file) {
    if (!file) return null;
    
    try {
        const timestamp = Date.now();
        const fileExt = file.name.split('.').pop();
        const fileName = `${customerId}/${rentalId}_contract_${timestamp}.${fileExt}`;
        
        // Upload to contracts bucket
        const { data: uploadData, error: uploadError } = await db.storage
            .from('contracts')
            .upload(fileName, file, { 
                cacheControl: '3600',
                upsert: true 
            });
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: urlData } = db.storage.from('contracts').getPublicUrl(fileName);
        const contractUrl = urlData.publicUrl;
        
        // Update rental record
        const { error: updateError } = await db
            .from('rentals')
            .update({ 
                contract_url: contractUrl,
                contract_signed_date: new Date().toISOString().split('T')[0]
            })
            .eq('id', rentalId);
        
        if (updateError) throw updateError;
        
        return contractUrl;
        
    } catch (error) {
        console.error('Contract upload error:', error);
        throw error;
    }
}

// Handle contract file preview in Start Rental modal
function handleRentalContractPreview(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const placeholder = document.getElementById('rental-contract-placeholder');
    const preview = document.getElementById('rental-contract-preview');
    const filename = document.getElementById('rental-contract-filename');
    const uploadBox = document.getElementById('rental-contract-upload-box');
    
    if (placeholder) placeholder.classList.add('hidden');
    if (preview) preview.classList.remove('hidden');
    if (filename) filename.textContent = file.name;
    if (uploadBox) uploadBox.classList.add('has-file');
}

// Clear contract file from Start Rental modal
function clearRentalContract() {
    const input = document.getElementById('rental-contract-file');
    const placeholder = document.getElementById('rental-contract-placeholder');
    const preview = document.getElementById('rental-contract-preview');
    const uploadBox = document.getElementById('rental-contract-upload-box');
    
    if (input) input.value = '';
    if (placeholder) placeholder.classList.remove('hidden');
    if (preview) preview.classList.add('hidden');
    if (uploadBox) uploadBox.classList.remove('has-file');
}


</script>

<!-- Document Management Modal -->
<div id="modal-manage-documents" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-folder-open text-fleetzy-green mr-2"></i>Manage Documents
            </h2>
            <button onclick="closeDocumentsModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <!-- Customer Info Header -->
            <div id="doc-customer-header" class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-6 flex items-center gap-4">
                <div id="doc-customer-photo" class="w-16 h-16 rounded-full bg-fleetzy-green flex items-center justify-center text-white text-2xl font-bold">?</div>
                <div>
                    <h3 id="doc-customer-name" class="text-lg font-semibold">Loading...</h3>
                    <p id="doc-customer-phone" class="text-sm text-gray-500">-</p>
                    <p id="doc-customer-email" class="text-sm text-gray-500">-</p>
                </div>
                <input type="hidden" id="doc-customer-id">
            </div>
            
            <!-- Upload Progress -->
            <div id="doc-upload-progress" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    <span id="doc-upload-status" class="text-blue-700 dark:text-blue-300">Uploading...</span>
                </div>
                <div class="mt-2 w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2">
                    <div id="doc-upload-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Document Sections -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Identity Documents -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                        <i class="fas fa-id-card text-fleetzy-green mr-2"></i>Identity Documents
                    </h3>
                    <div class="space-y-4">
                        <!-- Selfie -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Customer Selfie</label>
                            <div class="doc-upload-box" onclick="document.getElementById('doc-selfie').click()" id="selfie-upload-box">
                                <input type="file" id="doc-selfie" accept="image/*" class="hidden" onchange="handleDocUpload(event, 'selfie')">
                                <div id="selfie-placeholder" class="text-center">
                                    <i class="fas fa-user-circle text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload selfie</p>
                                </div>
                                <img id="selfie-preview" class="doc-preview hidden w-full">
                            </div>
                            <button onclick="viewDocument('selfie')" id="selfie-view-btn" class="hidden mt-2 text-sm text-fleetzy-green hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                            </button>
                        </div>
                        
                        <!-- DL Front -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Driver's License (Front)</label>
                            <div class="doc-upload-box" onclick="document.getElementById('doc-dl-front').click()" id="dl-front-upload-box">
                                <input type="file" id="doc-dl-front" accept="image/*" class="hidden" onchange="handleDocUpload(event, 'dl_front')">
                                <div id="dl_front-placeholder" class="text-center">
                                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload front</p>
                                </div>
                                <img id="dl_front-preview" class="doc-preview hidden w-full">
                            </div>
                            <button onclick="viewDocument('dl_front')" id="dl_front-view-btn" class="hidden mt-2 text-sm text-fleetzy-green hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                            </button>
                        </div>
                        
                        <!-- DL Back -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Driver's License (Back)</label>
                            <div class="doc-upload-box" onclick="document.getElementById('doc-dl-back').click()" id="dl-back-upload-box">
                                <input type="file" id="doc-dl-back" accept="image/*" class="hidden" onchange="handleDocUpload(event, 'dl_back')">
                                <div id="dl_back-placeholder" class="text-center">
                                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload back</p>
                                </div>
                                <img id="dl_back-preview" class="doc-preview hidden w-full">
                            </div>
                            <button onclick="viewDocument('dl_back')" id="dl_back-view-btn" class="hidden mt-2 text-sm text-fleetzy-green hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Financial & Other Documents -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 pb-2 border-b dark:border-gray-700">
                        <i class="fas fa-file-alt text-fleetzy-green mr-2"></i>Other Documents
                    </h3>
                    <div class="space-y-4">
                        <!-- Income Proof -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Income/Earnings Proof</label>
                            <div class="doc-upload-box" onclick="document.getElementById('doc-income').click()" id="income-upload-box">
                                <input type="file" id="doc-income" accept="image/*,.pdf" class="hidden" onchange="handleDocUpload(event, 'income')">
                                <div id="income-placeholder" class="text-center">
                                    <i class="fas fa-receipt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload earnings screenshot</p>
                                </div>
                                <img id="income-preview" class="doc-preview hidden w-full">
                            </div>
                            <button onclick="viewDocument('income')" id="income-view-btn" class="hidden mt-2 text-sm text-fleetzy-green hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                            </button>
                        </div>
                        
                        <!-- Insurance Card -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Insurance Card</label>
                            <div class="doc-upload-box" onclick="document.getElementById('doc-insurance').click()" id="insurance-upload-box">
                                <input type="file" id="doc-insurance" accept="image/*,.pdf" class="hidden" onchange="handleDocUpload(event, 'insurance')">
                                <div id="insurance-placeholder" class="text-center">
                                    <i class="fas fa-shield-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Click to upload insurance card</p>
                                </div>
                                <img id="insurance-preview" class="doc-preview hidden w-full">
                            </div>
                            <button onclick="viewDocument('insurance')" id="insurance-view-btn" class="hidden mt-2 text-sm text-fleetzy-green hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                            </button>
                        </div>
                        
                        <!-- Contract (Read Only) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Signed Contract</label>
                            <div id="contract-display" class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                                <div id="contract-placeholder-text" class="text-center text-gray-500">
                                    <i class="fas fa-file-signature text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm">No contract on file</p>
                                    <p class="text-xs mt-1">Upload contract when starting a rental</p>
                                </div>
                                <div id="contract-view-section" class="hidden">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-file-pdf text-4xl text-red-500"></i>
                                        <div class="flex-1">
                                            <p class="font-medium">Rental Contract</p>
                                            <p id="contract-date" class="text-sm text-gray-500">Signed: -</p>
                                        </div>
                                        <button onclick="viewDocument('contract')" class="px-3 py-2 bg-fleetzy-green text-white rounded-lg hover:bg-green-700 text-sm">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Info Note -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                    <div class="text-sm text-blue-700 dark:text-blue-300">
                        <p class="font-medium">Document Storage</p>
                        <p>Documents are securely stored and will be visible to the customer in their portal. Contracts are uploaded when starting a rental.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
            <button onclick="closeDocumentsModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <i class="fas fa-check mr-2"></i>Done
            </button>
        </div>
    </div>
</div>

<!-- Review Application Modal -->
<div id="modal-review-application" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800 z-10">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-user-check text-fleetzy-green mr-2"></i>Review Application
            </h2>
            <button onclick="closeReviewModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="review-modal-content" class="p-6">
            <div class="flex items-center justify-center py-12">
                <i class="fas fa-spinner fa-spin text-3xl text-fleetzy-green"></i>
            </div>
        </div>
    </div>
</div>
</body>
</html>
